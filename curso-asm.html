<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="Docutils 0.13.1: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/* Minimal style sheet for the HTML output of Docutils.                    */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: minimal.css 7952 2016-07-26 18:15:59Z milde $               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */

/* This CSS2.1_ stylesheet defines rules for Docutils elements without    */
/* HTML equivalent. It is required to make the document semantic visible. */
/*                                                                        */
/* .. _CSS2.1: http://www.w3.org/TR/CSS2                                  */
/* .. _validates: http://jigsaw.w3.org/css-validator/validator$link       */

/* alignment of text and inline objects inside block objects*/
.align-left   { text-align: left; }
.align-right  { text-align: right; }
.align-center { clear: both; text-align: center; }
.align-top    { vertical-align: top; }
.align-middle { vertical-align: middle; }
.align-bottom { vertical-align: bottom; }

/* titles */
h1.title, p.subtitle {
  text-align: center;
}
p.admonition-title,
p.topic-title,
p.sidebar-title,
p.rubric,
p.system-message-title {
  font-weight: bold;
}
h1 + p.subtitle,
h1 + p.section-subtitle {
  font-size: 1.6em;
}
h2 + p.section-subtitle { font-size: 1.28em; }
p.subtitle,
p.section-subtitle,
p.sidebar-subtitle {
  font-weight: bold;
  margin-top: -0.5em;
}
p.sidebar-title,
p.rubric {
  font-size: larger;
}
p.rubric { color: maroon; }
a.toc-backref {
  color: black;
  text-decoration: none; }

/* Warnings, Errors */
div.caution p.admonition-title,
div.attention p.admonition-title,
div.danger p.admonition-title,
div.error p.admonition-title,
div.warning p.admonition-title,
div.system-messages h1,
div.error,
span.problematic,
p.system-message-title {
  color: red;
}

/* inline literals */
span.docutils.literal {
  font-family: monospace;
  white-space: pre-wrap;
}
/* do not wraph at hyphens and similar: */
.literal > span.pre { white-space: nowrap; }

/* Lists */

/* compact and simple lists: no margin between items */
.simple  li, .compact li,
.simple  ul, .compact ul,
.simple  ol, .compact ol,
.simple > li p, .compact > li p,
dl.simple > dd, dl.compact > dd {
  margin-top: 0;
  margin-bottom: 0;
}

/* Table of Contents */
div.topic.contents { margin: 0; }
ul.auto-toc {
  list-style-type: none;
  padding-left: 1.5em; }

/* Enumerated Lists */
ol.arabic     { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }

dt span.classifier { font-style: italic }
dt span.classifier:before {
  font-style: normal;
  margin: 0.5em;
  content: ":";
}

/* Field Lists and drivatives */
/* bold field name, content starts on the same line */
dl.field-list > dt,
dl.option-list > dt,
dl.docinfo > dt,
dl.footnote > dt,
dl.citation > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}
/* Offset for field content (corresponds to the --field-name-limit option) */
dl.field-list > dd,
dl.option-list > dd,
dl.docinfo > dd {
  margin-left:  9em; /* ca. 14 chars in the test examples */
}
/* start field-body on a new line after long field names */
dl.field-list > dd > *:first-child,
dl.option-list > dd > *:first-child
{
  display: inline-block;
  width: 100%;
  margin: 0;
}
/* field names followed by a colon */
dl.field-list > dt:after,
dl.docinfo > dt:after {
  content: ":";
}

/* Bibliographic Fields (docinfo) */
pre.address { font: inherit; }
dd.authors > p { margin: 0; }

/* Option Lists */
dl.option-list { margin-left: 40px; }
dl.option-list > dt { font-weight: normal; }
span.option { white-space: nowrap; }

/* Footnotes and Citations  */
dl.footnote.superscript > dd {margin-left: 1em; }
dl.footnote.brackets > dd {margin-left: 2em; }
dl > dt.label { font-weight: normal; }
a.footnote-reference.brackets:before,
dt.label > span.brackets:before { content: "["; }
a.footnote-reference.brackets:after,
dt.label > span.brackets:after { content: "]"; }
a.footnote-reference.superscript,
dl.footnote.superscript > dt.label {
  vertical-align: super;
  font-size: smaller;
}
dt.label > span.fn-backref { margin-left: 0.2em; }
dt.label > span.fn-backref > a { font-style: italic; }

/* Line Blocks */
div.line-block { display: block; }
div.line-block div.line-block {
  margin-top: 0;
  margin-bottom: 0;
  margin-left: 40px;
}

/* Figures, Images, and Tables */
.figure.align-left,
img.align-left,
object.align-left,
table.align-left {
  margin-right: auto;
}
.figure.align-center,
img.align-center,
object.align-center {
  margin-left: auto;
  margin-right: auto;
  display: block;
}
table.align-center {
  margin-left: auto;
  margin-right: auto;
}
.figure.align-right,
img.align-right,
object.align-right,
table.align-right {
  margin-left: auto;
}
/* reset inner alignment in figures and tables */
div.align-left, div.align-center, div.align-right,
table.align-left, table.align-center, table.align-right
{ text-align: inherit }

/* Admonitions and System Messages */
div.admonition,
div.system-message,
div.sidebar{
  margin: 40px;
  border: medium outset;
  padding-right: 1em;
  padding-left: 1em;
}

/* Sidebar */
div.sidebar {
  width: 30%;
  max-width: 26em;
  float: right;
  clear: right;
}

/* Text Blocks */
div.topic,
pre.literal-block,
pre.doctest-block,
pre.math,
pre.code {
  margin-right: 40px;
  margin-left: 40px;
}
pre.code .ln { color: gray; } /* line numbers */

/* Tables */
table { border-collapse: collapse; }
td, th {
  border-style: solid;
  border-color: silver;
  padding: 0 1ex;
  border-width: thin;
}
td > p:first-child, th > p:first-child { margin-top: 0; }
td > p, th > p { margin-bottom: 0; }

table > caption {
  text-align: left;
  margin-bottom: 0.25em
}

table.borderless td, table.borderless th {
  border: 0;
  padding: 0;
  padding-right: 0.5em /* separate table cells */
}

</style>
<style type="text/css">

/* CSS31_ style sheet for the output of Docutils HTML writers.             */
/* Rules for easy reading and pre-defined style variants.		   */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: plain.css 7952 2016-07-26 18:15:59Z milde $               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*    	     	      	     	 					   */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */
/* .. _CSS3: http://www.w3.org/TR/CSS3		        		   */


/* Document Structure */
/* ****************** */

/* "page layout" */
body {
  padding: 0 5%;
  margin: 8px 0;
}
div.document {
  line-height:1.3;
  counter-reset: table;
  /* counter-reset: figure; */
  /* avoid long lines --> better reading */
  /* OTOH: lines should not be too short because of missing hyphenation, */
  max-width: 50em;
  margin: auto;
}

/* Sections */

/* Transitions */

hr.docutils {
  width: 80%;
  margin-top: 1em;
  margin-bottom: 1em;
  clear: both;
}

/* Paragraphs               */
/* ==========               */

/* vertical space (parskip) */
p, ol, ul, dl,
div.line-block,
table{
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}
h1, h2, h3, h4, h5, h6,
dl > dd {
  margin-bottom: 0.5em;
}

/* Lists                    */
/* ==========               */

/* Definition Lists         */

dl > dd p:first-child { margin-top: 0; }
/* :last-child is not part of CSS 2.1 (introduced in CSS 3) */
/* dl > dd p:last-child  { margin-bottom: 0; } */

/* lists nested in definition lists */
/* :only-child is not part of CSS 2.1 (introduced in CSS 3) */
dd > ul:only-child, dd > ol:only-child { padding-left: 1em; }

/* Description Lists */
/* styled like in most dictionaries, encyclopedias etc. */
dl.description > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}

/* Field Lists */

/* example for custom field-name width */
dl.field-list.narrow > dd {
  margin-left: 5em;
}
/* run-in: start field-body on same line after long field names */
dl.field-list.run-in > dd p {
  display: block;
}

/* Bibliographic Fields */

/* generally, bibliographic fields use special definition list dl.docinfo */
/* but dedication and abstract are placed into "topic" divs */
div.abstract p.topic-title {
  text-align: center;
}
div.dedication {
  margin: 2em 5em;
  text-align: center;
  font-style: italic;
}
div.dedication p.topic-title {
  font-style: normal;
}

/* Citations */
dl.citation dt.label {
  font-weight: bold;
}
span.fn-backref {
  font-weight: normal;
}

/* Text Blocks           */
/* ============          */

/* Literal Blocks           */
pre.literal-block, pre.doctest-block,
pre.math, pre.code {
  margin-left: 1.5em;
  margin-right: 1.5em
}

/* Block Quotes             */

blockquote,
div.topic {
  margin-left: 1.5em;
  margin-right: 1.5em
}
blockquote > table,
div.topic > table {
  margin-top: 0;
  margin-bottom: 0;
}
blockquote p.attribution,
div.topic p.attribution {
  text-align: right;
  margin-left: 20%;
}

/* Tables                   */
/* ======                   */

/* th { vertical-align: bottom; } */

table tr { text-align: left; }

/* "booktabs" style (no vertical lines) */
table.booktabs {
  border: 0;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.booktabs * {
  border: 0;
}
table.booktabs th {
  border-bottom: thin solid;
}

/* numbered tables (counter defined in div.document) */
table.numbered > caption:before {
  counter-increment: table;
  content: "Table " counter(table) ": ";
  font-weight: bold;
}

/* Explicit Markup Blocks   */
/* ======================   */

/* Footnotes and Citations  */
/* -----------------------  */

/* line on the left */
dl.footnote {
  padding-left: 1ex;
  border-left: solid;
  border-left-width: thin;
}

/* Directives               */
/* ----------               */

/* Body Elements            */
/* ~~~~~~~~~~~~~            */

/* Images and Figures */

/* let content flow to the side of aligned images and figures */
.figure.align-left,
img.align-left,
object.align-left {
  display: block;
  clear: left;
  float: left;
  margin-right: 1em
}
.figure.align-right,
img.align-right,
object.align-right {
  display: block;
  clear: right;
  float: right;
  margin-left: 1em
}
/* Stop floating sidebars, images and figures at section level 1,2,3 */
h1, h2, h3 { clear: both; }

/* Sidebar */

/* Move into the margin. In a layout with fixed margins, */
/* it can be moved into the margin completely.		 */
div.sidebar {
  width: 30%;
  max-width: 26em;
  margin-left: 1em;
  margin-right: -5.5%;
  background-color: #ffffee ;
}

/* Code                     */

pre.code, code { background-color: #eeeeee }
pre.code .ln { color: gray; } /* line numbers */
/* basic highlighting: for a complete scheme, see */
/* http://docutils.sourceforge.net/sandbox/stylesheets/ */
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

/* Math                     */
/* styled separately (see math.css for math-output=HTML) */

/* Epigraph                 */
/* Highlights               */
/* Pull-Quote               */
/* Compound Paragraph       */
/* Container                */

/* can be styled in a custom stylesheet */

/* Document Header and Footer */

div.footer, div.header {
  clear: both;
  font-size: smaller;
}

/* Inline Markup            */
/* =============            */

/* Emphasis                 */
/*   em                     */
/* Strong Emphasis          */
/*   strong		    */
/* Interpreted Text         */
/*   span.interpreted  	    */
/* Title Reference 	    */
/*   cite		    */
/* Inline Literals          */
/* possible values: normal, nowrap, pre, pre-wrap, pre-line */
/*   span.docutils.literal { white-space: pre-wrap; } */

/* Hyperlink References     */
a { text-decoration: none; }

/* External Targets         */
/*   span.target.external   */
/* Internal Targets  	    */
/*   span.target.internal   */
/* Footnote References      */
/*   a.footnote-reference   */
/* Citation References      */
/*   a.citation-reference   */

</style>
</head>
<body>
<div class="document">


<div class="section" id="cursito-intermedio-de-asm-para-la-c64-haciendo-un-chipdisk">
<h1><a class="toc-backref" href="#id15">Cursito intermedio de asm para la c64: Haciendo un Chipdisk</a></h1>
<dl class="field-list simple">
<dt>Versión</dt>
<dd><p>0.1 (<a class="reference external" href="https://github.com/c64scene-ar/chipdisk-nac-vol.1/blob/master/chipdisk_internals.es.rst">ir a última versión</a>)</p>
</dd>
<dt>Autor</dt>
<dd><p><a class="reference external" href="http://retro.moe">riq</a> / <a class="reference external" href="http://pungas.space">Pungas de Villa Martelli</a></p>
</dd>
</dl>
<div class="contents topic" id="contenidos">
<p class="topic-title first">Contenidos</p>
<ul class="simple">
<li><p><a class="reference internal" href="#cursito-intermedio-de-asm-para-la-c64-haciendo-un-chipdisk" id="id15">Cursito intermedio de asm para la c64: Haciendo un Chipdisk</a></p></li>
<li><p><a class="reference internal" href="#introduccion" id="id16">Introducción</a></p></li>
<li><p><a class="reference internal" href="#organizando-la-memoria" id="id17">Organizando la memoria</a></p>
<ul>
<li><p><a class="reference internal" href="#vic-bancos-y-demas" id="id18">VIC, bancos y demás</a></p></li>
<li><p><a class="reference internal" href="#los-sids-exomizer-y-demas" id="id19">Los sids, Exomizer, y demás</a></p></li>
<li><p><a class="reference internal" href="#grafico-bitmap-y-demas" id="id20">Gráfico Bitmap y demás</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#codigo-el-player" id="id21">Código: El Player</a></p>
<ul>
<li><p><a class="reference internal" href="#sprites-animar-rueditas-y-demas" id="id22">Sprites: Animar rueditas y demás</a></p></li>
<li><p><a class="reference internal" href="#descomprimir-sids-y-modificarlos" id="id23">Descomprimir sids y modificarlos...</a></p></li>
<li><p><a class="reference internal" href="#interrupciones-timers-y-raster" id="id24">Interrupciones, Timers y Raster</a></p></li>
<li><p><a class="reference internal" href="#timers-para-el-sid" id="id25">Timers para el Sid</a></p></li>
<li><p><a class="reference internal" href="#detectando-entre-pal-ntsc-y-drean" id="id26">Detectando entre PAL, NTSC y Drean</a></p></li>
<li><p><a class="reference internal" href="#actualizar-nombre-de-cancion-autor" id="id27">Actualizar nombre de canción / autor</a></p></li>
<li><p><a class="reference internal" href="#leyendo-mouse-joystick-y-teclado" id="id28">Leyendo mouse, joystick y teclado</a></p></li>
<li><p><a class="reference internal" href="#animar-botones-apretados" id="id29">Animar botones apretados</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#codigo-el-easter-egg" id="id30">Código: El Easter Egg</a></p>
<ul>
<li><p><a class="reference internal" href="#borde-vertical" id="id31">Borde Vertical</a></p></li>
<li><p><a class="reference internal" href="#interrupciones-nmi" id="id32">Interrupciones NMI</a></p></li>
<li><p><a class="reference internal" href="#scroll-con-sprites" id="id33">Scroll con Sprites</a></p></li>
<li><p><a class="reference internal" href="#descomprimiendo-el-easter-egg" id="id34">Descomprimiendo el Easter Egg</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#codigo-la-intro" id="id35">Código: La Intro</a></p>
<ul>
<li><p><a class="reference internal" href="#rasterbars" id="id36">Rasterbars</a></p></li>
<li><p><a class="reference internal" href="#intro-linker" id="id37">Intro-linker</a></p></li>
<li><p><a class="reference internal" href="#raster-irq-estable" id="id38">Raster IRQ estable</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#fuentes-del-chipdisk-y-demas" id="id39">Fuentes del Chipdisk y demás</a></p>
<ul>
<li><p><a class="reference internal" href="#como-compilar-el-chipdisk" id="id40">Cómo compilar el Chipdisk</a></p></li>
<li><p><a class="reference internal" href="#licencia" id="id41">Licencia</a></p></li>
<li><p><a class="reference internal" href="#comentarios-adicionales" id="id42">Comentarios adicionales</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#preguntas-y-demas" id="id43">Preguntas y demás</a></p></li>
<li><p><a class="reference internal" href="#referencias" id="id44">Referencias</a></p></li>
</ul>
</div>
</div>
<div class="section" id="introduccion">
<h1><a class="toc-backref" href="#id16">Introducción</a></h1>
<p>Hola. Primero bajarse el Chipdisk para darse una idea de lo que abarca
el cursito:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/c64scene-ar/chipdisk-nac-vol.1/raw/master/bin/chipdisk-nac.d64">chipdisk-nac.d64</a></p></li>
</ul>
<p>Listo, empecemos. Tocar un sid en una Commodore 64 es muy sencillo:</p>
<pre class="code asm literal-block"><code><span class="name label">setup:</span>
    <span class="name function">sei</span>                 <span class="comment">; prohibir interrupciones
</span>
    <span class="name function">lda</span> <span class="comment">#&lt;irq_vector    ; setear vector IRQ para ser llamado
</span>    <span class="name constant">sta</span> <span class="name constant">$0314</span>           <span class="comment">; una vez por cada refresh de pantalla
</span>    <span class="name constant">lda</span> <span class="comment">#&gt;irq_vector
</span>    <span class="name constant">sta</span> <span class="name constant">$0315</span>           <span class="comment">; el vector $314/$315 apunta a la rutina raster IRQ
</span>
    <span class="name function">lda</span> <span class="comment">#$00
</span>    <span class="name constant">jsr</span> <span class="name constant">$1000</span>           <span class="comment">; inicializar sid para que toque canción 0
</span>                        <span class="comment">; ya que un sid puede tener más de una canción
</span>
    <span class="name function">cli</span>                 <span class="comment">; habilitar interrupciones nuevamente
</span>    <span class="name constant">rts</span>

<span class="name label">irq_vector:</span>
    <span class="name function">asl</span> <span class="name constant">$d019</span>           <span class="comment">; ACK interrupción de raster
</span>
    <span class="name function">jsr</span> <span class="name constant">$1003</span>           <span class="comment">; llamar a tocar el sid
</span>
    <span class="name function">jmp</span> <span class="name constant">$ea31</span>           <span class="comment">; salir de la interrupción</span></code></pre>
<p>...y listo. Cada sid sabe tocarse solo, ya que un sid es código + data.
La llamada <span class="docutils literal">jsr $1003</span> hace toda la magia, y ese código esta dentro
del sid.</p>
<p>Lo complicado de hacer un Chipdisk, no es tocar el sid, sino todo lo
demás. Veamos el porqué.</p>
</div>
<div class="section" id="organizando-la-memoria">
<h1><a class="toc-backref" href="#id17">Organizando la memoria</a></h1>
<div class="section" id="vic-bancos-y-demas">
<h2><a class="toc-backref" href="#id18">VIC, bancos y demás</a></h2>
<p><em>Nota</em>: Supongo que ya sabes como usar sprites y modos gráficos. Si aún
no lo sabes, ir a <a class="reference external" href="http://dustlayer.com/vic-ii/2013/4/28/vic-ii-for-beginners-part-5-bringing-sprites-in-shape">Bringing Sprites in good Shape</a>
y a <a class="reference external" href="http://dustlayer.com/vic-ii/2013/4/26/vic-ii-for-beginners-screen-modes-cheaper-by-the-dozen">Screen Modes Cheaper by the Dozen</a></p>
<p>Empecemos por lo básico. Hay 64k RAM disponibles, pero cuando prendemos la compu
dice que hay <span class="docutils literal">38911 BASIC BYTES FREE</span>. Eso significa que si vamos a usar BASIC,
solo hay 38k RAM libres.</p>
<div class="figure">
<img alt="memory\_free" src="https://lh3.googleusercontent.com/q9Fndsw89AVrXaPtPwr9FUPH42cbtExt4vuyi_VpAFCXG_W_7nMhPqZ2-CAfSbFaERt0IK-9eqAlY2nJrM4FKwZ--hEpjcbTzlCrcIKTXJ5ESBGulrjjiN3KsF-1bcztXnww_a0" />
<p class="caption"><em>Hay 38k RAM libres para usar desde BASIC, pero 64k RAM desde asm</em></p>
</div>
<p>Pero como no vamos a usar BASIC, lo <em>apagamos</em> y nos libera 8k RAM.
Y si seguimos apagando todo, como el KERNAL y demás, entonces ahí vamos a tener
los 64k RAM libres.</p>
<p>Para prender/apagar estas cosas se usa la dirección <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/zp01.htm">$01</a></p>
<p>En el Chipdisk usamos dos configuraciones:</p>
<ul class="simple">
<li><p>Todo apagado menos <span class="docutils literal"><span class="pre">$d000-$dfff</span></span> (area reservada para IO:
VIC/SID/CIA): se usa siempre, salvo cuando se descomprimen los
sids</p></li>
<li><p>Todo apagado (64k RAM libres): se usa cuando se descomprimen los
sids, ya que el area de <span class="docutils literal"><span class="pre">$d000-$dfff</span></span> es usada por los sids
comprimidos</p></li>
</ul>
<p>Se usa así:</p>
<pre class="code asm literal-block"><code><span class="name function">lda</span> <span class="comment">#37                 ; valor por defecto de la C64
</span><span class="name constant">sta</span> <span class="name constant">$01</span>                 <span class="comment">; 0000-9FFF: RAM
</span>                        <span class="comment">; A000-BFFF: BASIC
</span>                        <span class="comment">; C000-CFFF: RAM
</span>                        <span class="comment">; D000-DFFF: IO (VIC,SID/CIA)
</span>                        <span class="comment">; E000-FFFF: KERNAL
</span>
<span class="name function">lda</span> <span class="comment">#$35                ; usada por el Chipdisk normalmente
</span><span class="name constant">sta</span> <span class="name constant">$01</span>                 <span class="comment">; 0000-9FFF: RAM
</span>                        <span class="comment">; A000-BFFF: RAM
</span>                        <span class="comment">; C000-CFFF: RAM
</span>                        <span class="comment">; D000-DFFF: IO (VIC,SID/CIA)
</span>                        <span class="comment">; E000-FFFF: RAM
</span>
<span class="name function">lda</span> <span class="comment">#$34                ; usada por el Chipdisk cuando descomprime
</span><span class="name constant">sta</span> <span class="name constant">$01</span>                 <span class="comment">; 0000-9FFF: RAM
</span>                        <span class="comment">; A000-BFFF: RAM
</span>                        <span class="comment">; C000-CFFF: RAM
</span>                        <span class="comment">; D000-DFFF: RAM
</span>                        <span class="comment">; E000-FFFF: RAM</span></code></pre>
<p>Hay varias posibles combinaciones. Ir <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/zp01.htm">acá para más info</a></p>
<p>La otra cosa, es que el VIC (la <em>GPU</em> de la compu) necesita de la memoria RAM.
Si queremos dibujar un gráfico bitmap, ponemos el gráfico en la memoria RAM y
el VIC lo lee de ahí (de la RAM). Así que la RAM se comparte entre la CPU (el 6510)
y la GPU (el VIC).</p>
<p>Pero hay un limitación: El VIC solo puede ver 16k a la vez de los 64k RAM.
Hay 4 bancos de 16k cada uno (<span class="docutils literal">64k / 16k == 4</span>) de los cuales el VIC puede
leer la data.</p>
<ul class="simple">
<li><p>Banco 0: <span class="docutils literal">$0000 - $3fff</span></p></li>
<li><p>Banco 1: <span class="docutils literal">$4000 - $7fff</span></p></li>
<li><p>Banco 2: <span class="docutils literal">$8000 - $bfff</span></p></li>
<li><p>Banco 3: <span class="docutils literal">$c000 - $ffff</span></p></li>
</ul>
<p>Esto significa que un gráfico bitmap no puede estar mitad en un banco y mitad
en otro. Tiene que estar entero en un solo banco.</p>
<p>Pero eso no es todo. No puede estar en cualquier parte del banco. Hay lugares
especiales para poner el bitmap, el charset y la screen RAM.</p>
<p>Y a eso se le suman otras limitaciones, pero vamos de poco.  Para decirle al
VIC que banco usar, se hace a travez del registro <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia20.htm">$dd00</a> del CIA 2, así:</p>
<pre class="code asm literal-block"><code><span class="name function">lda</span> <span class="name constant">$dd00</span>                       <span class="comment">; CIA 2
</span><span class="name constant">and</span> <span class="comment">#$%11111100                 ; máscara de los 2 primeros bits
</span><span class="name constant">ora</span> <span class="comment">#2                          ; 3 para Banco 0
</span>                                <span class="comment">; 2 para Banco 1
</span>                                <span class="comment">; 1 para Banco 2
</span>                                <span class="comment">; 0 para Banco 3
</span><span class="name constant">sta</span> <span class="name constant">$dd00</span></code></pre>
<p>Y para decirle al VIC donde esta el bitmap, charset y screen+sprite ptr., se hace a
travez del registro <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic24.htm">$d018</a> del VIC.</p>
<div class="figure">
<img alt="internals de cada banco" src="https://lh3.googleusercontent.com/hRPBQeC8azhb1h5fmaBBfaLfqA_zQgGvFEI56Dyq-lIpAOzCbQCwsoGiynGc2Zr-XBcLJXGbmnfPsdbK_xwWAjw48-Fs2Lknnx9TGaHGj2ttM5oPYOmZVxhVLdP-YzqILJCZwTk" />
<p class="caption"><em>Memoria interna de cada banco</em></p>
</div>
<p>Pero eso no es todo. Los bancos 0 y 2 (<span class="docutils literal"><span class="pre">$0000-$3fff</span></span> y <span class="docutils literal"><span class="pre">$8000-$bfff</span></span>) tienen
mapeados entre <span class="docutils literal"><span class="pre">$1000-$1fff</span></span> y <span class="docutils literal"><span class="pre">$9000-$9fff</span></span> respectivamente al charset
default (mayúsculas y minúsculas). Eso significa que no podemos usar esas
direcciones para que el VIC vea data... salvo para que vea el charset default.</p>
<div class="figure">
<img alt="bancos del VIC" src="https://lh3.googleusercontent.com/hgGTs3AF3tFO6FuL3F1aWGujcLNspxEFnY6JARm53sRvWik8hTKNJAPDgMFbzeoJCu_LPDy7Tyaz7tjrMUO9tHwwiHQXw74_W87_uIbPpQR_cZCVCE8oRHikpQ2WrGpDp_DC46A" />
<p class="caption"><em>Los cuatro bancos disponibles</em></p>
</div>
<p>Y el VIC <em>ve</em> el charset por default en esas direcciones porque el charset
tiene que estar en algún lugar. Pero si esta en la RAM va a ocupar memoria RAM,
entonces de los 38k libres para el BASIC, habría ahora 4k menos. Y supongo que
para que no suceda eso, lo ingenieros de C= decidieron mapearle al VIC el
charset en esas direcciones.</p>
<p>Resumiendo:</p>
<ul class="simple">
<li><p>Hay 4 bancos posibles donde poner la data para el VIC</p></li>
<li><p>Los valores del VIC son módulo <span class="docutils literal">$4000</span></p></li>
<li><p>En las direcciones <span class="docutils literal"><span class="pre">$1000-$1fff</span></span> y <span class="docutils literal"><span class="pre">$9000-$9fff</span></span>, el VIC <strong>ve</strong> el charset por default</p></li>
<li><p>Se usa <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia20.htm">$dd00</a> para cambiar de banco. Y <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic24.htm">$d018</a> para decirle al SID de donde sacar la data</p></li>
<li><p>El bitmap y el charset comparten el bit 3. Pero es porque ambos no pueden estar habilitados a la vez</p></li>
</ul>
</div>
<div class="section" id="los-sids-exomizer-y-demas">
<h2><a class="toc-backref" href="#id19">Los sids, Exomizer, y demás</a></h2>
<p>¿Cuanta RAM necesitamos para el Chipdisk? Hagamos cuentas.
El Chipdisk esta compuesto por 3 módulos:</p>
<ul class="simple">
<li><p>Intro: Mitad gráfico multi-color + mitad pantalla PETSCII + charset +
código</p></li>
<li><p>Player: 9 canciones (sids) + sonido para ruido blanco + gráfico
bitmap + charset + código</p></li>
<li><p>Easter Egg: 1 canción (sid) + gráfico PETSCII + texto scroll + código</p></li>
</ul>
<p><img alt="intro" src="https://lh3.googleusercontent.com/8428M9tm2gsXy5q5725Y_ddPiO6XLxNfV3E2jt5q8hp_-G65M-klPna7nJjk82BdEBR9_o72mYsDN3gf9o_OgABJ6cuH_D1nl-VJnfRtxrtabcdKGNIpkLQZDWX2Wx9qhprp8XU" /><img alt="player" src="https://lh3.googleusercontent.com/skZURzPSvCWF27RkDVUQr9UtxuAcp2G8yxv1TS5qQg5Cp1rt_TFXyMPCxAoveqRSgikO6g7O6ZatJJm_S3m-U3u5d4O-ge4XWSnnDQmQHCBu_b7YjKY4LD_I_woCqrSpOseXNLU" /><img alt="easteregg" src="https://lh3.googleusercontent.com/qKBOrZy7L8NlH0d3pOxV4EkrlJzqY16sPv6xrO_R2eeGcLt_2MV9BR-UakHxEjecRKL_4s9gXM7sfQDs8D0C5f_OvUZaZUc75SH_a_7d8dGKABBjjH4TIABonNONQ4Iye7fciI0" /></p>
<p>Y solo el módulo del Player ocupa:</p>
<ul class="simple">
<li><p>Los 9 sids: ~53k</p></li>
<li><p>Gráfico bitmap: 9k (8k bitmap + 1k colores)</p></li>
<li><p>Ruido blanco (usando entre tema y tema): ~1,8k</p></li>
<li><p>Imágenes de botones apretados (bitmap + colores): ~1,7k</p></li>
<li><p>Charset (usado en letras oblicuas): 1k</p></li>
<li><p>Sprites (cursores, rueditas, contador): ~1k</p></li>
</ul>
<p>Y nos da un total de: ~65k, sin contar código, ni Intro, ni Easter Egg.
¿Cómo hacemos para meter todo en 64k de memoria y sin acceder al disco?</p>
<p>La respuesta es: Se comprime todo lo que se pueda comprimir, y se descomprime
cuando se necesita.</p>
<ul class="simple">
<li><p>Los 9 sids comprimidas <a class="footnote-reference brackets" href="#id7" id="id1">1</a> usando <a class="reference external" href="https://bitbucket.org/magli143/exomizer/wiki/Home">Exomizer</a> ocupan: ~28k</p></li>
</ul>
<p>Pero para que un sid se pueda &quot;tocar&quot; un sid hay que descomprimirlo en algún
lugar. Para eso se necesita RAM libre. Entonces necesitamos un buffer tan
grande como el sid más grande.</p>
<p>En nuestro caso, el sid que más ocupa es <em>Prófugos</em> con 9k. Algo
bastante inusual para un sid (generalmente no ocupan más de 4k), pero
por los instrumentos y demás, no se puede achicar más que eso sin
perder calidad de sonido.</p>
<p>Entonces necesitamos un total de 37k (28k + 9k) para los sids. Algo
mucho mejor que los 53k original (¡16k menos!).</p>
<p>El buffer de 9k empieza en la dirección <span class="docutils literal">$1000</span>. Puede empezar en cualquier
otro lado, pero como los sids por defecto corren en <span class="docutils literal">$1000</span>, seguimos
usando <span class="docutils literal">$1000</span>. Así que de <span class="docutils literal">$1000</span> a <span class="docutils literal">$3328</span> (8952 bytes) están
reservados para descomprimir los sids.</p>
<p><em>Nota</em>: ¿Y saben por qué casi todos los sids empiezan en <span class="docutils literal">$1000</span>? Vean la sección
anterior para saberlo.</p>
<p>Los sids comprimidos están a partir de <span class="docutils literal">$7cb0</span>. Cuanto más arriba
mejor, así libera lugar para el gráfico bitmap (ver más abajo).</p>
<p>Hasta ahora la memoria esta así:</p>
<pre class="literal-block">$0000 - $0fff: Libre (4k)
$1000 - $32f7: Buffer reservado para tocar un sid (~9k)
$32f8 - $7caf: Libre (18k)
$7cb0 - $fbdf: Sids comprimidos (28k)
$fbe0 - $ffff: Libre (1k)</pre>
</div>
<div class="section" id="grafico-bitmap-y-demas">
<h2><a class="toc-backref" href="#id20">Gráfico Bitmap y demás</a></h2>
<p>Ahora hay que poner al gráfico algún lugar. Un buen lugar es ponerlo en el Banco 1.
Usar de <span class="docutils literal"><span class="pre">$4000-6000</span></span> para el bitmap, y de <span class="docutils literal"><span class="pre">$6000-$6400</span></span> para los colores.
Y si agregamos los sprites, sid de ruido blanco y demás, queda así:</p>
<pre class="literal-block">$0000 - $0fff: Libre (4k)
$1000 - $32f7: Buffer para tocar el sid más grande (~9k)
$32f8 - $3fff: Libre (~3k)
$4000 - $5fff: Gráfico bitmap (8k)
$6000 - $63ff: Gráfico color (Screen RAM) (1k)
$6400 - $68ff: Sprites (~1k)
$6900 - $6cff: Charset (1k)
$6d00 - $73ff: Sid de Ruido blanco (1.7k)
$7400 - $7caf: Imagenes de botones apretados + buffer temporal (~2k)
$7cb0 - $fbdf: Sids comprimidos (28k)
$fbe0 - $ffff: Libre (1k)</pre>
<p>Sobran 9k para poner el código del Player. Pero recordemos que en esos
9k también tiene que estar el Easter Egg. Eso complica las cosas
bastante. Poner la Intro no ocupa lugar en los 9k. Luego explicaré
porqué.</p>
</div>
</div>
<div class="section" id="codigo-el-player">
<h1><a class="toc-backref" href="#id21">Código: El Player</a></h1>
<p>El código del player se puede dividir en:</p>
<ul class="simple">
<li><p>Sprites: Animar rueditas y demás</p></li>
<li><p>Descomprimir sid, modificarlo para NTSC/Drean tocarlo</p></li>
<li><p>Actualizar nombre de canción / autor</p></li>
<li><p>Leer eventos: mouse (port #1), joystick (port #2) o teclado</p></li>
<li><p>Animar botones apretados</p></li>
<li><p>Patchear gráfico bitmap con sprites</p></li>
<li><p>Actualizar número de canción</p></li>
</ul>
<div class="section" id="sprites-animar-rueditas-y-demas">
<h2><a class="toc-backref" href="#id22">Sprites: Animar rueditas y demás</a></h2>
<div class="figure">
<img alt="sprites" src="https://lh3.googleusercontent.com/5gtsDGNPpV8eU6wD3jYBJnJmpG23iXHaXga_NbVDUpKQa5gCSbN_2_bmCAaJP7DLaaiBOauma2cJHrBYQmMnXsYUB7erJ2c4bUCdkFAcQjPgYyEPZCc2bpb9_db66AQ0pKdo9rM" />
<p class="caption"><em>Sprites usados por el player</em></p>
</div>
<p>Dentro del player se usan sprites en los distintos lugares:</p>
<ul class="simple">
<li><p>Animación de las rueditas: un sprite para cada ruedita</p></li>
<li><p>Puntero: 2 sprites &quot;overlayed&quot;</p></li>
<li><p>Boton de encendido: 1 sprite</p></li>
<li><p>Contador para canciones: 1 sprite</p></li>
<li><p>Arreglar &quot;artifacs&quot; del bitmap: 2 sprites</p></li>
</ul>
<p>En total se usan 8 sprites, así que no hay necesidad de multiplexar los sprites.</p>
<div class="figure">
<img alt="donde están los sprites" src="https://lh3.googleusercontent.com/rZIaCnwOg7xCputC0GH9FF4xdUOl5-yW4c4ZgZpemclrt9qH6rbTglj91-NXl4tuC8aXvuheJiEiugWB-iP5o9uN4XW1W6TPFYzAdonBz4e9-et4Yc2VdBIXSaNn9MF7H4yGeWk" />
<p class="caption"><em>Ubicación de los sprites</em></p>
</div>
<p>La animación de las rueditas es trivial. Se cambia el sprite frame cada tantos
segundos. Veamos como se hace:</p>
<pre class="code asm literal-block"><code><span class="name function">SPRITE_DATA_ADDR</span> <span class="error">=</span> <span class="name constant">$6400</span>
<span class="name function">SPRITE0_POINTER</span> <span class="error">=</span> <span class="error">&lt;</span><span class="punctuation">((</span><span class="name constant">SPRITE_DATA_ADDR</span> <span class="name constant">.MOD</span> <span class="name constant">$4000</span><span class="punctuation">)</span> <span class="error">/</span> <span class="literal number integer">64</span><span class="punctuation">)</span>     <span class="comment">; equivalente a 144
</span><span class="name constant">TOTAL_FRAMES</span> <span class="error">=</span> <span class="literal number integer">5</span>

<span class="name label">do_anim_cassette:</span>
        <span class="name function">dec</span> <span class="name constant">delay</span>
        <span class="name function">bne</span> <span class="name constant">end</span>                         <span class="comment">; fin del delay ?
</span>
        <span class="name function">lda</span> <span class="comment">#3
</span>        <span class="name constant">sta</span> <span class="name constant">delay</span>                       <span class="comment">; restaura el delay
</span>
        <span class="name function">dec</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; $63f8 + 6 es el &quot;sprite pointer&quot; del sprite 6
</span>        <span class="name constant">lda</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; lo compara con el primer frame - 1
</span>        <span class="name constant">cmp</span> <span class="comment">#(SPRITE0_POINTER - 1)
</span>        <span class="name constant">bne</span> <span class="punctuation">:</span><span class="error">+</span>
        <span class="name function">lda</span> <span class="comment">#(SPRITE0_POINTER + TOTAL_FRAMES - 1) ; si es así, setea el frame otra vez desde el final
</span><span class="punctuation">:</span>       <span class="name constant">sta</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; actualiza sprite pointer del sprite #6
</span>        <span class="name constant">sta</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">7</span>                   <span class="comment">; y lo mismo para el sprite #7
</span><span class="name constant">end</span><span class="punctuation">:</span>
        <span class="name function">rts</span>
<span class="name label">delay:</span>
        <span class="name attribute">.byte</span> <span class="literal number integer">1</span></code></pre>
<p>Y los sprites pointers están desde <span class="docutils literal">$63f8</span> a <span class="docutils literal">$63ff</span> ya que se esta usando
el Banco 1 (<span class="docutils literal"><span class="pre">$4000-$7fff</span></span>) y le dijimos al VIC que la Screen va a estar en
<span class="docutils literal">$6000</span>.</p>
<p>Un truquito útil para que los sprites se vean mejor es dibujar un sprite
standard sobre otro sprite (standard o multi-color).</p>
<p>La idea es esta:</p>
<div class="figure">
<img alt="overlay sprites" src="https://lh3.googleusercontent.com/T1TmdjKnu_7BrDTvQr3L1Sre2jmwlM-KTsnBpCuEjK9g7esu5pQyd1gXsVoUOR2_L4w4jsZKX7w_RkhfgsCdztt1wWJbuu1zkJ9X8DpM7Xp8CxEJY_hX-YqFkdBxQDrxObXxi1Y" />
<p class="caption"><em>Overlayed sprites</em></p>
</div>
<p>Esta idea se usa mucho. Jueguitos como el Bruce Lee (y cientos de otros) la usan.
El único inconveniente es que usa 2 sprites en vez de uno.</p>
<p>Otro truquito que usamos, es arreglar &quot;bugs&quot; del bitmap con sprites. Recuerden
que las celdas del bitmap no pueden tener más de 2 colores. Y para solucionar
algunos pixeles que se ven mal, los tapamos con sprites.</p>
<p>Y eso es todo respecto a los Sprites del Player.</p>
</div>
<div class="section" id="descomprimir-sids-y-modificarlos">
<h2><a class="toc-backref" href="#id23">Descomprimir sids y modificarlos...</a></h2>
<p>Los sids están comprimidos con <a class="reference external" href="https://bitbucket.org/magli143/exomizer/wiki/Home">Exomizer</a>. Así que se usa la rutina de
descompresión del Exomizer <a class="footnote-reference brackets" href="#id8" id="id2">2</a>. Lo interesante de esta rutina, es que es &quot;multi
tarea&quot;. Es decir, mientras descomprime se pueden hacer otras cosas. En nuestro
caso, cuando descomprimimos el sid, lo que hacemos es animar las rueditas del
casette:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; get_crunched_byte()
; Esta subrutina es llamada por el decruncher. X, Y y Carry se tiene que preservar.
; Actualiza el puntero del decruncher y anima las rueditas del casette
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">get_crunched_byte:</span>
        <span class="name function">lda</span> <span class="name constant">_crunched_byte_lo</span>           <span class="comment">; _crunched_byte_lo &amp; _crunched_byte_hi
</span>        <span class="name constant">bne</span> <span class="error">&#64;</span><span class="name constant">byte_skip_hi</span>               <span class="comment">; son usados por el decruncher (exomizer)
</span>        <span class="name constant">dec</span> <span class="name constant">_crunched_byte_hi</span>           <span class="comment">; para saber que byte tiene que Descomprimir
</span>                                        <span class="comment">; cada vez que se llama a esta rutina
</span>                                        <span class="comment">; lo que hay que hacer es decrementar en uno
</span>                                        <span class="comment">; al puntero
</span><span class="error">&#64;</span><span class="name constant">byte_skip_hi</span><span class="punctuation">:</span>

        <span class="name function">dec</span> <span class="name constant">delay</span>                       <span class="comment">; y de paso, lo que hacemos es animar las rueditas
</span>        <span class="name constant">bne</span> <span class="error">&#64;</span><span class="name constant">cont</span>                       <span class="comment">; del casette.
</span>                                        <span class="comment">; &quot;delay&quot; es un timer para animar las rueditas
</span>                                        <span class="comment">; a la velocidad correcta
</span>
        <span class="name function">lda</span> <span class="name constant">wheel_delay_counter</span>         <span class="comment">; resetea el delay
</span>        <span class="name constant">sta</span> <span class="name constant">delay</span>

        <span class="name function">php</span>                             <span class="comment">; guarda Status (Carry y otros) porque
</span>                                        <span class="comment">; el decruncher necesita que estos valores
</span>                                        <span class="comment">; no se modifiquen
</span>
        <span class="name function">lda</span> <span class="name constant">is_rewinding</span>                <span class="comment">; si se pasa a la canción anterior, entonces
</span>        <span class="name constant">beq</span> <span class="error">&#64;</span><span class="name constant">anim_ff</span>                    <span class="comment">; animar ruedita para atras, sino para adelante
</span>        <span class="name constant">inc</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; $63f8 + 6 y + 7 son guardan los sprite frames
</span>        <span class="name constant">lda</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; de los sprites de las rueditas
</span>        <span class="name constant">cmp</span> <span class="comment">#(SPRITE0_POINTER + TOTAL_FRAMES)
</span>        <span class="name constant">bne</span> <span class="punctuation">:</span><span class="error">+</span>
        <span class="name function">lda</span> <span class="comment">#SPRITE0_POINTER
</span><span class="punctuation">:</span>       <span class="name constant">sta</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; actualiza los punteroes del sprite 6
</span>        <span class="name constant">sta</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">7</span>                   <span class="comment">; y del sprite 7
</span>        <span class="name constant">jmp</span> <span class="error">&#64;</span><span class="name constant">done_anim</span>
<span class="error">&#64;</span><span class="name label">anim_ff:</span>
        <span class="name function">dec</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; acá es lo mismo, pero con animación
</span>        <span class="name constant">lda</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; en &quot;fast forward&quot; (la otra era &quot;rewind&quot;)
</span>        <span class="name constant">cmp</span> <span class="comment">#(SPRITE0_POINTER - 1)
</span>        <span class="name constant">bne</span> <span class="punctuation">:</span><span class="error">+</span>
        <span class="name function">lda</span> <span class="comment">#(SPRITE0_POINTER + TOTAL_FRAMES - 1)
</span><span class="punctuation">:</span>       <span class="name constant">sta</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">6</span>                   <span class="comment">; actualiza los punteros del sprite 6
</span>        <span class="name constant">sta</span> <span class="name constant">$63f8</span> <span class="error">+</span> <span class="literal number integer">7</span>                   <span class="comment">; y 7
</span><span class="error">&#64;</span><span class="name constant">done_anim</span><span class="punctuation">:</span>
        <span class="name function">plp</span>                             <span class="comment">; restaura Status (Carry y otros)
</span>
<span class="error">&#64;</span><span class="name label">cont:</span>
        <span class="name function">dec</span> <span class="name constant">_crunched_byte_lo</span>
<span class="name function">_crunched_byte_lo</span> <span class="error">=</span> <span class="punctuation">*</span> <span class="error">+</span> <span class="literal number integer">1</span>
<span class="name function">_crunched_byte_hi</span> <span class="error">=</span> <span class="punctuation">*</span> <span class="error">+</span> <span class="literal number integer">2</span>
        <span class="name function">lda</span> <span class="name constant">$caca</span>                       <span class="comment">; self-modyfing. tiene que contener el último
</span>                                        <span class="comment">; byte + 1 de lo que se quiere descomprimir
</span>                                        <span class="comment">; antes de llamar a esta rutina
</span>        <span class="name constant">rts</span>
<span class="name label">delay:</span>
        <span class="name attribute">.byte</span> <span class="literal number integer">5</span></code></pre>
<p>Una vez descomprimido el sid, hay que modificar la tabla de frecuencias
para que suene igual tanto en PAL, NTSC y Drean (PAL-N).</p>
<p>Para eso, no hay que hacer otra cosa que ir sid por sid y fijarse donde
esta la tabla de frecuencias de cada uno.</p>
<p>Las tablas de frecuencias generalmente tienen 96 valores:</p>
<ul class="simple">
<li><p>8 octavas</p></li>
<li><p>de 12 semi-tonos cada una</p></li>
</ul>
<p>Cada semi-tono ocupa 2 bytes, así que generalmente los sids almacenan
las tablas de la siguiente manera:</p>
<pre class="code asm literal-block"><code><span class="comment">; PAL freq table
</span><span class="name label">freq_table_lo:</span>
<span class="comment">;      C   C#  D   D#  E   F   F#  G   G#  A   A#  B
</span><span class="name attribute">.byte</span> <span class="name constant">$17</span><span class="punctuation">,</span><span class="name constant">$27</span><span class="punctuation">,</span><span class="name constant">$39</span><span class="punctuation">,</span><span class="name constant">$4b</span><span class="punctuation">,</span><span class="name constant">$5f</span><span class="punctuation">,</span><span class="name constant">$74</span><span class="punctuation">,</span><span class="name constant">$8a</span><span class="punctuation">,</span><span class="name constant">$a1</span><span class="punctuation">,</span><span class="name constant">$ba</span><span class="punctuation">,</span><span class="name constant">$d4</span><span class="punctuation">,</span><span class="name constant">$f0</span><span class="punctuation">,</span><span class="name constant">$0e</span>  <span class="comment">; 1
</span><span class="name constant">.byte</span> <span class="name constant">$2d</span><span class="punctuation">,</span><span class="name constant">$4e</span><span class="punctuation">,</span><span class="name constant">$71</span><span class="punctuation">,</span><span class="name constant">$96</span><span class="punctuation">,</span><span class="name constant">$be</span><span class="punctuation">,</span><span class="name constant">$e8</span><span class="punctuation">,</span><span class="name constant">$14</span><span class="punctuation">,</span><span class="name constant">$43</span><span class="punctuation">,</span><span class="name constant">$74</span><span class="punctuation">,</span><span class="name constant">$a9</span><span class="punctuation">,</span><span class="name constant">$e1</span><span class="punctuation">,</span><span class="name constant">$1c</span>  <span class="comment">; 2
</span><span class="name constant">.byte</span> <span class="name constant">$5a</span><span class="punctuation">,</span><span class="name constant">$9c</span><span class="punctuation">,</span><span class="name constant">$e2</span><span class="punctuation">,</span><span class="name constant">$2d</span><span class="punctuation">,</span><span class="name constant">$7c</span><span class="punctuation">,</span><span class="name constant">$cf</span><span class="punctuation">,</span><span class="name constant">$28</span><span class="punctuation">,</span><span class="name constant">$85</span><span class="punctuation">,</span><span class="name constant">$e8</span><span class="punctuation">,</span><span class="name constant">$52</span><span class="punctuation">,</span><span class="name constant">$c1</span><span class="punctuation">,</span><span class="name constant">$37</span>  <span class="comment">; 3
</span><span class="name constant">.byte</span> <span class="name constant">$b4</span><span class="punctuation">,</span><span class="name constant">$39</span><span class="punctuation">,</span><span class="name constant">$c5</span><span class="punctuation">,</span><span class="name constant">$5a</span><span class="punctuation">,</span><span class="name constant">$f7</span><span class="punctuation">,</span><span class="name constant">$9e</span><span class="punctuation">,</span><span class="name constant">$4f</span><span class="punctuation">,</span><span class="name constant">$0a</span><span class="punctuation">,</span><span class="name constant">$d1</span><span class="punctuation">,</span><span class="name constant">$a3</span><span class="punctuation">,</span><span class="name constant">$82</span><span class="punctuation">,</span><span class="name constant">$6e</span>  <span class="comment">; 4
</span><span class="name constant">.byte</span> <span class="name constant">$68</span><span class="punctuation">,</span><span class="name constant">$71</span><span class="punctuation">,</span><span class="name constant">$8a</span><span class="punctuation">,</span><span class="name constant">$b3</span><span class="punctuation">,</span><span class="name constant">$ee</span><span class="punctuation">,</span><span class="name constant">$3c</span><span class="punctuation">,</span><span class="name constant">$9e</span><span class="punctuation">,</span><span class="name constant">$15</span><span class="punctuation">,</span><span class="name constant">$a2</span><span class="punctuation">,</span><span class="name constant">$46</span><span class="punctuation">,</span><span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$dc</span>  <span class="comment">; 5
</span><span class="name constant">.byte</span> <span class="name constant">$d0</span><span class="punctuation">,</span><span class="name constant">$e2</span><span class="punctuation">,</span><span class="name constant">$14</span><span class="punctuation">,</span><span class="name constant">$67</span><span class="punctuation">,</span><span class="name constant">$dd</span><span class="punctuation">,</span><span class="name constant">$79</span><span class="punctuation">,</span><span class="name constant">$3c</span><span class="punctuation">,</span><span class="name constant">$29</span><span class="punctuation">,</span><span class="name constant">$44</span><span class="punctuation">,</span><span class="name constant">$8d</span><span class="punctuation">,</span><span class="name constant">$08</span><span class="punctuation">,</span><span class="name constant">$b8</span>  <span class="comment">; 6
</span><span class="name constant">.byte</span> <span class="name constant">$a1</span><span class="punctuation">,</span><span class="name constant">$c5</span><span class="punctuation">,</span><span class="name constant">$28</span><span class="punctuation">,</span><span class="name constant">$cd</span><span class="punctuation">,</span><span class="name constant">$ba</span><span class="punctuation">,</span><span class="name constant">$f1</span><span class="punctuation">,</span><span class="name constant">$78</span><span class="punctuation">,</span><span class="name constant">$53</span><span class="punctuation">,</span><span class="name constant">$87</span><span class="punctuation">,</span><span class="name constant">$1a</span><span class="punctuation">,</span><span class="name constant">$10</span><span class="punctuation">,</span><span class="name constant">$71</span>  <span class="comment">; 7
</span><span class="name constant">.byte</span> <span class="name constant">$42</span><span class="punctuation">,</span><span class="name constant">$89</span><span class="punctuation">,</span><span class="name constant">$4f</span><span class="punctuation">,</span><span class="name constant">$9b</span><span class="punctuation">,</span><span class="name constant">$74</span><span class="punctuation">,</span><span class="name constant">$e2</span><span class="punctuation">,</span><span class="name constant">$f0</span><span class="punctuation">,</span><span class="name constant">$a6</span><span class="punctuation">,</span><span class="name constant">$0e</span><span class="punctuation">,</span><span class="name constant">$33</span><span class="punctuation">,</span><span class="name constant">$20</span><span class="punctuation">,</span><span class="name constant">$ff</span>  <span class="comment">; 8
</span>
<span class="name label">freq_table_hi:</span>
<span class="comment">;      C   C#  D   D#  E   F   F#  G   G#  A   A#  B
</span><span class="name attribute">.byte</span> <span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$02</span>  <span class="comment">; 1
</span><span class="name constant">.byte</span> <span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$04</span>  <span class="comment">; 2
</span><span class="name constant">.byte</span> <span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$05</span><span class="punctuation">,</span><span class="name constant">$05</span><span class="punctuation">,</span><span class="name constant">$05</span><span class="punctuation">,</span><span class="name constant">$06</span><span class="punctuation">,</span><span class="name constant">$06</span><span class="punctuation">,</span><span class="name constant">$06</span><span class="punctuation">,</span><span class="name constant">$07</span><span class="punctuation">,</span><span class="name constant">$07</span><span class="punctuation">,</span><span class="name constant">$08</span>  <span class="comment">; 3
</span><span class="name constant">.byte</span> <span class="name constant">$08</span><span class="punctuation">,</span><span class="name constant">$09</span><span class="punctuation">,</span><span class="name constant">$09</span><span class="punctuation">,</span><span class="name constant">$0a</span><span class="punctuation">,</span><span class="name constant">$0a</span><span class="punctuation">,</span><span class="name constant">$0b</span><span class="punctuation">,</span><span class="name constant">$0c</span><span class="punctuation">,</span><span class="name constant">$0d</span><span class="punctuation">,</span><span class="name constant">$0d</span><span class="punctuation">,</span><span class="name constant">$0e</span><span class="punctuation">,</span><span class="name constant">$0f</span><span class="punctuation">,</span><span class="name constant">$10</span>  <span class="comment">; 4
</span><span class="name constant">.byte</span> <span class="name constant">$11</span><span class="punctuation">,</span><span class="name constant">$12</span><span class="punctuation">,</span><span class="name constant">$13</span><span class="punctuation">,</span><span class="name constant">$14</span><span class="punctuation">,</span><span class="name constant">$15</span><span class="punctuation">,</span><span class="name constant">$17</span><span class="punctuation">,</span><span class="name constant">$18</span><span class="punctuation">,</span><span class="name constant">$1a</span><span class="punctuation">,</span><span class="name constant">$1b</span><span class="punctuation">,</span><span class="name constant">$1d</span><span class="punctuation">,</span><span class="name constant">$1f</span><span class="punctuation">,</span><span class="name constant">$20</span>  <span class="comment">; 5
</span><span class="name constant">.byte</span> <span class="name constant">$22</span><span class="punctuation">,</span><span class="name constant">$24</span><span class="punctuation">,</span><span class="name constant">$27</span><span class="punctuation">,</span><span class="name constant">$29</span><span class="punctuation">,</span><span class="name constant">$2b</span><span class="punctuation">,</span><span class="name constant">$2e</span><span class="punctuation">,</span><span class="name constant">$31</span><span class="punctuation">,</span><span class="name constant">$34</span><span class="punctuation">,</span><span class="name constant">$37</span><span class="punctuation">,</span><span class="name constant">$3a</span><span class="punctuation">,</span><span class="name constant">$3e</span><span class="punctuation">,</span><span class="name constant">$41</span>  <span class="comment">; 6
</span><span class="name constant">.byte</span> <span class="name constant">$45</span><span class="punctuation">,</span><span class="name constant">$49</span><span class="punctuation">,</span><span class="name constant">$4e</span><span class="punctuation">,</span><span class="name constant">$52</span><span class="punctuation">,</span><span class="name constant">$57</span><span class="punctuation">,</span><span class="name constant">$5c</span><span class="punctuation">,</span><span class="name constant">$62</span><span class="punctuation">,</span><span class="name constant">$68</span><span class="punctuation">,</span><span class="name constant">$6e</span><span class="punctuation">,</span><span class="name constant">$75</span><span class="punctuation">,</span><span class="name constant">$7c</span><span class="punctuation">,</span><span class="name constant">$83</span>  <span class="comment">; 7
</span><span class="name constant">.byte</span> <span class="name constant">$8b</span><span class="punctuation">,</span><span class="name constant">$93</span><span class="punctuation">,</span><span class="name constant">$9c</span><span class="punctuation">,</span><span class="name constant">$a5</span><span class="punctuation">,</span><span class="name constant">$af</span><span class="punctuation">,</span><span class="name constant">$b9</span><span class="punctuation">,</span><span class="name constant">$c4</span><span class="punctuation">,</span><span class="name constant">$d0</span><span class="punctuation">,</span><span class="name constant">$dd</span><span class="punctuation">,</span><span class="name constant">$ea</span><span class="punctuation">,</span><span class="name constant">$f8</span><span class="punctuation">,</span><span class="name constant">$ff</span>  <span class="comment">; 8</span></code></pre>
<p>Entonces lo que hay que hacer es buscar esas tablas (o similares) en los
sids, y reemplazarlas en runtime por una de NTSC.</p>
<p><strong>IMPORTANTE</strong>: No todas las tablas son iguales, pero si son muy
parecidas. Por ejemplo, un &quot;La&quot; en la 8va octava puede que aparezca como
$f820, y en otras como $f830, u algún otro valor. Pero el oído humano no
las diferenciaría.</p>
<p>Lo mejor es buscar por <span class="docutils literal">$01, $01, $01, $01, $02, $02, $02</span> y ver si
tiene pinta de ser la tabla &quot;hi&quot;. Y luego ir 96 bytes para arriba o
abajo y ver si ahí esta la tabla &quot;low&quot;.</p>
<div class="figure">
<img alt="buscando tabla" src="https://lh3.googleusercontent.com/VqNAXgS2DOrbG7bJ729Fz3VWCjzkvTjH_DhtBnZeuL0iIszlmQdtWAnS8qEdBi5FX-fcFL9wfe7hAp0UHkWfmKDCQab5GokBc4vsL6IVRIDMWQdDdezC5bm7I9m2D5d8P8Lph08" />
<p class="caption"><em>Buscando la tabla de frecuencias en un sid</em></p>
</div>
<p>Y una vez que se encuentren los valores, se reemplazan por los valores
de una NTSC. Acá no hay que hacer más que un simple bucle para copiar
las tablas. Ej:</p>
<pre class="code asm literal-block"><code>    <span class="comment">; actualiza tabla de frecuencias
</span>    <span class="name function">ldx</span> <span class="comment">#95
</span><span class="error">&#64;</span><span class="name constant">l0</span><span class="punctuation">:</span>
    <span class="name function">lda</span> <span class="name constant">ntsc_freq_table_hi</span><span class="punctuation">,</span><span class="name constant">x</span>
    <span class="name function">sta</span> <span class="name constant">dst_hi</span><span class="punctuation">,</span><span class="name constant">x</span>

    <span class="name function">lda</span> <span class="name constant">ntsc_freq_table_lo</span><span class="punctuation">,</span><span class="name constant">x</span>
    <span class="name function">sta</span> <span class="name constant">dst_lo</span><span class="punctuation">,</span><span class="name constant">x</span>
    <span class="name function">bpl</span> <span class="error">&#64;</span><span class="name constant">l0</span>

<span class="name label">ntsc_freq_table_lo:</span>
<span class="name attribute">.byte</span> <span class="name constant">$0c</span><span class="punctuation">,</span><span class="name constant">$1c</span><span class="punctuation">,</span><span class="name constant">$2d</span><span class="punctuation">,</span><span class="name constant">$3f</span><span class="punctuation">,</span><span class="name constant">$52</span><span class="punctuation">,</span><span class="name constant">$66</span><span class="punctuation">,</span><span class="name constant">$7b</span><span class="punctuation">,</span><span class="name constant">$92</span><span class="punctuation">,</span><span class="name constant">$aa</span><span class="punctuation">,</span><span class="name constant">$c3</span><span class="punctuation">,</span><span class="name constant">$de</span><span class="punctuation">,</span><span class="name constant">$fa</span>  <span class="comment">; 1
</span><span class="name constant">.byte</span> <span class="name constant">$18</span><span class="punctuation">,</span><span class="name constant">$38</span><span class="punctuation">,</span><span class="name constant">$5a</span><span class="punctuation">,</span><span class="name constant">$7e</span><span class="punctuation">,</span><span class="name constant">$a4</span><span class="punctuation">,</span><span class="name constant">$cc</span><span class="punctuation">,</span><span class="name constant">$f7</span><span class="punctuation">,</span><span class="name constant">$24</span><span class="punctuation">,</span><span class="name constant">$54</span><span class="punctuation">,</span><span class="name constant">$86</span><span class="punctuation">,</span><span class="name constant">$bc</span><span class="punctuation">,</span><span class="name constant">$f5</span>  <span class="comment">; 2
</span><span class="name constant">.byte</span> <span class="name constant">$31</span><span class="punctuation">,</span><span class="name constant">$71</span><span class="punctuation">,</span><span class="name constant">$b4</span><span class="punctuation">,</span><span class="name constant">$fc</span><span class="punctuation">,</span><span class="name constant">$48</span><span class="punctuation">,</span><span class="name constant">$98</span><span class="punctuation">,</span><span class="name constant">$ed</span><span class="punctuation">,</span><span class="name constant">$48</span><span class="punctuation">,</span><span class="name constant">$a7</span><span class="punctuation">,</span><span class="name constant">$0c</span><span class="punctuation">,</span><span class="name constant">$78</span><span class="punctuation">,</span><span class="name constant">$e9</span>  <span class="comment">; 3
</span><span class="name constant">.byte</span> <span class="name constant">$62</span><span class="punctuation">,</span><span class="name constant">$e2</span><span class="punctuation">,</span><span class="name constant">$69</span><span class="punctuation">,</span><span class="name constant">$f8</span><span class="punctuation">,</span><span class="name constant">$90</span><span class="punctuation">,</span><span class="name constant">$30</span><span class="punctuation">,</span><span class="name constant">$db</span><span class="punctuation">,</span><span class="name constant">$8f</span><span class="punctuation">,</span><span class="name constant">$4e</span><span class="punctuation">,</span><span class="name constant">$19</span><span class="punctuation">,</span><span class="name constant">$f0</span><span class="punctuation">,</span><span class="name constant">$d3</span>  <span class="comment">; 4
</span><span class="name constant">.byte</span> <span class="name constant">$c4</span><span class="punctuation">,</span><span class="name constant">$c3</span><span class="punctuation">,</span><span class="name constant">$d1</span><span class="punctuation">,</span><span class="name constant">$f0</span><span class="punctuation">,</span><span class="name constant">$1f</span><span class="punctuation">,</span><span class="name constant">$61</span><span class="punctuation">,</span><span class="name constant">$b6</span><span class="punctuation">,</span><span class="name constant">$1e</span><span class="punctuation">,</span><span class="name constant">$9d</span><span class="punctuation">,</span><span class="name constant">$32</span><span class="punctuation">,</span><span class="name constant">$df</span><span class="punctuation">,</span><span class="name constant">$a6</span>  <span class="comment">; 5
</span><span class="name constant">.byte</span> <span class="name constant">$88</span><span class="punctuation">,</span><span class="name constant">$86</span><span class="punctuation">,</span><span class="name constant">$a3</span><span class="punctuation">,</span><span class="name constant">$e0</span><span class="punctuation">,</span><span class="name constant">$3f</span><span class="punctuation">,</span><span class="name constant">$c2</span><span class="punctuation">,</span><span class="name constant">$6b</span><span class="punctuation">,</span><span class="name constant">$3d</span><span class="punctuation">,</span><span class="name constant">$3a</span><span class="punctuation">,</span><span class="name constant">$64</span><span class="punctuation">,</span><span class="name constant">$be</span><span class="punctuation">,</span><span class="name constant">$4c</span>  <span class="comment">; 6
</span><span class="name constant">.byte</span> <span class="name constant">$0f</span><span class="punctuation">,</span><span class="name constant">$0c</span><span class="punctuation">,</span><span class="name constant">$46</span><span class="punctuation">,</span><span class="name constant">$bf</span><span class="punctuation">,</span><span class="name constant">$7d</span><span class="punctuation">,</span><span class="name constant">$84</span><span class="punctuation">,</span><span class="name constant">$d6</span><span class="punctuation">,</span><span class="name constant">$7a</span><span class="punctuation">,</span><span class="name constant">$73</span><span class="punctuation">,</span><span class="name constant">$c8</span><span class="punctuation">,</span><span class="name constant">$7d</span><span class="punctuation">,</span><span class="name constant">$97</span>  <span class="comment">; 7
</span><span class="name constant">.byte</span> <span class="name constant">$1e</span><span class="punctuation">,</span><span class="name constant">$18</span><span class="punctuation">,</span><span class="name constant">$8b</span><span class="punctuation">,</span><span class="name constant">$7f</span><span class="punctuation">,</span><span class="name constant">$fb</span><span class="punctuation">,</span><span class="name constant">$07</span><span class="punctuation">,</span><span class="name constant">$ac</span><span class="punctuation">,</span><span class="name constant">$f4</span><span class="punctuation">,</span><span class="name constant">$e7</span><span class="punctuation">,</span><span class="name constant">$8f</span><span class="punctuation">,</span><span class="name constant">$f9</span><span class="punctuation">,</span><span class="name constant">$2f</span>  <span class="comment">; 8
</span>
<span class="name label">ntsc_freq_table_hi:</span>
<span class="name attribute">.byte</span> <span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span><span class="punctuation">,</span><span class="name constant">$01</span>  <span class="comment">; 1
</span><span class="name constant">.byte</span> <span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$02</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span><span class="punctuation">,</span><span class="name constant">$03</span>  <span class="comment">; 2
</span><span class="name constant">.byte</span> <span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$04</span><span class="punctuation">,</span><span class="name constant">$05</span><span class="punctuation">,</span><span class="name constant">$05</span><span class="punctuation">,</span><span class="name constant">$05</span><span class="punctuation">,</span><span class="name constant">$06</span><span class="punctuation">,</span><span class="name constant">$06</span><span class="punctuation">,</span><span class="name constant">$07</span><span class="punctuation">,</span><span class="name constant">$07</span><span class="punctuation">,</span><span class="name constant">$07</span>  <span class="comment">; 3
</span><span class="name constant">.byte</span> <span class="name constant">$08</span><span class="punctuation">,</span><span class="name constant">$08</span><span class="punctuation">,</span><span class="name constant">$09</span><span class="punctuation">,</span><span class="name constant">$09</span><span class="punctuation">,</span><span class="name constant">$0a</span><span class="punctuation">,</span><span class="name constant">$0b</span><span class="punctuation">,</span><span class="name constant">$0b</span><span class="punctuation">,</span><span class="name constant">$0c</span><span class="punctuation">,</span><span class="name constant">$0d</span><span class="punctuation">,</span><span class="name constant">$0e</span><span class="punctuation">,</span><span class="name constant">$0e</span><span class="punctuation">,</span><span class="name constant">$0f</span>  <span class="comment">; 4
</span><span class="name constant">.byte</span> <span class="name constant">$10</span><span class="punctuation">,</span><span class="name constant">$11</span><span class="punctuation">,</span><span class="name constant">$12</span><span class="punctuation">,</span><span class="name constant">$13</span><span class="punctuation">,</span><span class="name constant">$15</span><span class="punctuation">,</span><span class="name constant">$16</span><span class="punctuation">,</span><span class="name constant">$17</span><span class="punctuation">,</span><span class="name constant">$19</span><span class="punctuation">,</span><span class="name constant">$1a</span><span class="punctuation">,</span><span class="name constant">$1c</span><span class="punctuation">,</span><span class="name constant">$1d</span><span class="punctuation">,</span><span class="name constant">$1f</span>  <span class="comment">; 5
</span><span class="name constant">.byte</span> <span class="name constant">$21</span><span class="punctuation">,</span><span class="name constant">$23</span><span class="punctuation">,</span><span class="name constant">$25</span><span class="punctuation">,</span><span class="name constant">$27</span><span class="punctuation">,</span><span class="name constant">$2a</span><span class="punctuation">,</span><span class="name constant">$2c</span><span class="punctuation">,</span><span class="name constant">$2f</span><span class="punctuation">,</span><span class="name constant">$32</span><span class="punctuation">,</span><span class="name constant">$35</span><span class="punctuation">,</span><span class="name constant">$38</span><span class="punctuation">,</span><span class="name constant">$3b</span><span class="punctuation">,</span><span class="name constant">$3f</span>  <span class="comment">; 6
</span><span class="name constant">.byte</span> <span class="name constant">$43</span><span class="punctuation">,</span><span class="name constant">$47</span><span class="punctuation">,</span><span class="name constant">$4b</span><span class="punctuation">,</span><span class="name constant">$4f</span><span class="punctuation">,</span><span class="name constant">$54</span><span class="punctuation">,</span><span class="name constant">$59</span><span class="punctuation">,</span><span class="name constant">$5e</span><span class="punctuation">,</span><span class="name constant">$64</span><span class="punctuation">,</span><span class="name constant">$6a</span><span class="punctuation">,</span><span class="name constant">$70</span><span class="punctuation">,</span><span class="name constant">$77</span><span class="punctuation">,</span><span class="name constant">$7e</span>  <span class="comment">; 7
</span><span class="name constant">.byte</span> <span class="name constant">$86</span><span class="punctuation">,</span><span class="name constant">$8e</span><span class="punctuation">,</span><span class="name constant">$96</span><span class="punctuation">,</span><span class="name constant">$9f</span><span class="punctuation">,</span><span class="name constant">$a8</span><span class="punctuation">,</span><span class="name constant">$b3</span><span class="punctuation">,</span><span class="name constant">$bd</span><span class="punctuation">,</span><span class="name constant">$c8</span><span class="punctuation">,</span><span class="name constant">$d4</span><span class="punctuation">,</span><span class="name constant">$e1</span><span class="punctuation">,</span><span class="name constant">$ee</span><span class="punctuation">,</span><span class="name constant">$fd</span>  <span class="comment">; 8</span></code></pre>
</div>
<div class="section" id="interrupciones-timers-y-raster">
<h2><a class="toc-backref" href="#id24">Interrupciones, Timers y Raster</a></h2>
<p>La otra cosa a tener en cuenta, es la velocidad con la que se toca el
sid. Muchos trackers generan sids que se tocan a 50.125Hz (velocidad
PAL). Es lo ideal. Pero no todos son así. Así que hay que doble chequear
eso (ej: SidTracker64).</p>
<p>Y para hacer que algo funcione a cierta velocidad en la C64, hay dos
maneras:</p>
<ul class="simple">
<li><p>Con interrupciones raster</p></li>
<li><p>Y/o con interrupciones de timer</p></li>
</ul>
<p>Básicamente las interrupciones son &quot;callbacks&quot; que nos llaman cuando
sucede algo. Estos &quot;callbacks&quot; son programables: se puede activar o
desactivar.</p>
<div class="section" id="raster">
<h3>Raster</h3>
<p>La interrupción por raster es la más común. Uno le dice a la C64 que lo
llame cuando el raster esta en cierto rasterline.</p>
<p>Por ejemplo, si yo quisiera que la el borde la pantalla fuese negro en
la parte de arriba, y blanco en la de abajo, se usan dos interrupciones
de raster encadenadas. Es así:</p>
<pre class="code asm literal-block"><code><span class="name label">setup_irq:</span>
    <span class="name function">sei</span>
    <span class="name function">ldx</span> <span class="comment">#&lt;raster_top        ; dirección de nuestro callback (IRQ)
</span>    <span class="name constant">ldy</span> <span class="comment">#&gt;raster_bottom
</span>    <span class="name constant">stx</span> <span class="name constant">$0314</span>               <span class="comment">; IRQ vector lo
</span>    <span class="name constant">sty</span> <span class="name constant">$0315</span>               <span class="comment">; IRQ vector hi
</span>
    <span class="name function">lda</span> <span class="comment">#0
</span>    <span class="name constant">sta</span> <span class="name constant">$d012</span>               <span class="comment">; disparar raster cuando rasterline sea 0
</span>
    <span class="name function">lda</span> <span class="comment">#1
</span>    <span class="name constant">sta</span> <span class="name constant">$d01a</span>               <span class="comment">; habilitar interrupción por raster
</span>
    <span class="name function">cli</span>
    <span class="name function">rts</span>

<span class="name label">raster_top:</span>
    <span class="name function">asl</span> <span class="name constant">$d019</span>               <span class="comment">; ACK interrupción de raster
</span>
    <span class="name function">lda</span> <span class="comment">#0                  ; poner borde
</span>    <span class="name constant">sta</span> <span class="name constant">$d020</span>               <span class="comment">; con color negro (0=negro)
</span>
    <span class="name function">lda</span> <span class="comment">#100                ; encadenar 2nd callback
</span>    <span class="name constant">sta</span> <span class="name constant">$d012</span>               <span class="comment">; que se dispare cuando rasterline sea 100
</span>
    <span class="name function">ldx</span> <span class="comment">#&lt;raster_bottom
</span>    <span class="name constant">ldy</span> <span class="comment">#&gt;raster_bottom
</span>    <span class="name constant">stx</span> <span class="name constant">$0314</span>
    <span class="name function">sty</span> <span class="name constant">$0315</span>

    <span class="name function">jmp</span> <span class="name constant">$ea81</span>               <span class="comment">; salir de la interrupción
</span>
<span class="name label">raster_bottom:</span>
    <span class="name function">asl</span> <span class="name constant">$d019</span>               <span class="comment">; ACK interrupción de raster
</span>
    <span class="name function">lda</span> <span class="comment">#1                  ; poner borde
</span>    <span class="name constant">sta</span> <span class="name constant">$d020</span>               <span class="comment">; con color blanco (1=blanco)
</span>
    <span class="name function">lda</span> <span class="comment">#0                  ; encadenar al primer callback
</span>    <span class="name constant">sta</span> <span class="name constant">$d012</span>               <span class="comment">; que se dispare cuando rasterline sea 0
</span>
    <span class="name function">ldx</span> <span class="comment">#&lt;raster_top
</span>    <span class="name constant">ldy</span> <span class="comment">#&gt;raster_top
</span>    <span class="name constant">stx</span> <span class="name constant">$0314</span>
    <span class="name function">sty</span> <span class="name constant">$0315</span>

    <span class="name function">jmp</span> <span class="name constant">$ea81</span>               <span class="comment">; salir de la interrupción</span></code></pre>
<p>Y así uno puede encadenar varias interrupciones de raster. Lo importante
acá es:</p>
<ul class="simple">
<li><p>el vector <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/zp0314.htm">$0314/$0315</a> contiene la dirección del callback (IRQ)</p></li>
<li><p>ACK (limpiar/aceptar) <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic25.htm">$d019</a> cuando nos llamen en la interrupción</p></li>
<li><p>habilitar interrupción de raster con <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic26.htm">$d01a</a></p></li>
<li><p>usar <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic18.htm">$d012</a> para decir en que rasterline se tiene que disparar la interrupción</p></li>
<li><p>salir de la interrupción con un <span class="docutils literal">jmp</span> a <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/romea81.htm">$ea81</a> o <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/romea31.htm">$ea31</a></p></li>
<li><p>el color del borde se cambia con <cite>$d020_</cite>. usar <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic33.htm">$d021</a> para color de fondo de pantalla</p></li>
</ul>
</div>
<div class="section" id="timers">
<h3>Timers</h3>
<p>Las interrupciones por timer funcionan muy similar a las del raster.
Pero en vez de llamarnos cuando el rasterline tiene cierto valor, nos
llaman cuando transcurren cierta cantidad de ciclos de CPU.</p>
<p>La manera de usarlas es muy similar. ej:</p>
<pre class="code asm literal-block"><code><span class="name label">setup_irq:</span>
    <span class="name function">sei</span>
    <span class="name function">ldx</span> <span class="comment">#&lt;timer_top        ; dirección de nuestro callback (IRQ)
</span>    <span class="name constant">ldy</span> <span class="comment">#&gt;timer_bottom
</span>    <span class="name constant">stx</span> <span class="name constant">$0314</span>               <span class="comment">; IRQ vector lo
</span>    <span class="name constant">sty</span> <span class="name constant">$0315</span>               <span class="comment">; IRQ vector hi
</span>
    <span class="name function">ldx</span> <span class="comment">#$c7                ; CIA 1 - Timer A que se dispare
</span>    <span class="name constant">ldy</span> <span class="comment">#$4c                ; luego de $4cc8 ciclos (se pone uno menos.)
</span>                            <span class="comment">; ej: usar $4cc7 para contar $4cc8 ciclos
</span>    <span class="name constant">stx</span> <span class="name constant">$dc04</span>
    <span class="name function">sty</span> <span class="name constant">$dc05</span>

    <span class="name function">lda</span> <span class="comment">#$81
</span>    <span class="name constant">sta</span> <span class="name constant">$dc0d</span>               <span class="comment">; prender interrupciones del CIA 1
</span>
    <span class="name function">lda</span> <span class="comment">#$11
</span>    <span class="name constant">sta</span> <span class="name constant">$dc0e</span>               <span class="comment">; prender timer A
</span>
    <span class="name function">cli</span>
    <span class="name function">rts</span>

<span class="name label">timer_top:</span>
    <span class="name function">lda</span> <span class="name constant">$dc0d</span>               <span class="comment">; ACK interrupción de Timer
</span>
    <span class="name function">jsr</span> <span class="name constant">$1003</span>               <span class="comment">; tocar música
</span>
    <span class="name function">jmp</span> <span class="name constant">$ea81</span>               <span class="comment">; salir de la interrupción</span></code></pre>
<ul class="simple">
<li><p><a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia114.htm">$dc0e</a> se usa para activar el Timer A. Puede ser &quot;single-shot&quot; o &quot;continue&quot;</p></li>
<li><p><a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia113.htm">$dc0d</a> se usa para habilitar interrupciones del CIA 1</p></li>
<li><p><a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia14.htm">$dc04</a> / <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia15.htm">$dc05</a> se usa para decirle cuantos ciclos tiene que contar
antes de disparar el callback (IRQ)</p></li>
</ul>
<p>Y así es como se usan las interrupciones. De hecho se pueden usar
interrupciones de raster y de timer a la vez. Ambas comparten el mismo
callback. Para diferenciar si es de raster o timer se puede hacer algo
así:</p>
<pre class="code asm literal-block"><code><span class="name label">irq:</span>
        <span class="name function">asl</span> <span class="name constant">$d019</span>                       <span class="comment">; ACK interrupción de raster
</span>        <span class="name constant">bcs</span> <span class="name constant">raster</span>                      <span class="comment">; y Carry estará prendido si la interrupción
</span>                                        <span class="comment">; fue de raster
</span>
        <span class="name function">lda</span> <span class="name constant">$dc0d</span>                       <span class="comment">; ACK interrupción de timer
</span>        <span class="name constant">jsr</span> <span class="name constant">$1003</span>                       <span class="comment">; ej: tocar música con el timer interrupt
</span>        <span class="name constant">jmp</span> <span class="name constant">end</span>

<span class="name label">raster:</span>
        <span class="name function">jsr</span> <span class="name constant">animar_scroll</span>               <span class="comment">; ej: animar scroll con el raster interrupt
</span>
<span class="name label">end:</span>
        <span class="name function">jmp</span> <span class="name constant">$ea81</span></code></pre>
</div>
</div>
<div class="section" id="timers-para-el-sid">
<h2><a class="toc-backref" href="#id25">Timers para el Sid</a></h2>
<p>Ahora que ya sabemos usar los timers, veamos como se usan para tocar un
sid a la velocidad correcta tanto en las distintas plataformas.</p>
<p>Asumiendo que el sid fue generado para PAL, la formulita para convertir
a NTSC es:</p>
<ul class="simple">
<li><p><span class="docutils literal">((velocidad_del_timer + 1) * 1022727 / 985248) + 1</span></p></li>
</ul>
<p>Y para convertir a Drean es similar:</p>
<ul class="simple">
<li><p><span class="docutils literal">((velocidad_del_timer + 1) * 1023440 / 985248) + 1</span></p></li>
</ul>
<p><em>Nota</em>: <span class="docutils literal">985248</span>, <span class="docutils literal">1022727</span>, <span class="docutils literal">1023440</span> son la velocidades del 6510
en una PAL, NTSC, Drean respectivamente (<span class="docutils literal">0.985248</span> Mhz, <span class="docutils literal">1.022727</span>
Mhz, <span class="docutils literal">1.023440</span> Mhz). Como ven, la más rápida de todas es la Drean, y
la más lenta es la PAL.</p>
<p>Para saber la velocidad del timer, hay que fijarse en el código del sid
y ver si modifica los valores del timer CIA. Por ejemplo, si ven algo
así:</p>
<pre class="code asm literal-block"><code><span class="name function">ldx</span> <span class="comment">#$c7            ; store $4cc7 in Timer A - CIA 1
</span><span class="name constant">ldy</span> <span class="comment">#$4c            ; $4cc7 is on tick per refresh in PAL
</span><span class="name constant">stx</span> <span class="name constant">$dc04</span>           <span class="comment">; Timer A lo
</span><span class="name constant">sty</span> <span class="name constant">$dc05</span>           <span class="comment">; Timer A hi</span></code></pre>
<p>Si el sid esta usando <span class="docutils literal">$4cc7</span> en el timer (un 'tick' por refresco de
pantalla en PAL), entonces el nuevo valor del timer será:</p>
<ul class="simple">
<li><p><span class="docutils literal">($4cc7 + 1) * 1022727 / 985248 - 1 = $4fb2</span></p></li>
</ul>
<p>El <span class="docutils literal">+1</span> es porque el timer espera &quot;cantidad de ciclos - 1&quot;.</p>
<pre class="code asm literal-block"><code><span class="name function">ldx</span> <span class="comment">#$b2            ; store $4fb2 in Timer A - CIA 1
</span><span class="name constant">ldy</span> <span class="comment">#$4f            ; $4fb2 sets correct speed for NTSC
</span><span class="name constant">stx</span> <span class="name constant">$dc04</span>           <span class="comment">; Timer A lo
</span><span class="name constant">sty</span> <span class="name constant">$dc05</span>           <span class="comment">; Timer A hi</span></code></pre>
<p>Y el valor para Drean es: <span class="docutils literal">$4fc1</span></p>
<p>Como ven las velocidades de Drean y NTSC son muy parecidas. De hecho las
tablas de frecuencias son muy parecidas entre sí también.</p>
<p>En el caso del Player, y dado que no teníamos memoria libre, Drean y
NTSC usan las mismas tabla de frecuencias.</p>
</div>
<div class="section" id="detectando-entre-pal-ntsc-y-drean">
<h2><a class="toc-backref" href="#id26">Detectando entre PAL, NTSC y Drean</a></h2>
<p>La otra cosa importante es como detectar si una máquina es Drean, NTSC o
PAL.</p>
<p>El truquito es el siguiente. Cada una de estas máquinas tiene un
resolución de pantalla diferente:</p>
<ul class="simple">
<li><p>PAL: 312 x 63</p></li>
<li><p>NTSC: 263 x 65</p></li>
<li><p>Drean: 312 x 65</p></li>
</ul>
<p>Eso esta medido en ciclos de CPU. En una PAL, refrescar toda la pantalla
se tardan 312 x 63 = 19,656 ($4cc8) ciclos. ¿Les suena el número
<span class="docutils literal">$4cc8</span>?. Es el que usamos en el timer para tocar la música a
velocidad PAL (<span class="docutils literal">$4cc8 - 1</span>, ya que en los timers hay que restar 1 al
valor que uno quiere). Eso significa que si yo pongo un timer a
<span class="docutils literal">$4cc7</span>, en una PAL va a llamarse una vez por refresco de pantalla.</p>
<p>La otra cosa a saber, es que uno puede saber en que rasterline se
encuentra el raster. Por las dudas, el raster es el haz de luz que barre
la pantalla de izquierda a derecha, de arriba hacia abajo.</p>
<p>Uniendo estas dos cosas, uno puede saber si la máquina es PAL, Drean o
NTSC.</p>
<p>El truquito es así:</p>
<ul class="simple">
<li><p>Espero a que el raster este en la linea 0 (hay que leer <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic18.htm">$d012</a>)</p></li>
<li><p>Una vez que esta ahí, disparo el timer CIA con <span class="docutils literal">$4cc7</span></p></li>
<li><p>Cuando el timer me llame, habrá dado justo una vuelta entera y <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/vic18.htm">$d012</a>
valdrá 0. Al menos en PAL</p></li>
</ul>
<p>¿Pero que valor debería tener para una NTSC?</p>
<p>La NTSC tiene una resolución de 263 * 65. O sea, 17095 ciclos se
necesitan para recorrerla entera. Si el timer esta seteado para 19656
ciclos, entonces hay un &quot;overflow&quot; de:</p>
<ul class="simple">
<li><p>19656 - 17095 = 2561 ciclos</p></li>
</ul>
<p>Y como el NTSC tiene 65 ciclos por linea, si divido ese valor por 65, me
da:</p>
<ul class="simple">
<li><p>2561 ciclos / 65 ciclos = 39.4.</p></li>
</ul>
<p>O sea, que el raster, luego de 19656 ciclos, habrá dado una vuelta
entera y estará en el rasterline 39. Y una cuenta similar hay que hacer
para Drean (ejercicio para el lector).</p>
<p>El código que lo detecta PAL/NTSC/Drean es el siguiente:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; char ut_detect_pal_paln_ntsc(void)
;------------------------------------------------------------------------------;
; Cuenta cuantas rasterlines se dibujan en 312*63 (19656) ciclos
; 312*63-1 es usado en el Timer del CIA, porque es lo que espero el Timer (uno menos)
;
; En PAL,      (312 * 63)  19656/63 = 312  -&gt; 312 % 312   (00, $00)
; En PAL-N,    (312 * 65)  19656/65 = 302  -&gt; 302 % 312   (46, $2e)
; En NTSC,     (263 * 65)  19656/65 = 302  -&gt; 302 % 263   (39, $27)
; En NTSC Old, (262 * 64)  19656/64 = 307  -&gt; 307 % 262   (45, $2d)
;
; Return values:
;   $01 --&gt; PAL
;   $2F --&gt; PAL-N (Drean)
;   $28 --&gt; NTSC
;   $2e --&gt; NTSC-OLD
;
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span>
<span class="name label">ut_detect_pal_paln_ntsc:</span>
        <span class="name function">sei</span>                             <span class="comment">; inhabilitar interrupciones
</span>
        <span class="name function">lda</span> <span class="comment">#0
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>                       <span class="comment">; apagar pantalla para inhabilitar badlines
</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">$d012</span>                       <span class="comment">; esperar a que el raster llegue a la rasterline 0 (más estable)
</span><span class="punctuation">:</span>       <span class="name constant">cmp</span> <span class="name constant">$d012</span>
        <span class="name function">beq</span> <span class="punctuation">:-</span>
        <span class="name function">bmi</span> <span class="punctuation">:--</span>

        <span class="name function">lda</span> <span class="comment">#$00
</span>        <span class="name constant">sta</span> <span class="name constant">$dc0e</span>                       <span class="comment">; parar Timer A
</span>
        <span class="name function">lda</span> <span class="comment">#$00
</span>        <span class="name constant">sta</span> <span class="name constant">$d01a</span>                       <span class="comment">; inhabilitar raster IRQ
</span>        <span class="name constant">lda</span> <span class="comment">#$7f
</span>        <span class="name constant">sta</span> <span class="name constant">$dc0d</span>                       <span class="comment">; inhabilitar Timer en CIA 1
</span>        <span class="name constant">sta</span> <span class="name constant">$dd0d</span>                       <span class="comment">; y CIA 2
</span>

        <span class="name function">lda</span> <span class="comment">#$00
</span>        <span class="name constant">sta</span> <span class="name constant">sync</span>

        <span class="name function">ldx</span> <span class="comment">#&lt;(312*63-1)                ; poner timer para PAL
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;(312*63-1)
</span>        <span class="name constant">stx</span> <span class="name constant">$dc04</span>                       <span class="comment">; Timer A lo
</span>        <span class="name constant">sty</span> <span class="name constant">$dc05</span>                       <span class="comment">; Timer A hi
</span>
        <span class="name function">lda</span> <span class="comment">#%00001001                  ; one-shot
</span>        <span class="name constant">sta</span> <span class="name constant">$dc0e</span>

        <span class="name function">ldx</span> <span class="comment">#&lt;timer_irq
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;timer_irq
</span>        <span class="name constant">stx</span> <span class="name constant">$fffe</span>                       <span class="comment">; como el BASIC/KERNAL están apagados
</span>        <span class="name constant">sty</span> <span class="name constant">$ffff</span>                       <span class="comment">; se usa $fffe/$ffff en vez de $0314/$0315
</span>
        <span class="name function">asl</span> <span class="name constant">$d019</span>                       <span class="comment">; ACK interrupción de raster
</span>        <span class="name constant">lda</span> <span class="name constant">$dc0d</span>                       <span class="comment">; ACK interrupción Timer en CIA 1
</span>        <span class="name constant">lda</span> <span class="name constant">$dd0d</span>                       <span class="comment">; y CIA 2
</span>
        <span class="name function">lda</span> <span class="comment">#$81
</span>        <span class="name constant">sta</span> <span class="name constant">$dc0d</span>                       <span class="comment">; habilitar interrupción timer A
</span>        <span class="name constant">cli</span>                             <span class="comment">; CIA 1
</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">sync</span>
        <span class="name function">beq</span> <span class="punctuation">:-</span>

        <span class="name function">lda</span> <span class="comment">#$1b                        ; habilitar pantalla otra vez
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>
        <span class="name function">lda</span> <span class="name constant">ZP_VIC_VIDEO_TYPE</span>           <span class="comment">; valor de retorno
</span>        <span class="name constant">rts</span>

<span class="name label">timer_irq:</span>
        <span class="name function">pha</span>                             <span class="comment">; guardar &quot;A&quot;
</span>
        <span class="name function">lda</span> <span class="name constant">$dc0d</span>                       <span class="comment">; ACK interrupción de Timer
</span>
        <span class="name function">lda</span> <span class="name constant">$d012</span>
        <span class="name function">sta</span> <span class="name constant">ZP_VIC_VIDEO_TYPE</span>

        <span class="name function">inc</span> <span class="name constant">sync</span>
        <span class="name function">cli</span>

        <span class="name function">pla</span>                             <span class="comment">; restaurar &quot;A&quot;
</span>        <span class="name constant">rti</span>                             <span class="comment">; restaurar &quot;PC&quot; y &quot;Status&quot;
</span>
<span class="name label">sync:</span>  <span class="name attribute">.byte</span> <span class="name constant">$00</span></code></pre>
<p>Con esto ya deberíamos poder tocar sids en cualquier máquina de manera
correcta.</p>
</div>
<div class="section" id="actualizar-nombre-de-cancion-autor">
<h2><a class="toc-backref" href="#id27">Actualizar nombre de canción / autor</a></h2>
<p>Quizás la parte las tediosa de todo el Player es actualizar los
nombres de la canción y autor. Veamos porque:</p>
<p>El modo bitmap funciona por celdas. La pantalla esta dividida en:</p>
<ul class="simple">
<li><p>40 x 25 celdas</p></li>
<li><p>Cada celda es de 8x8 pixels (8 bytes)</p></li>
<li><p>Cada celda no puede tener más de 2 colores</p></li>
</ul>
<div class="figure">
<img alt="cells" src="https://lh3.googleusercontent.com/W9abCQZfIhLIFlxyodyd5BhMr0JioeCj9SSTgwhjkqfB0KH1J8PEta4SsS_tq7w8GiEXaOY0WFuobe1ngDv3vBwjgLs3MJMa5cpFkBjdFfbnC8AP6umui1-s8R0H8urtX1WG7_c" />
<p class="caption"><em>En modo Bitmap Standard las celdas no pueden tener más de 2 colores a la vez</em></p>
</div>
<p>El gráfico en total usa 16 colores. Pero si prestan atención, cada celda
no tiene más de 2 colores a la vez. Esto modo gráfico existe para
ahorrar memoria. Por ejemplo, si uno pudiera elegir 16 colores (4 bits)
por pixel, entonces el gráfico ocuparía:</p>
<ul class="simple">
<li><p>(320 * 200 * 4 bits) / 8 = 32000 bytes.</p></li>
</ul>
<p>Algo muy caro para una computadora de 64k RAM. Sumado además a que el
VIC no puede ver más de 16k a al vez. Sumado a que en si uno usa
BASIC solo tiene 38k libres. O sea, este modo gráfico no existe en la
C64.</p>
<p>Al usar celdas, el color de &quot;foreground&quot; y &quot;background&quot; se almacena en
un buffer de 40 x 25. Cada byte representa el color de la celda: los 4
bits altos son &quot;foreground&quot;, y los 4 bits bajos, son el &quot;background&quot;. De
esta manera, una gráfico bitmap + color ocupa:</p>
<ul class="simple">
<li><p>((320 * 200 * 1 bit) / 8) + (40 * 25) = 9000 bytes.</p></li>
</ul>
<p>Y 9000 bytes es algo aceptable para una máquina de 64k RAM.</p>
<p>Para prender un pixel en x,y y ponerle color se hace esto:</p>
<pre class="code c literal-block"><code><span class="comment single">// pseudo código
</span><span class="keyword type">void</span> <span class="name function">set_pixel</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">x</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">y</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
        <span class="comment single">// x va de 0 a 319
</span>        <span class="comment single">// y va de 0 a 199
</span>
        <span class="comment single">// conseguir la celda correspondiente
</span>        <span class="keyword type">int</span> <span class="name">cell_offset</span> <span class="operator">=</span> <span class="literal number integer">40</span> <span class="operator">*</span> <span class="punctuation">(</span><span class="name">y</span> <span class="operator">/</span> <span class="literal number integer">8</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="punctuation">(</span><span class="name">x</span> <span class="operator">/</span> <span class="literal number integer">8</span><span class="punctuation">);</span>

        <span class="comment single">// dentro de esa celda, buscar el byte correspondiente
</span>        <span class="keyword type">int</span> <span class="name">byte_offset</span> <span class="operator">=</span> <span class="name">y</span> <span class="operator">%</span> <span class="literal number integer">8</span><span class="punctuation">;</span>

        <span class="comment single">// dentro de ese byte, buscar el bit correspondiente
</span>        <span class="keyword type">int</span> <span class="name">bit_offset</span> <span class="operator">=</span> <span class="name">x</span> <span class="operator">%</span> <span class="literal number integer">8</span><span class="punctuation">;</span>

        <span class="name">bitmap</span><span class="punctuation">[</span><span class="name">cell_offset</span> <span class="operator">+</span> <span class="name">byte_offset</span><span class="punctuation">]</span> <span class="operator">|=</span> <span class="name">bit_offset</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">set_cell_color</span><span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">x</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">y</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">foreground</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">background</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
        <span class="comment single">// x va de 0 a 39
</span>        <span class="comment single">// y va de 0 a 24
</span>
        <span class="name">offset</span> <span class="operator">=</span> <span class="name">y</span> <span class="operator">*</span> <span class="literal number integer">40</span> <span class="operator">+</span> <span class="name">x</span><span class="punctuation">;</span>
        <span class="name">color</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="name">foreground</span> <span class="operator">&lt;&lt;</span> <span class="literal number integer">4</span> <span class="operator">|</span> <span class="name">background</span><span class="punctuation">);</span>

        <span class="name">screen_ram</span><span class="punctuation">[</span><span class="name">offset</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">color</span><span class="punctuation">;</span>
<span class="punctuation">}</span></code></pre>
<p>Ahora que sabemos prender (y apagar) un pixel, lo que tenemos que hacer
es que las letras se dibujen en &quot;diagonal&quot;. Si vemos el gráfico
nuevamente vemos que tiene una inclinación de:</p>
<ul class="simple">
<li><p>vertical: de 1 x 1. recta: <span class="docutils literal">Y = <span class="pre">-X</span></span>. Pendiente de -1</p></li>
<li><p>horizontal: de 2 x 1. recta: <span class="docutils literal">Y = X/2</span>. Pendiente de 0.5</p></li>
</ul>
<div class="figure">
<img alt="inclinación" src="https://lh3.googleusercontent.com/TpaSLAM6xyEgB80FWG8R8QsEKmNvBfuTrYpy8bwkECpVF4dtFZs3NqCkKw98dC-PzjtZMu3-ZKEC5Fs3wsyI1aatB9z0r5MyStkOsJOU0gj2SNlNIld4ztQdSXXq6SipWNktL2k" />
<p class="caption"><em>Inclinación que se quiere buscar</em></p>
</div>
<p>Básicamente, lo que queremos lograr es algo así:</p>
<div class="figure">
<img alt="resultado" src="https://lh3.googleusercontent.com/j-TXraycC52OgY3wO-9OTl2wf6X0q1F3jmr5ygvRwJ-NFfd99OicecuzuUa1viUYF3nWsCighJtpFf0QXqXyTpcNY0HWgakFwZ43-jjrcvfx5UYty7IL4T-hMvk6cjprPMxf5LU" />
<p class="caption"><em>Ejemplo de como tiene que ser la inclinación de las letras</em></p>
</div>
<p>El algoritmo a dibujar las letras sería algo así:</p>
<pre class="code c literal-block"><code><span class="comment single">//pseudo code
</span><span class="keyword type">void</span> <span class="name function">plot_name</span><span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span> <span class="name">name</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">int</span> <span class="name">offset_pixel_x</span> <span class="operator">=</span> <span class="literal number integer">14</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>    <span class="comment single">// empezar desde la celda 14 horizontal
</span>    <span class="keyword type">int</span> <span class="name">offset_pixel_y</span> <span class="operator">=</span> <span class="literal number integer">3</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>     <span class="comment single">// empezar desde la celda 3 vertical
</span>
    <span class="keyword type">int</span> <span class="name">l</span> <span class="operator">=</span> <span class="name">strlen</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">);</span>
    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">i</span><span class="operator">&lt;</span><span class="name">l</span><span class="punctuation">;</span> <span class="operator">++</span><span class="name">i</span><span class="punctuation">)</span>
    <span class="punctuation">{</span>
        <span class="name">plot_char</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">],</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">y</span><span class="punctuation">);</span>
        <span class="name">x</span> <span class="operator">+=</span> <span class="literal number integer">8</span><span class="punctuation">;</span>                     <span class="comment single">// siguiente char empieza: 8 pixels a la derecha
</span>        <span class="name">y</span> <span class="operator">+=</span> <span class="literal number integer">4</span><span class="punctuation">;</span>                     <span class="comment single">// y 4 pixels más abajo
</span>    <span class="punctuation">}</span>
<span class="punctuation">}</span></code></pre>
<p>Pero lo difícil es implementar <span class="docutils literal">plot_char()</span>. Si no tuviésemos que
inclinar el char, la solución sería más o menos así:</p>
<pre class="code c literal-block"><code><span class="comment single">// pseudo code
</span><span class="keyword type">void</span> <span class="name function">plot_char_normal</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_x</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_y</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">char</span><span class="operator">*</span> <span class="name">char_data</span> <span class="operator">=</span> <span class="name">charset</span><span class="punctuation">[</span><span class="name">c</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">];</span>   <span class="comment single">// cada char ocupa 8 bytes.
</span>
    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">y</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">++</span><span class="punctuation">)</span>
    <span class="punctuation">{</span>
        <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">x</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">++</span><span class="punctuation">)</span>
        <span class="punctuation">{</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="name">y</span><span class="punctuation">]</span> <span class="operator">&amp;</span> <span class="punctuation">(</span><span class="literal number integer">1</span> <span class="operator">&lt;&lt;</span> <span class="punctuation">(</span><span class="literal number integer">7</span><span class="operator">-</span><span class="name">x</span><span class="punctuation">))</span>
                <span class="name">set_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span><span class="punctuation">);</span>
            <span class="keyword">else</span>
                <span class="name">clear_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span><span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span></code></pre>
<p>Pero lo que queremos hacer es imprimirlo inclinado. La solución es
similar, pero cada tanto tenemos que bajar e ir a la izquierda:</p>
<pre class="code c literal-block"><code><span class="comment single">// pseudo code
</span><span class="keyword type">void</span> <span class="name function">plot_char_inclinado</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_x</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_y</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">char</span><span class="operator">*</span> <span class="name">char_data</span> <span class="operator">=</span> <span class="name">charset</span><span class="punctuation">[</span><span class="name">c</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">];</span>   <span class="comment single">// cada char ocupa 8 bytes.
</span>
    <span class="comment single">// fix_x/fix_y son las que van a dar el efecto de inclinación
</span>    <span class="keyword type">int</span> <span class="name">fix_x</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>
    <span class="keyword type">int</span> <span class="name">fix_y</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>

    <span class="comment single">// iterar por sobre todos los pixels del char
</span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">y</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">++</span><span class="punctuation">)</span>
    <span class="punctuation">{</span>
        <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">x</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">++</span><span class="punctuation">)</span>
        <span class="punctuation">{</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="name">y</span><span class="punctuation">]</span> <span class="operator">&amp;</span> <span class="punctuation">(</span><span class="literal number integer">1</span> <span class="operator">&lt;&lt;</span> <span class="punctuation">(</span><span class="literal number integer">7</span><span class="operator">-</span><span class="name">x</span><span class="punctuation">))</span>
                <span class="name">set_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span> <span class="operator">+</span> <span class="name">fix_x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span> <span class="operator">+</span> <span class="name">fix_y</span><span class="punctuation">);</span>
            <span class="keyword">else</span>
                <span class="name">clear_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span> <span class="operator">+</span> <span class="name">fix_x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span> <span class="operator">+</span> <span class="name">fix_y</span><span class="punctuation">);</span>

            <span class="comment single">// bajar un pixel (Y) por cada dos pixels horizontales (X)
</span>            <span class="name">fix_y</span> <span class="operator">=</span> <span class="name">x</span><span class="operator">/</span><span class="literal number integer">2</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="comment single">// la siguiente fila tiene que empezar un pixel a la izquierda
</span>        <span class="name">fix_x</span><span class="operator">--</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span></code></pre>
<p>Con ese algoritmo podemos imprimir cosas de este estilo:</p>
<div class="figure">
<img alt="inclinada\_fat" src="https://lh3.googleusercontent.com/_egTNJbWjoF0tImd_bbporzfdvE9Vp74q3gIM2ezwOWU4GRYUeLZzWeGJMk6vM4vPHnGC_Tqqtxmiz5HQMHSBRoiAtADyQtZyapK1bQFKFCJA1nl2iIoChVXAujdJ6LSvSq5AHg" />
<p class="caption"><em>Las letras tienen pixeles vacíos en el medio</em></p>
</div>
<p>Pero <strong>no</strong> es lo que queremos ya que:</p>
<ul class="simple">
<li><p>Ocupa mucho lugar de pantalla, no van a entrar los nombres de las
canciones</p></li>
<li><p>Hay pixeles vacíos en el medio de las letras, no se ve prolijo</p></li>
</ul>
<p>¿Y por qué hay pixeles vacíos? La respuesta esta en ver esta rotación:</p>
<div class="figure">
<img alt="rotado" src="https://lh3.googleusercontent.com/K4ylCjj6GgzdI9DEhTjikkcc14C_bnQEHCBk1OvXtOh3ReUK28f0vTnyGnyu6Q1x67mLLNw5qUuec_CtAWUztv-5wFeDvf7LKpq2-KDqtn_qw93OUAQmhNGKJU0pKg8QpQc6N-U" />
<p class="caption"><em>El porqué de los pixeles vacíos</em></p>
</div>
<p>El algoritmo hace lo que le dijimos que haga, pero no es lo que
queremos. Lo primero a hacer, es usar fonts de 4x8 (y no de 8x8) para
que no ocupe tanto espacio de pantalla. Lo segundo es arreglar los
pixeles vacíos.</p>
<p>Una posible solución para evitar los pixeles vacíos es que el algoritmo
incline los chars de manera horizontal, y no vertical. Algo así como
esto:</p>
<div class="figure">
<img alt="rotado2" src="https://lh3.googleusercontent.com/gcnEulu7AuMlM2TmwusHLe5-iS3UqUVeTJnHFhKT9d_9JjqdCG7_nFijuyWpQKHzGVeTGfXlbbF-mOi_Y-TRxyuTs1H-xy-BUqfz55rMitmiSJApwRI5M_BTRTzDR47oRk1_iw8" />
<p class="caption"><em>Alternativa para evitar los pixeles vacíos</em></p>
</div>
<p>Y cuatro letras se verían así:</p>
<div class="figure">
<img alt="rotado3" src="https://lh3.googleusercontent.com/ViP4RjGdqlvh1B55Q4laIg2S95S6DivApYRuGMOKpK3LnukRebGh410rSkSc5hLb12fu24FMeHuDILaAozN-UK7WX6QgCGqFZZXcKAQ6rC2idlGnCbqJY4Sr9_MPiUCWKScE4Q0" />
<p class="caption"><em>Los pixeles vacíos estan al final de cada letra</em></p>
</div>
<p>Lo que estamos haciendo, es que los pixeles vacíos estén como
&quot;separadores&quot; de los caracteres, y no en el medio de cada caracter. Con
esto en mente, el nuevo algoritmo es así:</p>
<pre class="code c literal-block"><code><span class="comment single">// pseudo code
</span><span class="keyword type">void</span> <span class="name function">plot_name</span><span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span> <span class="name">name</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">int</span> <span class="name">offset_pixel_x</span> <span class="operator">=</span> <span class="literal number integer">14</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>    <span class="comment single">// empezar desde la celda 14 horizontal
</span>    <span class="keyword type">int</span> <span class="name">offset_pixel_y</span> <span class="operator">=</span> <span class="literal number integer">3</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>     <span class="comment single">// empezar desde la celda 3 vertical
</span>
    <span class="keyword type">int</span> <span class="name">l</span> <span class="operator">=</span> <span class="name">strlen</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">);</span>
    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">i</span><span class="operator">&lt;</span><span class="name">l</span><span class="punctuation">;</span> <span class="operator">++</span><span class="name">i</span><span class="punctuation">)</span>
    <span class="punctuation">{</span>
        <span class="name">plot_char_semi_inclinado</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">],</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">y</span><span class="punctuation">);</span>
        <span class="name">x</span> <span class="operator">+=</span> <span class="literal number integer">4</span><span class="punctuation">;</span>                     <span class="comment single">// siguiente char empieza: 4 pixels a la derecha
</span>        <span class="name">y</span> <span class="operator">+=</span> <span class="literal number integer">2</span><span class="punctuation">;</span>                     <span class="comment single">// y 2 pixels más abajo
</span>    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">plot_char_semi_inclinado</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_x</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_y</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">char</span><span class="operator">*</span> <span class="name">char_data</span> <span class="operator">=</span> <span class="name">charset</span><span class="punctuation">[</span><span class="name">c</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">];</span>   <span class="comment single">// cada char ocupa 8 bytes.
</span>
    <span class="comment single">// fix_x da efecto de inclinación en X
</span>    <span class="keyword type">int</span> <span class="name">fix_x</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>

    <span class="comment single">// iterar por sobre todos los pixels del char
</span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">y</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">++</span><span class="punctuation">)</span>
    <span class="punctuation">{</span>
        <span class="comment single">// de 0 a 4, ya que el char ahora ocupa la mitad
</span>        <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">x</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">&lt;</span><span class="literal number integer">4</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">++</span><span class="punctuation">)</span>
        <span class="punctuation">{</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="name">y</span><span class="punctuation">]</span> <span class="operator">&amp;</span> <span class="punctuation">(</span><span class="literal number integer">1</span> <span class="operator">&lt;&lt;</span> <span class="punctuation">(</span><span class="literal number integer">7</span><span class="operator">-</span><span class="name">x</span><span class="punctuation">))</span>
                <span class="name">set_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span> <span class="operator">+</span> <span class="name">fix_x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span><span class="punctuation">);</span>
            <span class="keyword">else</span>
                <span class="name">clear_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span> <span class="operator">+</span> <span class="name">fix_x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span><span class="punctuation">);</span>
        <span class="punctuation">}</span>
        <span class="comment single">// la siguiente fila tiene que empezar un pixel a la izquierda
</span>        <span class="name">fix_x</span><span class="operator">--</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span></code></pre>
<p>Lo que hay que hacer ahora, es tener un charset <a class="footnote-reference brackets" href="#id9" id="id3">3</a> que cuando se incline
solo horizontalmente, se vea como queremos. Por ejemplo, un charset como
este:</p>
<div class="figure">
<img alt="charset" src="https://lh3.googleusercontent.com/bEDUkJFBU44Uc6vjfmyCPDHVO3jrSTvW0SQzBSoYsQkwuZ7Q1ij8Gl0K6SBfm0LyD8yg6ZaEHsOsJqAgpd2g0CUZUZ1Wvowg72MaX9JjW7GZ058yNLQrtgURQ7NyFOe7RhYbwmI" />
<p class="caption"><em>Charset completo con letras listas para ser inclinadas</em></p>
</div>
<p>Y así se ven algunas de las letras inclinadas:</p>
<div class="figure">
<img alt="charset\_rotado" src="https://lh3.googleusercontent.com/K2eFlXjp7iAn72AjmoREX7GsKBPSxmnSi6s02-fFhtfw0JZhdNG1EnyGPJG_KEYPS6T5pBR3ZhmEaeTsH-7dyogYnlm-J7oFN6gjcYB9k_VeY0UJs8Yy0cES7uGD_NMaLhMFTxk" />
<p class="caption"><em>Ejemplo de como se ven 'a', 'b', 'c' y 'd'</em></p>
</div>
<p>Pero aún queda por solucionar las letras anchas como <span class="docutils literal">m</span>, <span class="docutils literal">M</span>, <span class="docutils literal">W</span>
y <span class="docutils literal">w</span>. Eso se soluciona usando dos chars para esas letras y haciendo
que las letras ocupen 8x8 y no 4x8. Sería así:</p>
<div class="figure">
<img alt="m\_rotada" src="https://lh3.googleusercontent.com/5fnDgzMLnIjb6wNdSE-WdqTxR1lvl42si2gr57JpF_fXMd5J7g0SrG6yuCjTV9TLjMq-gJOvHk4kTEIIPvhGVzybZgPbSUz9PtkdIty4QYurb_gF6rGc40XLvrDFzeZJlAuP1Wc" />
<p class="caption"><em>Componiendo la M</em></p>
</div>
<p>Entonces, el algoritmo final es:</p>
<ul class="simple">
<li><p>Se usa un charset de 8x8. Pero la mayoría de las letras son de 4x8.
La parte derecha de la mayoría de las letras esta vacía</p></li>
<li><p>Se copian los 8x8 pixels de las letras usando el algoritmo de
<span class="docutils literal">semi_inclinación</span></p></li>
<li><p>Ciertas letras como la <span class="docutils literal">m</span> y <span class="docutils literal">w</span> van a usar dos caracteres. Ej:
<span class="docutils literal">mama</span> es escrito como <span class="docutils literal">m&amp;am&amp;a</span>, ya que el char <span class="docutils literal">&amp;</span> tendrá la
parte que le falta a la <span class="docutils literal">m</span></p></li>
</ul>
<p>Entonces, el código queda bastante sencillo, lo cual es bueno (menos
bugs), pero se pone más esfuerzo en la data. Pero es 10 veces mejor
tener código sencillo y data compleja, que al revés.</p>
<p>Algoritmo final para imprimir la letras inclinadas:</p>
<pre class="code c literal-block"><code><span class="comment single">// pseudo code
</span><span class="keyword type">void</span> <span class="name function">plot_name</span><span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span> <span class="name">name</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">int</span> <span class="name">offset_pixel_x</span> <span class="operator">=</span> <span class="literal number integer">14</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>    <span class="comment single">// empezar desde la celda 14 horizontal
</span>    <span class="keyword type">int</span> <span class="name">offset_pixel_y</span> <span class="operator">=</span> <span class="literal number integer">3</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>     <span class="comment single">// empezar desde la celda 3 vertical
</span>
    <span class="keyword type">int</span> <span class="name">l</span> <span class="operator">=</span> <span class="name">strlen</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">);</span>
    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">i</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">i</span><span class="operator">&lt;</span><span class="name">l</span><span class="punctuation">;</span> <span class="operator">++</span><span class="name">i</span><span class="punctuation">)</span>
    <span class="punctuation">{</span>
        <span class="name">plot_char_semi_inclinado</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">[</span><span class="name">i</span><span class="punctuation">],</span> <span class="name">x</span><span class="punctuation">,</span> <span class="name">y</span><span class="punctuation">);</span>
        <span class="name">x</span> <span class="operator">+=</span> <span class="literal number integer">4</span><span class="punctuation">;</span>                     <span class="comment single">// siguiente char empieza: 4 pixels a la derecha
</span>        <span class="name">y</span> <span class="operator">+=</span> <span class="literal number integer">2</span><span class="punctuation">;</span>                     <span class="comment single">// y 2 pixels más abajo
</span>    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">plot_char_semi_inclinado</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_x</span><span class="punctuation">,</span> <span class="keyword type">int</span> <span class="name">offset_y</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">char</span><span class="operator">*</span> <span class="name">char_data</span> <span class="operator">=</span> <span class="name">charset</span><span class="punctuation">[</span><span class="name">c</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">];</span>   <span class="comment single">// cada char ocupa 8 bytes.
</span>
    <span class="comment single">// fix_x da efecto de inclinación en X
</span>    <span class="keyword type">int</span> <span class="name">fix_x</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>

    <span class="comment single">// iterar por sobre todos los pixels del char
</span>    <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">y</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="punctuation">;</span> <span class="name">y</span><span class="operator">++</span><span class="punctuation">)</span>
    <span class="punctuation">{</span>
        <span class="comment single">// de 0 a 8. Se copia el char entero
</span>        <span class="keyword">for</span> <span class="punctuation">(</span><span class="keyword type">int</span> <span class="name">x</span><span class="operator">=</span><span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">&lt;</span><span class="literal number integer">8</span><span class="punctuation">;</span> <span class="name">x</span><span class="operator">++</span><span class="punctuation">)</span>
        <span class="punctuation">{</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="name">y</span><span class="punctuation">]</span> <span class="operator">&amp;</span> <span class="punctuation">(</span><span class="literal number integer">1</span> <span class="operator">&lt;&lt;</span> <span class="punctuation">(</span><span class="literal number integer">7</span><span class="operator">-</span><span class="name">x</span><span class="punctuation">))</span>
                <span class="name">set_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span> <span class="operator">+</span> <span class="name">fix_x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span><span class="punctuation">);</span>
            <span class="keyword">else</span>
                <span class="name">clear_pixel</span><span class="punctuation">(</span><span class="name">offset_x</span> <span class="operator">+</span> <span class="name">x</span> <span class="operator">+</span> <span class="name">fix_x</span><span class="punctuation">,</span> <span class="name">offset_y</span> <span class="operator">+</span> <span class="name">y</span><span class="punctuation">);</span>
        <span class="punctuation">}</span>
        <span class="comment single">// la siguiente fila tiene que empezar un pixel a la izquierda
</span>        <span class="name">fix_x</span><span class="operator">--</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span></code></pre>
<div class="section" id="version-optimizada">
<h3>Versión Optimizada</h3>
<p>El algoritmo anterior funciona bien, pero el problema es que usa mucho
las multiplicaciones en <span class="docutils literal">set_pixel()</span> <a class="footnote-reference brackets" href="#id10" id="id4">4</a>, y recordemos que el 6510
no tiene instrucciones de multiplicación.</p>
<p>Entonces el Player usa una versión un tanto más complicada para mejorar la
performance. Tiene en cuenta lo siguiente:</p>
<ul class="simple">
<li><p>Los caracteres solo pueden empezar en los siguientes offsets
relativos a las celdas: (0,0), (4,2), (0,4), (4,6)</p></li>
<li><p>Un caracter necesita dos celdas para imprimirse. Y estas celdas son
contiguas.</p></li>
<li><p>El siguiente caracter a imprimir estará, como mucho, a una celda de
distancia tanto en X como en Y</p></li>
<li><p>Hay funciones especificas para dibujar los posibles 4 offsets
<span class="docutils literal">plot_char_0()</span>, ..., <span class="docutils literal">plot_char_3()</span></p></li>
<li><p>Hay funciones especificas para dibujar cada una de las 8 filas:
<span class="docutils literal">plot_row_0()</span>, ..., <span class="docutils literal">plot_row_7()</span></p></li>
<li><p>Hay tres punteros globales:</p>
<ul>
<li><p><span class="docutils literal"><span class="pre">$f6/$f6</span></span> offset del charset que apunta al caracter a imprimir</p></li>
<li><p><span class="docutils literal">$f8/f9</span>, y <span class="docutils literal"><span class="pre">$fa/$fb</span></span> que apuntan a la celda actual, y a la
siguiente celda del bitmap</p></li>
</ul>
</li>
</ul>
<p>Con eso en mente, no hace falta calcular el offset de los pixeles por
cada pixel y eso ahorra CPU ya que no hay multiplicaciones de por medio.
Aunque agrega complejidad.</p>
<p>Así es como funciona el algoritmo optimizado (pseudo código):</p>
<pre class="code c literal-block"><code><span class="comment single">// pseudo código
</span>
<span class="comment single">// global: apunta al principio del bitmap
</span><span class="comment preproc">#define ORIGIN_CELL_X = 14;
#define ORIGIN_CELL_Y = 3;
</span>
<span class="comment single">// en el código en assembler, estas dos variables están representadas
// por `$f8/$f9` y `$fa/$fb`
</span><span class="keyword type">int</span> <span class="name">g_bitmap_offset_0</span><span class="punctuation">,</span> <span class="name">g_bitmap_offset_1</span><span class="punctuation">;</span>

<span class="keyword type">void</span> <span class="name function">plot_name</span><span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span> <span class="name">name</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">int</span> <span class="name">l</span> <span class="operator">=</span> <span class="name">strlen</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">);</span>
    <span class="keyword type">int</span> <span class="name">idx</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>

    <span class="comment single">// inicializar bitmap offset con el origen de la celda
</span>    <span class="name">g_bitmap_offset_0</span> <span class="operator">=</span> <span class="name">ORIGIN_CELL_Y</span> <span class="operator">*</span> <span class="literal number integer">40</span> <span class="operator">+</span> <span class="name">ORIGIN_CELL_X</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>
    <span class="name">g_bitmap_offset_1</span> <span class="operator">=</span> <span class="name">ORIGIN_CELL_Y</span> <span class="operator">*</span> <span class="literal number integer">40</span> <span class="operator">+</span> <span class="punctuation">(</span><span class="name">ORIGIN_CELL_X</span> <span class="operator">+</span> <span class="literal number integer">1</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="literal number integer">8</span><span class="punctuation">;</span>
    <span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">;</span>

    <span class="keyword">while</span> <span class="punctuation">(</span><span class="name">no_se_hayan_impreso_todos_los_chars</span><span class="punctuation">)</span> <span class="punctuation">{</span>

        <span class="name">c</span> <span class="operator">=</span> <span class="name">fetch_next_char</span><span class="punctuation">();</span>
        <span class="name">plot_char_0</span><span class="punctuation">(</span><span class="name">c</span><span class="punctuation">);</span>     <span class="comment single">// print first char (offset 0,0)
</span>
        <span class="name">c</span> <span class="operator">=</span> <span class="name">fetch_next_char</span><span class="punctuation">();</span>
        <span class="name">plot_char_1</span><span class="punctuation">(</span><span class="name">c</span><span class="punctuation">);</span>     <span class="comment single">// print second char (offset 4,2)
</span>
        <span class="name">bitmap_next_x</span><span class="punctuation">();</span>    <span class="comment single">// celda_x++ (actualiza g_bitmap_offsets)
</span>
        <span class="name">c</span> <span class="operator">=</span> <span class="name">fetch_next_char</span><span class="punctuation">();</span>
        <span class="name">plot_char_2</span><span class="punctuation">(</span><span class="name">c</span><span class="punctuation">);</span>     <span class="comment single">// print third char (offset 0,4)
</span>
        <span class="name">c</span> <span class="operator">=</span> <span class="name">fetch_next_char</span><span class="punctuation">();</span>
        <span class="name">plot_char_3</span><span class="punctuation">(</span><span class="name">c</span><span class="punctuation">);</span>     <span class="comment single">// imprime cuarto char (offset 4,6)
</span>
        <span class="name">bitmap_next_x</span><span class="punctuation">();</span>    <span class="comment single">// celda_x++ (actualiza g_bitmap_offsets)
</span>        <span class="name">bitmap_next_y</span><span class="punctuation">();</span>    <span class="comment single">// celda_y++ (actualiza g_bitmap_offsets)
</span>    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment single">// prints char at offset 0,0
</span><span class="keyword type">void</span> <span class="name function">plot_char_0</span><span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span> <span class="name">char_data</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="name">plot_row_0</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]);</span>

    <span class="name">bitmap_prev_x</span><span class="punctuation">();</span>        <span class="comment single">// celda_x-- (actualiza g_bitmap_offsets)
</span>
    <span class="name">plot_row_1</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]);</span>
    <span class="name">plot_row_2</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">]);</span>
    <span class="name">plot_row_3</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">3</span><span class="punctuation">]);</span>
    <span class="name">plot_row_4</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">4</span><span class="punctuation">]);</span>
    <span class="name">plot_row_5</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">5</span><span class="punctuation">]);</span>
    <span class="name">plot_row_6</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">6</span><span class="punctuation">]);</span>
    <span class="name">plot_row_7</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">7</span><span class="punctuation">]);</span>

    <span class="comment single">// restore pointer
</span>    <span class="name">bitmap_next_x</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment single">// prints char at offset 4,2
</span><span class="keyword type">void</span> <span class="name function">plot_char_1</span><span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span> <span class="name">char_data</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="name">plot_row_2</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]);</span>
    <span class="name">plot_row_3</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]);</span>
    <span class="name">plot_row_4</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">]);</span>
    <span class="name">plot_row_5</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">3</span><span class="punctuation">]);</span>
    <span class="name">plot_row_6</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">4</span><span class="punctuation">]);</span>

    <span class="name">bitmap_prev_x</span><span class="punctuation">();</span>        <span class="comment single">// celda_x-- (actualiza g_bitmap_offsets)
</span>
    <span class="name">plot_row_7</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">5</span><span class="punctuation">]);</span>

    <span class="name">bitmap_next_y</span><span class="punctuation">();</span>        <span class="comment single">// celda_y++ (actualiza g_bitmap_offsets)
</span>
    <span class="name">plot_row_0</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">6</span><span class="punctuation">]);</span>
    <span class="name">plot_row_1</span><span class="punctuation">(</span><span class="name">char_data</span><span class="punctuation">[</span><span class="literal number integer">7</span><span class="punctuation">]);</span>

    <span class="comment single">// restore pointers
</span>    <span class="name">bitmap_next_x</span><span class="punctuation">();</span>
    <span class="name">bitmap_prev_y</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">plot_char_2</span><span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span> <span class="name">char_data</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="comment single">// y así sucesivamente hasta el plot_char_3()
</span>    <span class="punctuation">...</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">plot_row_0</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">c</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">plot_row_1</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="name">rotate_left</span><span class="punctuation">(</span><span class="name">c</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">);</span>              <span class="comment single">// caracter es rotado un lugar a la izquierda
</span>
    <span class="comment single">// actualizo celda izquierda
</span>    <span class="keyword type">char</span> <span class="name">value_izq</span> <span class="operator">=</span> <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_0</span><span class="punctuation">];</span>
    <span class="name">value_izq</span> <span class="operator">&amp;=</span> <span class="literal number integer">0</span><span class="name">b11111110</span><span class="punctuation">;</span>        <span class="comment single">// apago el 1er bit LSB
</span>    <span class="name">value_izq</span> <span class="operator">|=</span> <span class="punctuation">(</span><span class="name">c</span> <span class="operator">&amp;</span> <span class="literal number integer">0</span><span class="name">b00000001</span><span class="punctuation">);</span>  <span class="comment single">// pongo lo que este en el 1er bit LSB del char
</span>    <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">value_izq</span><span class="punctuation">;</span>

    <span class="comment single">// actualizo celda derecha
</span>    <span class="keyword type">char</span> <span class="name">value_der</span> <span class="operator">=</span> <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_1</span><span class="punctuation">];</span>
    <span class="name">value_der</span> <span class="operator">&amp;=</span> <span class="literal number integer">0</span><span class="name">b00000001</span><span class="punctuation">;</span>        <span class="comment single">// apago los 7 primeros bit MSB
</span>    <span class="name">value_der</span> <span class="operator">|=</span> <span class="punctuation">(</span><span class="name">c</span> <span class="operator">&amp;</span> <span class="literal number integer">0</span><span class="name">b11111110</span><span class="punctuation">);</span>  <span class="comment single">// pongo lo que este en los primeros 7 bit MSB del char
</span>    <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">value_der</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">plot_row_2</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="name">rotate_left</span><span class="punctuation">(</span><span class="name">c</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">);</span>              <span class="comment single">// caracter es rotado dos lugares a la izquierda
</span>
    <span class="comment single">// actualizo celda izquierda
</span>    <span class="keyword type">char</span> <span class="name">value_izq</span> <span class="operator">=</span> <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_0</span><span class="punctuation">];</span>
    <span class="name">value_izq</span> <span class="operator">&amp;=</span> <span class="literal number integer">0</span><span class="name">b11111100</span><span class="punctuation">;</span>        <span class="comment single">// apago los dos bit LSB
</span>    <span class="name">value_izq</span> <span class="operator">|=</span> <span class="punctuation">(</span><span class="name">c</span> <span class="operator">&amp;</span> <span class="literal number integer">0</span><span class="name">b00000011</span><span class="punctuation">);</span>  <span class="comment single">// pongo lo que este en los dos bit LSB del char
</span>    <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_0</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">value_izq</span><span class="punctuation">;</span>

    <span class="comment single">// actualizo celda derecha
</span>    <span class="keyword type">char</span> <span class="name">value_der</span> <span class="operator">=</span> <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_1</span><span class="punctuation">];</span>
    <span class="name">value_der</span> <span class="operator">&amp;=</span> <span class="literal number integer">0</span><span class="name">b00000011</span><span class="punctuation">;</span>        <span class="comment single">// apago los 6 primeros bit MSB
</span>    <span class="name">value_der</span> <span class="operator">|=</span> <span class="punctuation">(</span><span class="name">c</span> <span class="operator">&amp;</span> <span class="literal number integer">0</span><span class="name">b11111100</span><span class="punctuation">);</span>  <span class="comment single">// pongo lo que este en los primeros 6 bit MSB del char
</span>    <span class="name">g_bitmap</span><span class="punctuation">[</span><span class="name">g_bitmap_offset_1</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">value_der</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">plot_row_3</span><span class="punctuation">(</span><span class="keyword type">char</span> <span class="name">c</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="comment single">// y así sucesivamente hasta el plot_row_7()
</span>    <span class="punctuation">...</span>
<span class="punctuation">}</span></code></pre>
<p>Y eso mismo (más/menos algunos cambios) es como esta hecho el Player,
pero en assembler. Con esto se logra que no se hagan multiplicaciones.</p>
<p>Para los que quieran ver el código en completo en assembler, esta acá:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/c64scene-ar/chipdisk-nac-vol.1/blob/master/src/chipdisk.s#L1313">plotter en
assembler</a></p></li>
</ul>
<p>No vale la pena ponerlo acá, salvo algunas cosas interesantes, como las
macros que se usan. Por ejemplo, en vez de repetir código una y otra
vez, el Chipisk usa las macros del ensamblador.</p>
<p>Vale la pena resaltar el <span class="docutils literal">.IDENT</span>, <span class="docutils literal">.CONCAT</span> que se usa para llamar
a la funciones correctas de acuerdo a los parámetros que se le pase a la
macro. Veamos como funciona:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; Macros
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span>
<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; entry:
;   number_of_rows: cuantas filas a imprimir
;   char_y_offset: offset del char a imprimir
;   cell_y_offset: offset de la celda Y
;   cell_x_offset: offset de la celda X. Usada para llamar a plot_row_xxx
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name attribute">.macro</span> <span class="name constant">PLOT_ROWS</span> <span class="name constant">number_of_rows</span><span class="punctuation">,</span> <span class="name constant">char_y_offset</span><span class="punctuation">,</span> <span class="name constant">cell_y_offset</span><span class="punctuation">,</span> <span class="name constant">cell_x_offset</span>
        <span class="name attribute">.repeat</span> <span class="name constant">number_of_rows</span><span class="punctuation">,</span> <span class="name constant">YY</span>
                <span class="name function">ldy</span> <span class="comment">#char_y_offset + YY
</span>                <span class="name constant">lda</span> <span class="punctuation">(</span><span class="name constant">$f6</span><span class="punctuation">),</span><span class="name constant">y</span>                 <span class="comment">; $f6 apunta a la data del charset
</span>                <span class="name constant">ldy</span> <span class="comment">#cell_y_offset + YY
</span>                <span class="name constant">jsr</span> <span class="name constant">.IDENT</span><span class="punctuation">(.</span><span class="name constant">CONCAT</span><span class="punctuation">(</span><span class="error">&quot;</span><span class="name constant">plot_row_</span><span class="error">&quot;</span><span class="punctuation">,</span> <span class="name constant">.STRING</span><span class="punctuation">(</span><span class="name constant">cell_x_offset</span> <span class="error">+</span> <span class="name constant">YY</span><span class="punctuation">)))</span>
        <span class="name attribute">.endrepeat</span>
<span class="name attribute">.endmacro</span>


<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; entry:
;       A = byte to plot
;       Y = bitmap offset
;       MUST NOT modify X
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name attribute">.macro</span> <span class="name constant">PLOT_BYTE</span> <span class="name constant">addr</span><span class="punctuation">,</span> <span class="name constant">mask</span>
<span class="name attribute">.scope</span>
        <span class="name function">and</span> <span class="comment">#mask
</span>        <span class="name constant">sta</span> <span class="name constant">ora_addr</span>
        <span class="name function">lda</span> <span class="punctuation">(</span><span class="name constant">addr</span><span class="punctuation">),</span><span class="name constant">y</span>
        <span class="name function">and</span> <span class="comment"># &lt;(.BITNOT mask)
</span><span class="name constant">ora_addr</span> <span class="error">=</span> <span class="punctuation">*</span><span class="error">+</span><span class="literal number integer">1</span>
        <span class="name function">ora</span> <span class="comment">#0                          ; self modifying
</span>        <span class="name constant">sta</span> <span class="punctuation">(</span><span class="name constant">addr</span><span class="punctuation">),</span><span class="name constant">y</span>
<span class="name attribute">.endscope</span>
<span class="name attribute">.endmacro</span>

<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; Funciones
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span>
<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; plot_char_0
; entry:
;       $f6,$f7: address of char from charset (8 bytes)
;       $f8,$f9: bitmap
;       $fa,$fb: bitmap + 8
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">plot_char_0:</span>
        <span class="name function">PLOT_ROWS</span> <span class="literal number integer">8</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">0</span>            <span class="comment">; number_of_rows, char_y_offset, cell_y_offset, cell_x_offset
</span>        <span class="name constant">rts</span>

<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; plot_char_1
; entry:
;       $f6,$f7: address of char from charset (8 bytes)
;       $f8,$f9: bitmap
;       $fa,$fb: bitmap + 8
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">plot_char_1:</span>
        <span class="name function">PLOT_ROWS</span> <span class="literal number integer">4</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">4</span>            <span class="comment">; number_of_rows, char_y_offset, cell_y_offset, cell_x_offset
</span>
        <span class="name function">jsr</span> <span class="name constant">bitmap_prev_x</span>

        <span class="name function">PLOT_ROWS</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">,</span> <span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">0</span>            <span class="comment">; number_of_rows, char_y_offset, cell_y_offset, cell_x_offset
</span>
        <span class="name function">jsr</span> <span class="name constant">bitmap_next_y</span>

        <span class="name function">PLOT_ROWS</span> <span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">6</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">2</span>            <span class="comment">; number_of_rows, char_y_offset, cell_y_offset, cell_x_offset
</span>
        <span class="name function">jsr</span> <span class="name constant">bitmap_next_x</span>               <span class="comment">; restore
</span>        <span class="name constant">jsr</span> <span class="name constant">bitmap_prev_y</span>               <span class="comment">; restore
</span>
        <span class="name function">rts</span>

<span class="name label">plot_char_2:</span>
        <span class="comment">; y así hasta el plot_char_3
</span>        <span class="name attribute">...</span>

<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; plot_row_0
; entry:
;       A = byte to plot
;       Y = bitmap offset
;       $f8,$f9: bitmap
;       $fa,$fb: bitmap + 8
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">plot_row_0:</span>
        <span class="name function">sta</span> <span class="punctuation">(</span><span class="name constant">$f8</span><span class="punctuation">),</span><span class="name constant">y</span>                 <span class="comment">; no tiene que rotar nada
</span>        <span class="name constant">rts</span>                         <span class="comment">; así que lo imprime directamente
</span>
<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; plot_row_1
; entry:
;       A = byte to plot
;       Y = bitmap offset
;       $f8,$f9: bitmap
;       $fa,$fb: bitmap + 8
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">plot_row_2:</span>
        <span class="name attribute">.repeat</span> <span class="literal number integer">1</span>                       <span class="comment">; rota el caracter 1 posición
</span>                <span class="name constant">asl</span>                     <span class="comment">; a la izquierda
</span>                <span class="name constant">adc</span> <span class="comment">#0
</span>        <span class="name constant">.endrepeat</span>

        <span class="name function">tax</span>                             <span class="comment">; save for next value
</span>        <span class="name constant">PLOT_BYTE</span> <span class="name constant">$f8</span><span class="punctuation">,</span> <span class="error">%</span><span class="literal number integer">00000001</span>

        <span class="name function">txa</span>
        <span class="name function">PLOT_BYTE</span> <span class="name constant">$fa</span><span class="punctuation">,</span> <span class="error">%</span><span class="literal number integer">11111110</span>

        <span class="name function">rts</span>

<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; plot_row_2
; entry:
;       A = byte to plot
;       Y = bitmap offset
;       $f8,$f9: bitmap
;       $fa,$fb: bitmap + 8
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">plot_row_2:</span>
        <span class="name attribute">.repeat</span> <span class="literal number integer">2</span>                       <span class="comment">; rota el caracter 2 posiciones
</span>                <span class="name constant">asl</span>                     <span class="comment">; a la izquierda
</span>                <span class="name constant">adc</span> <span class="comment">#0                  ; el &quot;adc&quot; pone a la derecha lo que salió
</span>                                        <span class="comment">; por la izquierda
</span>        <span class="name constant">.endrepeat</span>

        <span class="name function">tax</span>                             <span class="comment">; save for next value
</span>        <span class="name constant">PLOT_BYTE</span> <span class="name constant">$f8</span><span class="punctuation">,</span> <span class="error">%</span><span class="literal number integer">00000011</span>

        <span class="name function">txa</span>
        <span class="name function">PLOT_BYTE</span> <span class="name constant">$fa</span><span class="punctuation">,</span> <span class="error">%</span><span class="literal number integer">11111100</span>

        <span class="name function">rts</span>

<span class="name label">plot_row_3:</span>
        <span class="comment">; y así hasta el plot_row_7
</span>        <span class="name attribute">...</span></code></pre>
<p>Algunos truquitos que usamos:</p>
<div class="section" id="truquito-rotar-in-place">
<h4>Truquito: Rotar In-Place</h4>
<p>El truquito que usamos de rotar &quot;in-place&quot; <a class="footnote-reference brackets" href="#id11" id="id5">5</a> es simpático:</p>
<pre class="code asm literal-block"><code><span class="name function">asl</span>                     <span class="comment">; rota todo un bit a la izquierda. &quot;C&quot; tiene el valor del bit 7.
</span><span class="name constant">adc</span> <span class="comment">#0                  ; y el bit 0 tiene el valor del &quot;C&quot;</span></code></pre>
</div>
<div class="section" id="truquito-unrolled-loops">
<h4>Truquito: Unrolled-loops</h4>
<p>Los <em>unrolled loops</em> se usan mucho dentro de juegos/demos/intros que quieren
lograr velocidad (a cambio de espacio en RAM):</p>
<p>Un <em>loop</em> normal es así:</p>
<pre class="code asm literal-block"><code>        <span class="name function">lda</span> <span class="comment">#$20                ; pone un $20 de $0400 a $04ff
</span>        <span class="name constant">ldx</span> <span class="comment">#0
</span><span class="name constant">l0</span><span class="punctuation">:</span>     <span class="name constant">sta</span> <span class="name constant">$0400</span><span class="punctuation">,</span><span class="name constant">x</span>             <span class="comment">; tarda 5 ciclos, ocupa 3 bytes
</span>        <span class="name constant">dex</span>                     <span class="comment">; tarda 2 ciclos, ocupa 1 byte
</span>        <span class="name constant">bne</span> <span class="name constant">l0</span>                  <span class="comment">; tarda 2 ciclos, ocupa 2 bytes</span></code></pre>
<p>El loop se repite 256 veces, así el <em>loop</em> tarda (5 + 2 + 2) * 256 = 2304 ciclos
y ocupa 6 bytes.</p>
<p>Una manera de hacerlo mucho más rápido es con un <em>unrolled loop</em>. Así:</p>
<pre class="code asm literal-block"><code><span class="name function">lda</span> <span class="comment">#$20                        ; pone un $20 de $0400 a $04ff
</span><span class="name constant">sta</span> <span class="name constant">$0400</span>                       <span class="comment">; tarda 4 ciclos, ocupa 3 bytes
</span><span class="name constant">sta</span> <span class="name constant">$0401</span>                       <span class="comment">; tarda 4 ciclos, ocupa 3 bytes
</span><span class="name constant">sta</span> <span class="name constant">$0402</span>                       <span class="comment">; tarda 4 ciclos, ocupa 3 bytes
</span><span class="name constant">...</span>
<span class="name function">sta</span> <span class="name constant">$04fe</span>                       <span class="comment">; tarda 4 ciclos, ocupa 3 bytes
</span><span class="name constant">sta</span> <span class="name constant">$04ff</span>                       <span class="comment">; tarda 4 ciclos, ocupa 3 bytes</span></code></pre>
<p>De esta manera el <em>unrolled loop</em> tarda 4 * 256 = 1024 ciclos, pero ocupa
256 * 3 = 768 bytes.</p>
<p>Una manera más mantenible de escribir <em>unrolled loops</em> es, al menos con
<a class="reference external" href="https://github.com/cc65/cc65">cc65</a>, es así:</p>
<pre class="code asm literal-block"><code><span class="name function">lda</span> <span class="comment">#$20
</span><span class="name constant">.repeat</span> <span class="literal number integer">256</span><span class="punctuation">,</span> <span class="name constant">XX</span>
        <span class="name function">sta</span> <span class="name constant">$0400</span> <span class="error">+</span> <span class="name constant">XX</span>
<span class="name attribute">.endrepeat</span></code></pre>
<p>Y van a ver que dentro del código del Chipdisk se usa mucho. Solo buscar por
<span class="docutils literal">.repeat</span> para que vean la cantidad de veces que se usa. Pero para ser honestos
no estoy seguro que el Chipdisk requiera de tantos <em>unrolled loops</em>.</p>
</div>
<div class="section" id="truquito-sumar-320">
<h4>Truquito: Sumar 320</h4>
<p>La otra cosa a rescatar, es como funciona el <span class="docutils literal">bitmap_next_y()</span>. Lo que
hace es sumar <span class="docutils literal">320</span> al puntero <span class="docutils literal"><span class="pre">$f8/$f9</span></span>. Y como <span class="docutils literal">320 = 256 + 64</span>,
lo hace sumando 64 a <span class="docutils literal">$f8</span> e incrementando en uno <span class="docutils literal">$f9</span>.</p>
<pre class="code asm literal-block"><code><span class="name label">bitmap_next_y:</span>
        <span class="name function">clc</span>                             <span class="comment">; limpiar Carry para la suma
</span>        <span class="name constant">lda</span> <span class="name constant">$f8</span>                         <span class="comment">;
</span>        <span class="name constant">adc</span> <span class="comment">#64                         ; suma 64 a $f8 y guarda el carry
</span>        <span class="name constant">sta</span> <span class="name constant">$f8</span>                         <span class="comment">; guarda el valor en $f8
</span>
        <span class="name function">lda</span> <span class="name constant">$f9</span>                         <span class="comment">; incrementa $f9 en 1 + carry
</span>        <span class="name constant">adc</span> <span class="comment">#1
</span>        <span class="name constant">sta</span> <span class="name constant">$f9</span>                         <span class="comment">; guarda en valor en $f9</span></code></pre>
</div>
</div>
</div>
<div class="section" id="leyendo-mouse-joystick-y-teclado">
<h2><a class="toc-backref" href="#id28">Leyendo mouse, joystick y teclado</a></h2>
<p>El Player soporta 3 métodos para controlar la &quot;flechita&quot;:</p>
<ul class="simple">
<li><p>Joystick en el port #2</p></li>
<li><p>Mouse en el port #1</p></li>
<li><p>Teclado</p></li>
</ul>
<div class="section" id="joystick">
<h3>Joystick</h3>
<p>Leer el joystick es relativamente sencillo en la C64. Los valores del
joystick 1 están en <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia11.htm">$dc01</a> y los del joystick 2 están en <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia10.htm">$dc00</a></p>
<pre class="code asm literal-block"><code><span class="name function">ldx</span> <span class="name constant">$dc00</span>                       <span class="comment">; &quot;X&quot; tiene el valor del joystick #2
</span><span class="name constant">ldy</span> <span class="name constant">$dc01</span>                       <span class="comment">; &quot;Y&quot; tiene el valor del joystick #1</span></code></pre>
<p>Los posibles valores son:</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr><th class="head"><p>$dc00/$dc01</p></th>
<th class="head"><p>Significado</p></th>
</tr>
</thead>
<tbody>
<tr><td><p>Bit  4</p></td>
<td><p>Joystick Boton: 0 = Activo</p></td>
</tr>
<tr><td><p>Bit  3</p></td>
<td><p>Joystick Derecha: 0 = Activo</p></td>
</tr>
<tr><td><p>Bit  2</p></td>
<td><p>Joystick Izquierda: 0 = Activo</p></td>
</tr>
<tr><td><p>Bit  1</p></td>
<td><p>Joystick Abajo: 0 = Activo</p></td>
</tr>
<tr><td><p>Bit  0</p></td>
<td><p>Joystick Arriba: 0 = Activo</p></td>
</tr>
</tbody>
</table>
<p>Importante: 0 significa que esta prendido, y 0 apagado. Si uno quiere
chequear si el boton del Joystick 2 esta apretado, el código es:</p>
<pre class="code asm literal-block"><code><span class="name function">lda</span> <span class="name constant">$dc00</span>                       <span class="comment">; leer estado de Joystick 2
</span><span class="name constant">and</span> <span class="comment">#%00010000                  ; solo me interesa el estado del botón
</span><span class="name constant">beq</span> <span class="name constant">boton_apretado</span>              <span class="comment">; si es 0, entonces el botón esta apretado</span></code></pre>
<p>Y algo similar para el Joystick 1, pero con <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia11.htm">$dc01</a> en vez de <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia10.htm">$dc00</a>.</p>
</div>
<div class="section" id="teclado">
<h3>Teclado</h3>
<p>El teclado es un poco más complicado... o no, depende de lo que uno
necesite. Hay una función del KERNAL que devuelve la tecla apretada: <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/romffe4.htm">$ffe4</a></p>
<pre class="code asm literal-block"><code><span class="name function">jsr</span> <span class="name constant">$ffe4</span>                       <span class="comment">; devuelve en A en byte leido del teclado</span></code></pre>
<p>Y usar el KERNAL para esto esta más que bien para la mayoría de los
casos. El Player, sin embargo, usa el otra opción que es leyendo el
&quot;hardware&quot; directamente, y funciona así:</p>
<ul class="simple">
<li><p>El teclado de la Commodore 64 tiene 64 teclas (sin contar RESTORE)</p></li>
<li><p>Y las teclas están ordenadas en una matriz de 8 x 8 (8 * 8 = 64)</p></li>
<li><p><a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia11.htm">$dc01</a> contiene los valores de las columnas</p></li>
<li><p>y <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia10.htm">$dc00</a> contiene los valores del las filas</p></li>
</ul>
<p>O sea, que uno puede saber que teclas están apretadas al leer la
siguiente matriz:</p>
<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 11%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr><th class="head" colspan="2" rowspan="2"><p>Matriz 8x8
del teclado</p></th>
<th class="head" colspan="8"><p>$DC01</p></th>
</tr>
<tr><th class="head"><p>Bit 7</p></th>
<th class="head"><p>Bit 6</p></th>
<th class="head"><p>Bit 5</p></th>
<th class="head"><p>Bit 4</p></th>
<th class="head"><p>Bit 3</p></th>
<th class="head"><p>Bit 2</p></th>
<th class="head"><p>Bit 1</p></th>
<th class="head"><p>Bit 0</p></th>
</tr>
</thead>
<tbody>
<tr><td rowspan="8"><p>$DC00</p></td>
<td><p><strong>Bit 7</strong></p></td>
<td><p>RUN/STOP</p></td>
<td><p>Q</p></td>
<td><p>C=</p></td>
<td><p>SPACE</p></td>
<td><p>2</p></td>
<td><p>CTRL</p></td>
<td><p>←</p></td>
<td><p>1</p></td>
</tr>
<tr><td><p><strong>Bit 6</strong></p></td>
<td><p>/</p></td>
<td><p>↑</p></td>
<td><p>=</p></td>
<td><p>SHIFT-R</p></td>
<td><p>CLR/HOME</p></td>
<td><p>;</p></td>
<td><p>*</p></td>
<td><p>£</p></td>
</tr>
<tr><td><p><strong>Bit 5</strong></p></td>
<td><p>,</p></td>
<td><p>&#64;</p></td>
<td><p>:</p></td>
<td><p>.</p></td>
<td><p>-</p></td>
<td><p>L</p></td>
<td><p>P</p></td>
<td><p>+</p></td>
</tr>
<tr><td><p><strong>Bit 4</strong></p></td>
<td><p>N</p></td>
<td><p>O</p></td>
<td><p>K</p></td>
<td><p>M</p></td>
<td><p>0</p></td>
<td><p>J</p></td>
<td><p>I</p></td>
<td><p>9</p></td>
</tr>
<tr><td><p><strong>Bit 3</strong></p></td>
<td><p>V</p></td>
<td><p>U</p></td>
<td><p>H</p></td>
<td><p>B</p></td>
<td><p>8</p></td>
<td><p>G</p></td>
<td><p>Y</p></td>
<td><p>7</p></td>
</tr>
<tr><td><p><strong>Bit 2</strong></p></td>
<td><p>X</p></td>
<td><p>T</p></td>
<td><p>F</p></td>
<td><p>C</p></td>
<td><p>6</p></td>
<td><p>D</p></td>
<td><p>R</p></td>
<td><p>5</p></td>
</tr>
<tr><td><p><strong>Bit 1</strong></p></td>
<td><p>SHIFT-L</p></td>
<td><p>E</p></td>
<td><p>S</p></td>
<td><p>Z</p></td>
<td><p>4</p></td>
<td><p>A</p></td>
<td><p>W</p></td>
<td><p>3</p></td>
</tr>
<tr><td><p><strong>Bit 0</strong></p></td>
<td><p>UP/DOWN</p></td>
<td><p>F5</p></td>
<td><p>F3</p></td>
<td><p>F1</p></td>
<td><p>F7</p></td>
<td><p>LEFT/RIGHT</p></td>
<td><p>RETURN</p></td>
<td><p>INST/DEL</p></td>
</tr>
</tbody>
</table>
<p>Si queremos saber si la tecla <span class="docutils literal">Q</span> fue apretada entonces hay que hacer lo siguiente:</p>
<pre class="code asm literal-block"><code><span class="name function">lda</span> <span class="comment">#%01111111              ; fila 7
</span><span class="name constant">sta</span> <span class="name constant">$dc00</span>
<span class="name function">lda</span> <span class="name constant">$dc01</span>
<span class="name function">and</span> <span class="comment">#%01000000              ; columna 6
</span><span class="name constant">beq</span> <span class="name constant">tecla_apretada</span>          <span class="comment">; si vale 0, entonces fue apretada</span></code></pre>
<p>Al igual que el joystick, un valor 0 indica que fue apretada, y un 1 que no.</p>
<p><strong>IMPORTANTE</strong>: Los joysticks y el teclado comparten el mismo controlador (CIA)
por lo que diferencia entre un movimiento de joystick y teclas apretadas a
veces se complica. Notaran que ambos usan tanto <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia10.htm">$dc00</a> como  <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia11.htm">$dc01</a> para
leer los datos.</p>
<p>Si queremos saber si el <em>cursor izquierda</em> esta apretado, entonces hay que
chequear si las teclas <em>Shift</em> y <em>cursor izquierda/derecha</em> están apretadas.
Para detectar eso, en el Player hacemos esto:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; read_keyboard
;
; chequea si cursor derecha o izquierda fueron apretado
;
; A = 0 nada fue apretado
; A = 1 cursor derecha fue apretado
; A = 2 cursor izquierda fue apretado
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">read_keyboard:</span>
        <span class="comment">; IMPORTANTE: los bits están invertidos en el CIA (0 = on, 1 = off)
</span>
        <span class="name function">NoKey</span>    <span class="error">=</span> <span class="literal number integer">0</span>
        <span class="name function">LeftKey</span>  <span class="error">=</span> <span class="literal number integer">1</span>
        <span class="name function">RightKey</span> <span class="error">=</span> <span class="literal number integer">2</span>


        <span class="comment">; Chequear por shift izquierdo
</span>        <span class="name function">lda</span> <span class="comment">#%11111101    ; file 2
</span>        <span class="name constant">sta</span> <span class="name constant">$dc00</span>
        <span class="name function">lda</span> <span class="name constant">CIA1_PRB</span>
        <span class="name function">and</span> <span class="comment">#%10000000    ; col 7
</span>        <span class="name constant">beq</span> <span class="punctuation">:</span><span class="error">+</span>

        <span class="comment">; Chequear for shift derecho
</span>        <span class="name function">lda</span> <span class="comment">#%10111111    ; file 6
</span>        <span class="name constant">sta</span> <span class="name constant">$dc00</span>
        <span class="name function">lda</span> <span class="name constant">CIA1_PRB</span>
        <span class="name function">and</span> <span class="comment">#%00010000    ; col 4
</span>        <span class="name constant">beq</span> <span class="punctuation">:</span><span class="error">+</span>
        <span class="name function">lda</span> <span class="comment">#$ff          ; shift no apretados
</span><span class="punctuation">:</span>       <span class="name constant">sta</span> <span class="name constant">shift_on</span>

        <span class="comment">; chequear por cursor izq/derecha
</span>        <span class="name function">lda</span> <span class="comment">#%11111110    ; file 0
</span>        <span class="name constant">sta</span> <span class="name constant">$dc00</span>
        <span class="name function">lda</span> <span class="name constant">CIA1_PRB</span>
        <span class="name function">and</span> <span class="comment">#%00000100    ; col 2
</span>        <span class="name constant">cmp</span> <span class="name constant">keydown</span>
        <span class="name function">bne</span> <span class="name constant">newkey</span>
        <span class="name function">lda</span> <span class="comment">#NoKey        ; No se apretó nada
</span>        <span class="name constant">rts</span>
<span class="name label">newkey:</span>
        <span class="name function">sta</span> <span class="name constant">keydown</span>
        <span class="name function">lda</span> <span class="name constant">keydown</span>
        <span class="name function">beq</span> <span class="punctuation">:</span><span class="error">+</span>
        <span class="name function">lda</span> <span class="comment">#NoKey        ; key up
</span>        <span class="name constant">rts</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">shift_on</span>
        <span class="name function">beq</span> <span class="name constant">left</span>
        <span class="name function">lda</span> <span class="comment">#RightKey
</span>        <span class="name constant">rts</span>
<span class="name label">left:</span>   <span class="name function">lda</span> <span class="comment">#LeftKey
</span>        <span class="name constant">rts</span>

<span class="name label">keydown:</span>
    <span class="name attribute">.byte</span> <span class="error">%</span><span class="literal number integer">00000100</span>
<span class="name label">shift_on:</span>
    <span class="name attribute">.byte</span> <span class="name constant">$ff</span>  <span class="comment">; $ff = false, $00 = true</span></code></pre>
</div>
<div class="section" id="mouse">
<h3>Mouse</h3>
<p>El Player funciona con el mouse también. No es muy común usar mouse en
la C64, pero si uno tiene un Commodore 1351, lo puede usar. Controlar el
mouse no es tan complicado, pero tiene lo suyo.</p>
<p>Lo primero que hay que hacer, es decirle a la CIA que el puerto 1 (ó 2) se va
a usar para el mouse. Y luego se lee el <em>delta x</em> desde <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/sid25.htm">$d419</a> y el <em>delta y</em>
desde <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/sid26.htm">$d41a</a> (que son registros del chip de sonido).</p>
<p>El mouse se activa con <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia10.htm">$dc00</a>.</p>
<pre class="code asm literal-block"><code><span class="name function">lda</span> <span class="comment">#%01000000                  ; habilitar mouse
</span><span class="name constant">sta</span> <span class="name constant">$dc00</span>                       <span class="comment">; en puerto 1
</span>
<span class="comment">; luego de usar el mouse, se desactiva de la siguiente manera
</span>
<span class="name function">lda</span> <span class="comment">#%00111111                  ; habilitar joystick
</span><span class="name constant">sta</span> <span class="name constant">$dc00</span>                       <span class="comment">; en puerto 1</span></code></pre>
<p>Y esta es la rutina que usa el Player: lee los deltas, y chequea si el boton
fue apretado</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; read_mouse
;       exit    x = delta x movement
;               y = delta y movement
;               C = 0 if button pressed
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">read_mouse:</span>
        <span class="name function">lda</span> <span class="name constant">$d419</span>                       <span class="comment">; lee delta X (pot x)
</span>        <span class="name constant">ldy</span> <span class="name constant">opotx</span>
        <span class="name function">jsr</span> <span class="name constant">mouse_move_check</span>            <span class="comment">; calcular delta
</span>        <span class="name constant">sty</span> <span class="name constant">opotx</span>
        <span class="name function">sta</span> <span class="name constant">ret_x_value</span>

        <span class="name function">lda</span> <span class="name constant">$d41a</span>                       <span class="comment">; leer delta Y (pot y)
</span>        <span class="name constant">ldy</span> <span class="name constant">opoty</span>
        <span class="name function">jsr</span> <span class="name constant">mouse_move_check</span>            <span class="comment">; calcular delta
</span>        <span class="name constant">sty</span> <span class="name constant">opoty</span>

        <span class="name function">eor</span> <span class="comment">#$ff                        ; delta esta invertido... arreglarlo
</span>        <span class="name constant">tay</span>
        <span class="name function">iny</span>

        <span class="name function">sec</span>                             <span class="comment">; C = 1 (significa botón no apretado)
</span>
<span class="name function">ret_x_value</span> <span class="error">=</span> <span class="punctuation">*</span> <span class="error">+</span> <span class="literal number integer">1</span>
        <span class="name function">ldx</span> <span class="comment">#00                         ; self modifying
</span>
        <span class="name function">lda</span> <span class="name constant">$dc01</span>                       <span class="comment">; leer botón joy #1 : bit 4
</span>        <span class="name constant">asl</span>
        <span class="name function">asl</span>
        <span class="name function">asl</span>
        <span class="name function">asl</span>                             <span class="comment">; C = 0 (significa botón apretado)
</span>        <span class="name constant">rts</span>

<span class="name label">opotx:</span> <span class="name attribute">.byte</span> <span class="name constant">$00</span>
<span class="name label">opoty:</span> <span class="name attribute">.byte</span> <span class="name constant">$00</span>

<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; mouse_move_check
; Taken from here:
; https://github.com/cc65/cc65/blob/master/libsrc/c64/mou/c64-1351.s
;
;       entry   y = old value of pot register
;               a = current value of pot register
;       exit    y = value to use for old value
;               x,a = delta value for position
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">mouse_move_check:</span>
        <span class="name function">sty</span>     <span class="name constant">old_value</span>
        <span class="name function">sta</span>     <span class="name constant">new_value</span>
        <span class="name function">ldx</span>     <span class="comment">#$00
</span>
        <span class="name function">sec</span>
        <span class="name function">sbc</span>     <span class="name constant">old_value</span>               <span class="comment">; a = mod64 (new - old)
</span>        <span class="name constant">and</span>     <span class="comment">#%01111111
</span>        <span class="name constant">cmp</span>     <span class="comment">#%01000000              ; if (a &gt; 0)
</span>        <span class="name constant">bcs</span>     <span class="error">&#64;</span><span class="name constant">L1</span>                     <span class="comment">;
</span>        <span class="name constant">lsr</span>     <span class="name constant">a</span>                       <span class="comment">;   a /= 2;
</span>        <span class="name constant">beq</span>     <span class="error">&#64;</span><span class="name constant">L2</span>                     <span class="comment">;   if (a != 0)
</span>        <span class="name constant">ldy</span>     <span class="name constant">new_value</span>               <span class="comment">;     y = NewValue
</span>        <span class="name constant">rts</span>                             <span class="comment">;   return
</span>
<span class="error">&#64;</span><span class="name label">L1:</span>    <span class="name function">ora</span>     <span class="comment">#%11000000              ; else or in high order bits
</span>        <span class="name constant">cmp</span>     <span class="comment">#$ff                    ; if (a != -1)
</span>        <span class="name constant">beq</span>     <span class="error">&#64;</span><span class="name constant">L2</span>
        <span class="name function">sec</span>
        <span class="name function">ror</span>     <span class="name constant">a</span>                       <span class="comment">;   a /= 2
</span>        <span class="name constant">dex</span>                             <span class="comment">;   high byte = -1 (X = $FF)
</span>        <span class="name constant">ldy</span>     <span class="name constant">new_value</span>
        <span class="name function">rts</span>

<span class="error">&#64;</span><span class="name label">L2:</span>    <span class="name function">txa</span>                             <span class="comment">; A = $00
</span>        <span class="name constant">rts</span>

<span class="name label">old_value:</span> <span class="name attribute">.byte</span> <span class="literal number integer">0</span>
<span class="name label">new_value:</span> <span class="name attribute">.byte</span> <span class="literal number integer">0</span></code></pre>
<p>Y para entender mejor como se habilita/inhabilita el mouse/joystick
así es como funciona el <span class="docutils literal">main_loop()</span> del Player:</p>
<pre class="code asm literal-block"><code><span class="name label">main_loop:</span>
    <span class="name attribute">...</span>

    <span class="name function">lda</span> <span class="comment">#%01000000                  ; habilitar mouse
</span>    <span class="name constant">sta</span> <span class="name constant">$dc00</span>                       <span class="comment">; (inhabilita joystick)
</span>
    <span class="name function">jsr</span> <span class="name constant">read_mouse</span>
    <span class="name function">jsr</span> <span class="name constant">process_mouse</span>

    <span class="name function">jsr</span> <span class="name constant">read_keyboard</span>
    <span class="name function">jsr</span> <span class="name constant">process_keyboard</span>

    <span class="name function">lda</span> <span class="comment">#%00111111                  ; habilitar joystick
</span>    <span class="name constant">sta</span> <span class="name constant">$dc00</span>                       <span class="comment">; (inhabilita el mouse)
</span>
    <span class="name function">jsr</span> <span class="name constant">read_joystick</span>
    <span class="name function">jsr</span> <span class="name constant">process_joystick</span>

    <span class="name attribute">...</span>
    <span class="name function">jmp</span> <span class="name constant">main_loop</span></code></pre>
</div>
</div>
<div class="section" id="animar-botones-apretados">
<h2><a class="toc-backref" href="#id29">Animar botones apretados</a></h2>
<p>Acá no estamos haciendo nada raro. Simplemente reemplazamos un pedazo del bitmap
por otro.</p>
<div class="figure">
<img alt="celda de 7x7" src="https://lh3.googleusercontent.com/gGQcvRrOcIv8tWfcliz_qTAveG2UALJxt9JYd-3JjOKYBzqM9FBiZ0U6nZMknEQt-87LYgH-H_OVP-V_HlMEr4W93M4H1WHOXkL2atCm5TePAqrK2s8CGaXHBg6apUN75M1xnzA" />
<p class="caption"><em>Se copia un bloque de 7x7 celdas</em></p>
</div>
<p>El algoritmo es más o menos así:</p>
<ol class="arabic simple">
<li><p>El botón que esta apretado (si es que hay alguno) se reemplaza por el contenido del buffer temporal</p></li>
<li><p>Se copia al buffer temporal el contenido del boton a apretar</p></li>
<li><p>Se copia el contenido del botón apretado a destino</p></li>
</ol>
<p>Lo que se copia es un bloque de 7x7 de cada botón. Se copia tanto el bitmap
como el color. Cada botón ocupa:</p>
<ul class="simple">
<li><p>bitmap: 7 * 7 * 8 (8 bytes por celda) + color: 7 * 7 = 441 bytes</p></li>
</ul>
<p>Son 4 botones lo que animamos: <em>Play</em>, <em>FF</em>, <em>Rew</em> y <em>Stop</em>, y usamos un buffer temporal.
Así que en total usamos 441 * 5 (2205) bytes de data para esto.</p>
<p>El código en assembler esta hecho con macros:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; BUTTON_IMAGE_COPY
;
; Copy button (7x7 block) bitmap and colormap to Screen RAM and Color RAM
; respectively, from source address.  Source address must point to the start of
; the bitmap data, and its colormap must follow.
;
; If from_screen is not blank, data from screen is copied to src.
;
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name attribute">.macro</span> <span class="name constant">BUTTON_IMAGE_COPY</span>   <span class="name constant">src</span><span class="punctuation">,</span> <span class="name constant">pos_x</span><span class="punctuation">,</span> <span class="name constant">pos_y</span><span class="punctuation">,</span> <span class="name constant">from_screen</span>
        <span class="name function">Width</span>  <span class="error">=</span> <span class="literal number integer">7</span>
        <span class="name function">Height</span> <span class="error">=</span> <span class="literal number integer">7</span>

        <span class="name function">ScreenRAM</span> <span class="error">=</span> <span class="name constant">$4000</span>
        <span class="name function">ScreenSrc</span>  <span class="error">=</span> <span class="name constant">src</span>
        <span class="name function">ScreenDest</span> <span class="error">=</span> <span class="name constant">ScreenRAM</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">pos_y</span> <span class="punctuation">*</span> <span class="literal number integer">40</span> <span class="punctuation">*</span> <span class="literal number integer">8</span><span class="punctuation">)</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">pos_x</span> <span class="punctuation">*</span> <span class="literal number integer">8</span><span class="punctuation">)</span>

        <span class="name function">ColorRAM</span>  <span class="error">=</span> <span class="name constant">$6000</span>
        <span class="name function">ColorSrc</span>  <span class="error">=</span> <span class="name constant">src</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">Width</span> <span class="punctuation">*</span> <span class="name constant">Height</span> <span class="punctuation">*</span> <span class="literal number integer">8</span><span class="punctuation">)</span>
        <span class="name function">ColorDest</span> <span class="error">=</span> <span class="name constant">ColorRAM</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">pos_y</span> <span class="punctuation">*</span> <span class="literal number integer">40</span><span class="punctuation">)</span> <span class="error">+</span> <span class="name constant">pos_x</span>

<span class="name attribute">.repeat</span> <span class="name constant">Height</span><span class="punctuation">,</span> <span class="name constant">YY</span>
        <span class="comment">;; Copy bitmap
</span>        <span class="name function">ldx</span> <span class="comment">#(Width*8-1)
</span><span class="name constant">.ifblank</span> <span class="name constant">from_screen</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">ScreenSrc</span>  <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="punctuation">(</span><span class="name constant">Width</span> <span class="punctuation">*</span> <span class="literal number integer">8</span><span class="punctuation">)),</span> <span class="name constant">x</span>
        <span class="name function">sta</span> <span class="name constant">ScreenDest</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="punctuation">(</span><span class="literal number integer">40</span> <span class="punctuation">*</span> <span class="literal number integer">8</span><span class="punctuation">)),</span> <span class="name constant">x</span>
<span class="name attribute">.else</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">ScreenDest</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="punctuation">(</span><span class="literal number integer">40</span> <span class="punctuation">*</span> <span class="literal number integer">8</span><span class="punctuation">)),</span> <span class="name constant">x</span>
        <span class="name function">sta</span> <span class="name constant">ScreenSrc</span>  <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="punctuation">(</span><span class="name constant">Width</span> <span class="punctuation">*</span> <span class="literal number integer">8</span><span class="punctuation">)),</span> <span class="name constant">x</span>
<span class="name attribute">.endif</span>
        <span class="name function">dex</span>
        <span class="name function">bpl</span> <span class="punctuation">:-</span>

        <span class="comment">;; Copy color attributes
</span>        <span class="name function">ldx</span> <span class="comment">#(Width-1)
</span><span class="name constant">.ifblank</span> <span class="name constant">from_screen</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">ColorSrc</span>  <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="name constant">Width</span><span class="punctuation">),</span> <span class="name constant">x</span>
        <span class="name function">sta</span> <span class="name constant">ColorDest</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="literal number integer">40</span><span class="punctuation">),</span> <span class="name constant">x</span>
<span class="name attribute">.else</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">ColorDest</span> <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="literal number integer">40</span><span class="punctuation">),</span> <span class="name constant">x</span>
        <span class="name function">sta</span> <span class="name constant">ColorSrc</span>  <span class="error">+</span> <span class="punctuation">(</span><span class="name constant">YY</span> <span class="punctuation">*</span> <span class="name constant">Width</span><span class="punctuation">),</span> <span class="name constant">x</span>
<span class="name attribute">.endif</span>
        <span class="name function">dex</span>
        <span class="name function">bpl</span> <span class="punctuation">:-</span>
<span class="name attribute">.endrepeat</span>

        <span class="name function">rts</span>
<span class="name attribute">.endmacro</span>

<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span>
<span class="comment">;; play
</span><span class="name label">button_play_plot:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">img_button_play</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">14</span>
<span class="name label">button_play_save:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">14</span><span class="punctuation">,</span> <span class="literal number integer">1</span>
<span class="name label">button_play_restore:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span>  <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="literal number integer">14</span>

<span class="comment">;; rew
</span><span class="name label">button_rew_plot:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">img_button_rew</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">16</span>
<span class="name label">button_rew_save:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">16</span><span class="punctuation">,</span> <span class="literal number integer">1</span>
<span class="name label">button_rew_restore:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">16</span>

<span class="comment">;; ff
</span><span class="name label">button_ff_plot:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">img_button_ff</span><span class="punctuation">,</span>  <span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">18</span>
<span class="name label">button_ff_save:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span>  <span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">18</span><span class="punctuation">,</span> <span class="literal number integer">1</span>
<span class="name label">button_ff_restore:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span> <span class="literal number integer">7</span><span class="punctuation">,</span> <span class="literal number integer">18</span>

<span class="comment">;; stop
</span><span class="name label">button_stop_plot:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">img_button_stop</span><span class="punctuation">,</span> <span class="literal number integer">10</span><span class="punctuation">,</span> <span class="literal number integer">18</span>
<span class="name label">button_stop_save:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span> <span class="literal number integer">10</span><span class="punctuation">,</span> <span class="literal number integer">18</span><span class="punctuation">,</span> <span class="literal number integer">1</span>
<span class="name label">button_stop_restore:</span>
        <span class="name function">BUTTON_IMAGE_COPY</span>  <span class="name constant">tmp_img_button</span><span class="punctuation">,</span>  <span class="literal number integer">10</span><span class="punctuation">,</span> <span class="literal number integer">18</span></code></pre>
</div>
</div>
<div class="section" id="codigo-el-easter-egg">
<h1><a class="toc-backref" href="#id30">Código: El Easter Egg</a></h1>
<div class="figure">
<img alt="easter egg" src="https://lh3.googleusercontent.com/Zp52TSOw_i2SzQ9zJhI0Fl28joPzCKIpYGy4v52h4r2AWZVsnXTGAJAh9dxEPs7vhTIv4x0CdGgt55xQcAhK7HoTrVOjsxdmW_cNiF4Yi9BfiLpB43dJ_Gsuoetg5CH5qNnaex8" />
</div>
<p>El Easter Egg (huevo de pascua) esta hecho con:</p>
<ul class="simple">
<li><p>Usa modo texto (PETSCII puro) para el sol y sus animaciones</p></li>
<li><p>7 sprites extendidos en X e Y para el scroll</p></li>
<li><p>Abre el borde vertical para por los sprites debajo del sol</p></li>
<li><p>Toca un sid que tiene que sonar bien en PAL/NTSC/Drean</p></li>
</ul>
<div class="section" id="borde-vertical">
<h2><a class="toc-backref" href="#id31">Borde Vertical</a></h2>
<p>Una manera de abrir el borde vertical es más o menos así:</p>
<ol class="arabic simple">
<li><p>Se cambia modo 24 filas cuando el VIC esta dibujando la fila 25 (entre los rasterlines <span class="docutils literal">$f2</span> y <span class="docutils literal">$fa</span>)</p></li>
<li><p>Se cambia a modo 25 filas una vez que el raster pasó la fila 25.</p></li>
</ol>
<p>y eso se tiene que hacer en cada frame.</p>
<p>Ejemplo:</p>
<pre class="code asm literal-block"><code><span class="name label">loop:</span>

        <span class="name function">lda</span> <span class="comment">#$f9                        ; raster line llegó a $f9?
</span><span class="punctuation">:</span>       <span class="name constant">cmp</span> <span class="name constant">$d012</span>                       <span class="comment">; sino, esperarlo
</span>        <span class="name constant">bne</span> <span class="punctuation">:-</span>

        <span class="name function">lda</span> <span class="name constant">$d011</span>                       <span class="comment">; cambiar a modo 24-filas
</span>        <span class="name constant">and</span> <span class="comment">#%11110111                  ;
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>

        <span class="name function">lda</span> <span class="comment">#$fc                        ; esperar a la rasterline $fc
</span><span class="punctuation">:</span>       <span class="name constant">cmp</span> <span class="name constant">$d012</span>
        <span class="name function">bne</span> <span class="punctuation">:-</span>

        <span class="name function">lda</span> <span class="name constant">$d011</span>                       <span class="comment">; cambiar a modo 25-filas
</span>        <span class="name constant">ora</span> <span class="comment">#%00001000                  ; nuevamente
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>

        <span class="name function">jmp</span> <span class="name constant">loop</span></code></pre>
<p>Esa es la lógica en general. Pero lo que hay que cambiar es como esperar a la
rasterline <span class="docutils literal">$f9</span> sin que se consuma todos los ciclos. La manera más sencilla es
con una interrupción de raster... algo así:</p>
<pre class="code asm literal-block"><code><span class="name label">setup_irq:</span>
        <span class="name function">sei</span>
        <span class="name function">lda</span> <span class="comment">#$f9                        ; disparar IRQ en rasterline $f9
</span>        <span class="name constant">sta</span> <span class="name constant">$d012</span>

        <span class="name function">ldx</span> <span class="comment">#&lt;irq_vector
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;irq_vector
</span>        <span class="name constant">stx</span> <span class="name constant">$fffe</span>                       <span class="comment">; como BASIC/KERNAL estan apagados se usa
</span>        <span class="name constant">sty</span> <span class="name constant">$ffff</span>                       <span class="comment">; $fffe/$ffff en vez de $0314/$0315
</span>        <span class="name constant">cli</span>
        <span class="name function">rts</span>


<span class="name label">irq_vector:</span>
        <span class="name function">pha</span>                             <span class="comment">; guarda &quot;A&quot;
</span>
        <span class="name function">asl</span> <span class="name constant">$d019</span>                       <span class="comment">; ACK interrupción raster
</span>
        <span class="name function">lda</span> <span class="name constant">$d011</span>                       <span class="comment">; cambiar a modo 24-filas
</span>        <span class="name constant">and</span> <span class="comment">#%11110111                  ;
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>

        <span class="name function">lda</span> <span class="comment">#$fc                        ; esperar a la rasterline $fc
</span><span class="punctuation">:</span>       <span class="name constant">cmp</span> <span class="name constant">$d012</span>
        <span class="name function">bne</span> <span class="punctuation">:-</span>

        <span class="name function">lda</span> <span class="name constant">$d011</span>                       <span class="comment">; cambiar a modo 25-filas
</span>        <span class="name constant">ora</span> <span class="comment">#%00001000                  ; nuevamente
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>

        <span class="name function">pla</span>                             <span class="comment">; restaura &quot;A&quot;
</span>        <span class="name constant">rti</span>                             <span class="comment">; restaurar &quot;PC&quot; y &quot;Status&quot;</span></code></pre>
<p>Eso funciona en el 99% de los casos. Pero recordemos que tenemos que tocar
el sid para que funcione bien en PAL, NTSC y Drean. Y para el sid
tenemos que usar un timer con la velocidad correcta que puede ser que
sea distinta la velocidad del raster irq.</p>
<p>Supongamos que estamos corriendo el programita en una NTSC (ver <em>Detectando entre...</em> para más info):</p>
<ul class="simple">
<li><p>Vamos a tener un timer que se dispara cada <span class="docutils literal">$4fb3</span> (20403) ciclos para tocar el sid</p></li>
<li><p>Y además el raster IRQ se dispara cada <span class="docutils literal">$42c7</span> (263*65 = 17095) ciclos para abrir el borde</p></li>
</ul>
<div class="figure">
<img alt="collision in interrupts" src="https://lh3.googleusercontent.com/D50glqRSR3V8MMi-aXe41TiXWk9tHjyTKkTcrhQmUZFfdPHs07WbWRPhok07di0ydzyAkn16MeOLsQzOdxVipXaSjv6diR9pmNJHB2MCG-yg0kSJ8HcqRBvIPInhU3t30N34yXc" />
<p class="caption"><em>Colisión entre Raster IRQ y Timer IRQ en NTSC. ¿Cual se ejecuta primero?</em></p>
</div>
<p>Es posible que cada tanto, el borde no se abra porque la interrupción del sid
se ejecuta justo cuando se tenía que llamar a la interrupción del raster. En
la animación de arriba la barra blanca que &quot;baja&quot; muestra cuando se ejecuta
el Timer IRQ y su duración. Y la barrita chiquita de abajo muestra el Raster
IRQ. Como se puede ver, a veces &quot;chocan&quot; y no se sabe cual se ejecuta.</p>
</div>
<div class="section" id="interrupciones-nmi">
<h2><a class="toc-backref" href="#id32">Interrupciones NMI</a></h2>
<p>Una manera de lograr que el borde se abra siempre, es usar la interrupción NMI
(Non-Maskable Interrupt) para disparar el código del borde. La interrupción NMI tiene
prioridad sobre las demás interrupciones. Si la interrupción de Raster se
esta ejecutando cuando la NMI se tiene que ejecutar, la Interrupción NMI
interrumpe la interrupción Raster. Pero nadie puede interrumpir a una interrupción
NMI.</p>
<p>La interrupción NMI se puede disparar con los siguientes eventos:</p>
<ul class="simple">
<li><p>Apretando la tecla Restore</p></li>
<li><p>Hardware</p></li>
<li><p>Con el Timer A del CIA 2: <a class="reference external" href="http://unusedino.de/ec64/technical/aay/c64/cia213.htm">$dd0d</a> y demás amigos</p></li>
</ul>
<p>Y en nuestro caso, vamos a usar el Timer A del CIA 2. Es así:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; init_nmi
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">init_nmi:</span>
                                        <span class="comment">; setup NMI (abrir borde)
</span>        <span class="name function">ldx</span> <span class="comment">#&lt;nmi_openborder
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;nmi_openborder
</span>        <span class="name constant">stx</span> <span class="name constant">$fffa</span>                       <span class="comment">; usa el vector de NMI ($fffa/$fffb)
</span>        <span class="name constant">sty</span> <span class="name constant">$fffb</span>                       <span class="comment">; y no el de IRQ ($fffe/$ffff)
</span>
        <span class="name function">lda</span> <span class="comment">#$0                         ; parar timer A CIA 2
</span>        <span class="name constant">sta</span> <span class="name constant">$dd0e</span>


                                        <span class="comment">; PAL,      (312 * 63) $4cc8 - 1
</span>                                        <span class="comment">; PAL-N,    (312 * 65) $4f38 - 1
</span>                                        <span class="comment">; NTSC,     (263 * 65) $42c7 - 1
</span>                                        <span class="comment">; NTSC Old, (262 * 64) $4180 - 1
</span>
        <span class="name function">ldx</span> <span class="comment">#&lt;$4cc7                     ; default: PAL
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;$4cc7
</span>
        <span class="name function">lda</span> <span class="name constant">ZP_VIC_VIDEO_TYPE</span>           <span class="comment">; $01 --&gt; PAL
</span>                                        <span class="comment">; $2F --&gt; PAL-N (Drean)
</span>                                        <span class="comment">; $28 --&gt; NTSC
</span>                                        <span class="comment">; $2e --&gt; NTSC-Old
</span>        <span class="name constant">cmp</span> <span class="comment">#$01
</span>        <span class="name constant">beq</span> <span class="error">&#64;</span><span class="name constant">done</span>

        <span class="name function">cmp</span> <span class="comment">#$2f
</span>        <span class="name constant">beq</span> <span class="error">&#64;</span><span class="name constant">paln</span>

        <span class="name function">cmp</span> <span class="comment">#$28
</span>        <span class="name constant">beq</span> <span class="error">&#64;</span><span class="name constant">ntsc</span>
        <span class="name function">bne</span> <span class="error">&#64;</span><span class="name constant">ntsc_old</span>

<span class="error">&#64;</span><span class="name label">paln:</span>
        <span class="name function">ldx</span> <span class="comment">#&lt;$4f37n                    ; ciclos para PAL-N (Drean)
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;$4f37
</span>        <span class="name constant">bne</span> <span class="error">&#64;</span><span class="name constant">done</span>

<span class="error">&#64;</span><span class="name label">ntsc:</span>
        <span class="name function">ldx</span> <span class="comment">#&lt;$42c6                     ; ciclos para NTSC
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;$42c6
</span>        <span class="name constant">bne</span> <span class="error">&#64;</span><span class="name constant">done</span>

<span class="error">&#64;</span><span class="name label">ntsc_old:</span>
        <span class="name function">ldx</span> <span class="comment">#&lt;$417f                     ; ciclos para NTSC-Old
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;$417f                     ; fall-through
</span>
<span class="error">&#64;</span><span class="name label">done:</span>
        <span class="name function">stx</span> <span class="name constant">$dd04</span>                       <span class="comment">; Timer A: low-cycle-count
</span>        <span class="name constant">sty</span> <span class="name constant">$dd05</span>                       <span class="comment">; Timer A: high-cycle-count
</span>
        <span class="name function">lda</span> <span class="comment">#%10000001                  ; habilitar interrupción timer A
</span>        <span class="name constant">sta</span> <span class="name constant">$dd0d</span>                       <span class="comment">; en CIA 2
</span>
<span class="error">:</span>       <span class="name function">lda</span> <span class="name constant">$d012</span>                       <span class="comment">; esperar a que el rasterline llegue
</span><span class="punctuation">:</span>       <span class="name constant">cmp</span> <span class="name constant">$d012</span>                       <span class="comment">; a $f9, que es donde queremos abrir
</span>        <span class="name constant">beq</span> <span class="punctuation">:-</span>                          <span class="comment">; el borde
</span>        <span class="name constant">cmp</span> <span class="comment">#$f9
</span>        <span class="name constant">bne</span> <span class="punctuation">:--</span>

        <span class="name function">lda</span> <span class="comment">#%10010001                  ; ¡y habilitar el timer A!
</span>        <span class="name constant">sta</span> <span class="name constant">$dd0e</span>

        <span class="name function">rts</span>

<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; nmi_openborder
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">nmi_openborder:</span>
        <span class="name function">pha</span>                             <span class="comment">; guardar &quot;A&quot;
</span>
        <span class="name function">lda</span> <span class="name constant">$dd0d</span>                       <span class="comment">; ACK la interrupción del Timer CIA 2
</span>
        <span class="name function">lda</span> <span class="name constant">$d011</span>                       <span class="comment">; abrir borde vertical
</span>        <span class="name constant">and</span> <span class="comment">#%11110111                  ; cambiando a 24-filas
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>

        <span class="name function">lda</span> <span class="comment">#$fc                        ; Esperar a que el rasterline llegue a $fc
</span><span class="punctuation">:</span>       <span class="name constant">cmp</span> <span class="name constant">$d012</span>
        <span class="name function">bne</span> <span class="punctuation">:-</span>

        <span class="name function">lda</span> <span class="name constant">$d011</span>                       <span class="comment">; y cambiar nuevamente a 25-filas
</span>        <span class="name constant">ora</span> <span class="comment">#%00001000
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>

        <span class="name function">pla</span>                             <span class="comment">; restaurar &quot;A&quot;
</span>        <span class="name constant">rti</span>                             <span class="comment">; restaurar &quot;PC&quot; y &quot;Status&quot;</span></code></pre>
<p>Y de esa manera el borde siempre se va a abrir, sin importar que la interrupción
IRQ este activada.</p>
</div>
<div class="section" id="scroll-con-sprites">
<h2><a class="toc-backref" href="#id33">Scroll con Sprites</a></h2>
<p>El Scroll se hace con 7 sprites expandidos tanto en X como Y, abarcando todo
el largo de la pantalla. El largo de la pantalla son 320 pixeles. Y con 7 sprites
expandidos en X cubrimos: 7 * 24 * 2 = 336 pixeles.</p>
<div class="figure">
<img alt="scroll con sprites" src="https://lh3.googleusercontent.com/wqwavZCFHLGy1xzLNMvtDXbfbzDTqjBEZ4rUNuq4R1GR8N-UK4Olh63-YYColFjcexYR_2PnoquipJDkYuf4NDGbcb2hMgCHbeJPDlB2-LriVoEkVfC0c5gpH3xhUwLuBrEBc8Q" />
<p class="caption"><em>Scroll con 7 sprites</em></p>
</div>
<p>El scroll no se puede hacer con caracteres, porque se hace debajo de la linea
25. Y lo único que se puede por ahí son sprites.</p>
<p>El truquito es muy sencillo:</p>
<ol class="arabic simple">
<li><p>Se ponen 7 sprites expandidos en X, uno al lado del otro</p></li>
<li><p>Al principio los sprites están &quot;vacíos&quot;</p></li>
<li><p>Se calcula el <span class="docutils literal">C</span> (<em>carry</em>) para actualizar el sprite de más a la derecha</p></li>
<li><p>Se hace <span class="docutils literal">rol</span> de cada fila del sprite. Y <span class="docutils literal">carry</span> se usa para la columna anterior de la misma fila</p></li>
</ol>
<p>Es similar un scroll de texto normal, pero en vez de scrollear caracteres,
se scrollean bits de sprites. El código es este:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; animate_scroll
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">animate_scroll:</span>
        <span class="comment">; usa $fa-$ff como variables temporales
</span>        <span class="name function">lda</span> <span class="comment">#0
</span>        <span class="name constant">sta</span> <span class="name constant">$fa</span>                         <span class="comment">; variable temporal
</span>
        <span class="name function">ldx</span> <span class="comment">#&lt;CHARSET_ADDR              ; dirección donde esta el charset
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;CHARSET_ADDR
</span>        <span class="name constant">stx</span> <span class="name constant">$fc</span>
        <span class="name function">sty</span> <span class="name constant">$fd</span>                         <span class="comment">; $fc/$fd son los punteros al charset
</span>
<span class="name function">load_scroll_addr</span> <span class="error">=</span> <span class="punctuation">*</span> <span class="error">+</span> <span class="literal number integer">1</span>
        <span class="name function">lda</span> <span class="name constant">SCROLL_TEXT</span>                 <span class="comment">; self-modifying
</span>        <span class="name constant">cmp</span> <span class="comment">#$ff                        ; si &quot;char == $ff&quot; es fin de scroll
</span>        <span class="name constant">bne</span> <span class="name constant">next</span>
        <span class="name function">ldx</span> <span class="comment">#0                          ; resetear scroll, ya que se vuelve a empezar
</span>        <span class="name constant">stx</span> <span class="name constant">ZP_BIT_INDEX</span>
        <span class="name function">ldx</span> <span class="comment">#&lt;SCROLL_TEXT
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;SCROLL_TEXT
</span>        <span class="name constant">stx</span> <span class="name constant">load_scroll_addr</span>
        <span class="name function">sty</span> <span class="name constant">load_scroll_addr</span><span class="error">+</span><span class="literal number integer">1</span>
        <span class="name function">lda</span> <span class="name constant">SCROLL_TEXT</span>

<span class="name label">next:</span>                                   <span class="comment">; A tiene el char a dibujar
</span>        <span class="name function">clc</span>                             <span class="comment">; char_idx * 8, ya que cada char
</span>        <span class="name constant">asl</span>                             <span class="comment">; ocupa 8 bytes en el charset
</span>        <span class="name constant">rol</span> <span class="name constant">$fa</span>
        <span class="name function">asl</span>
        <span class="name function">rol</span> <span class="name constant">$fa</span>
        <span class="name function">asl</span>
        <span class="name function">rol</span> <span class="name constant">$fa</span>

        <span class="name function">tay</span>                             <span class="comment">; char_def = ($fc),y
</span>
        <span class="name function">clc</span>
        <span class="name function">lda</span> <span class="name constant">$fd</span>
        <span class="name function">adc</span> <span class="name constant">$fa</span>                         <span class="comment">; A = charset[char_idx * 8]
</span>        <span class="name constant">sta</span> <span class="name constant">$fd</span>


        <span class="comment">; scroll 8 bytes de arriba
</span>        <span class="comment">; YY = filas del sprite. 8 en total
</span>        <span class="comment">; SS = numero de sprite. 7 en total
</span>        <span class="name attribute">.repeat</span> <span class="literal number integer">8</span><span class="punctuation">,</span> <span class="name constant">YY</span>                   <span class="comment">; &quot;unrolled loop&quot; para que se más rápido
</span>                <span class="name constant">lda</span> <span class="punctuation">(</span><span class="name constant">$fc</span><span class="punctuation">),</span><span class="name constant">y</span>
                <span class="name function">ldx</span> <span class="name constant">ZP_BIT_INDEX</span>        <span class="comment">; Se actualiza el &quot;C&quot; (carry) con el valor
</span><span class="punctuation">:</span>               <span class="name constant">asl</span>                     <span class="comment">; necesario para actualizar el sprite
</span>                <span class="name constant">dex</span>                     <span class="comment">; de más a la derecha
</span>                <span class="name constant">bpl</span> <span class="punctuation">:-</span>

                <span class="name attribute">.repeat</span> <span class="literal number integer">7</span><span class="punctuation">,</span> <span class="name constant">SS</span>           <span class="comment">; cada sprite tiene 3 &quot;columnas&quot;. scrollear cada una de las 3
</span>                                        <span class="comment">; empezando por la la más a la derecha
</span>                        <span class="name constant">rol</span> <span class="name constant">SPRITE_ADDR</span> <span class="error">+</span> <span class="punctuation">(</span><span class="literal number integer">6</span> <span class="punctuation">-</span> <span class="name constant">SS</span><span class="punctuation">)</span> <span class="punctuation">*</span> <span class="literal number integer">64</span> <span class="error">+</span> <span class="name constant">YY</span> <span class="punctuation">*</span> <span class="literal number integer">3</span> <span class="error">+</span> <span class="literal number integer">2</span>
                        <span class="name function">rol</span> <span class="name constant">SPRITE_ADDR</span> <span class="error">+</span> <span class="punctuation">(</span><span class="literal number integer">6</span> <span class="punctuation">-</span> <span class="name constant">SS</span><span class="punctuation">)</span> <span class="punctuation">*</span> <span class="literal number integer">64</span> <span class="error">+</span> <span class="name constant">YY</span> <span class="punctuation">*</span> <span class="literal number integer">3</span> <span class="error">+</span> <span class="literal number integer">1</span>
                        <span class="name function">rol</span> <span class="name constant">SPRITE_ADDR</span> <span class="error">+</span> <span class="punctuation">(</span><span class="literal number integer">6</span> <span class="punctuation">-</span> <span class="name constant">SS</span><span class="punctuation">)</span> <span class="punctuation">*</span> <span class="literal number integer">64</span> <span class="error">+</span> <span class="name constant">YY</span> <span class="punctuation">*</span> <span class="literal number integer">3</span> <span class="error">+</span> <span class="literal number integer">0</span>
                <span class="name attribute">.endrepeat</span>
                <span class="name function">iny</span>                     <span class="comment">; byte of the char
</span>        <span class="name constant">.endrepeat</span>


        <span class="name function">ldx</span> <span class="name constant">ZP_BIT_INDEX</span>                <span class="comment">; bit index va de 0 a 7
</span>        <span class="name constant">inx</span>                             <span class="comment">; se incrementa una vez por &quot;scroll&quot;
</span>        <span class="name constant">cpx</span> <span class="comment">#8                          ; cuando llega a 8 (overflow)
</span>        <span class="name constant">bne</span> <span class="name constant">l1</span>                          <span class="comment">; se lee el siguiente char del texto
</span>                                        <span class="comment">; del scroll
</span>        <span class="name constant">ldx</span> <span class="comment">#0
</span>        <span class="name constant">clc</span>
        <span class="name function">inc</span> <span class="name constant">load_scroll_addr</span>            <span class="comment">; siguiente char a leer del texto
</span>        <span class="name constant">bne</span> <span class="name constant">l1</span>                          <span class="comment">; del scroll
</span>        <span class="name constant">inc</span> <span class="name constant">load_scroll_addr</span><span class="error">+</span><span class="literal number integer">1</span>
<span class="name label">l1:</span>
        <span class="name function">stx</span> <span class="name constant">ZP_BIT_INDEX</span>

        <span class="name function">rts</span></code></pre>
<p><em>Nota</em>: Ojo que estamos <span class="docutils literal">rol</span> eando 163 (7 * 8 * 3) bytes por frame, un total
de 978 (163 * 6) ciclos de CPU. No es muchísimo, pero es mucho más de lo que se usa en
un scroll de texto normal. Si usaramos los 24 pixeles del sprite,
sería el triple de costoso. ¡Ojo!</p>
<div class="figure">
<img alt="rasterbars" src="https://lh3.googleusercontent.com/7j8O3TKZuljEjbSTtlfsd1xLsErRXOsI8W147As4KsvjfNXetZUhP8-BFk3AjiWW1tA7FcGjHrGRQrjOtvjbo38lfcLyaRo1GWP7p_RCFIshxOm3Gb7pOOTug6eVFLZeQ4zcagY" />
<p class="caption"><em>Consumo de rasterbars. A:Scroll, B:Música, C:Abrir borde</em></p>
</div>
</div>
<div class="section" id="descomprimiendo-el-easter-egg">
<h2><a class="toc-backref" href="#id34">Descomprimiendo el Easter Egg</a></h2>
<p>Una vez que el Easter Egg se activa hay que descomprimirlo. El problemita
acá es que el Easter Egg no entra en un &quot;chunk&quot; continuo. Esta partido en 3
partes:</p>
<ul class="simple">
<li><p>código comprimido: <span class="docutils literal">$0118 - $07ff</span></p></li>
<li><p>sid comprimido: En algún lugar cerca de <span class="docutils literal">$e000</span></p></li>
<li><p>texto de scroll comprimido: En algún lugar cerca de <span class="docutils literal">$f800</span></p></li>
</ul>
<p>Lo interesante acá es el código comprimido que usa parte del stack de la c64.
Y para evitar que el stack pise al código comprimido, le decimos al stack
que el &quot;tope&quot; del stack es <span class="docutils literal">$0117</span> con las siguientes instrucciones:</p>
<pre class="code asm literal-block"><code><span class="name function">ldx</span> <span class="comment">#$17                        ; solo se usan 24 bytes para el stack
</span><span class="name constant">txs</span>                             <span class="comment">; el resto esta reservado para el easter egg</span></code></pre>
<p>La memoria del Player con el Easter Egg comprimido queda así:</p>
<pre class="literal-block">; Memoria del Player con Easter Egg comprimido
$0000 - $00ff: Zero Page: 256 bytes usados para variables temporales
$0100 - $0117: 24 bytes usados para stack
$0118 - $07ff: Código Easter Egg comprimido
$0800 - $0fff: Código Player (1/3)
$1000 - $32f7: Buffer para tocar el sid más grande (~9k)
$32f8 - $3fff: Código Player (2/3)
$4000 - $5fff: Gráfico bitmap (8k)
$6000 - $63ff: Gráfico color (Screen RAM) (1k)
$6400 - $68ff: Sprites (~1k)
$6900 - $6cff: Charset (1k)
$6d00 - $73ff: Sid de Ruido blanco (1.7k)
$7400 - $7caf: Imagenes de botones apretados + buffer temporal (~2k)
$7cb0 - $fbdf: Sids comprimidos, incluyendo el Sid del Easter Egg (28k)
$7be0 - $7ccf: Código Player (3/3)
$fcd0 - $fff0: Texto Scroll Easter Egg comprimido (~800 bytes)</pre>
<p>Y cuando se dispara el Easter Egg, se descomprimen los tres pedazos del Easter
Egg en el destino correcto.</p>
</div>
</div>
<div class="section" id="codigo-la-intro">
<h1><a class="toc-backref" href="#id35">Código: La Intro</a></h1>
<div class="figure">
<img alt="intro" src="https://lh3.googleusercontent.com/STIEW1KCcW65Y0U0NMOHebjsrQzkk4IuxsbqR6kVTvzx0O16ZmJYTJ_S0ttv1L5bIv0_Qsg5oGzb3pnVAiJbxBqNMg8HX658PNziScLQB1R3csABQSgB5Pt8nsC-N03Nmv9v_DU" />
</div>
<p>La intro es bastante simple:</p>
<ul class="simple">
<li><p>La parte de arriba usa un gráfico bitmap multi-color</p></li>
<li><p>La parte de abajo usa modo texto + charset custom</p></li>
<li><p>Los textos están coloreados con &quot;rasterbars&quot; invertidas</p></li>
</ul>
<div class="section" id="rasterbars">
<h2><a class="toc-backref" href="#id36">Rasterbars</a></h2>
<p>Quizás lo más interesante es como lograr el &quot;color invertido&quot;. Es sencillo:</p>
<ol class="arabic simple">
<li><p>Se hace el efecto típico de las rasterbars</p></li>
</ol>
<div class="figure">
<img alt="intro-rasterbar" src="https://lh3.googleusercontent.com/IAw3ncdKryj8scLeYa5HpEK-CUChYbFRoTjvT5oNYwmsccQMj6iN1JCmd9xO3aoCUFqJGQEk-rtKjmMECm1hrvyjRILJowwIbQwXc1XvQAJ6AC4Gkj5bnRxty-6gH_WWgHeTIIY" />
</div>
<ol class="arabic simple" start="2">
<li><p>Se pone texto encima</p></li>
</ol>
<div class="figure">
<img alt="https://lh3.googleusercontent.com/rXTTYVOZKkL5GbZRE01CcRoiRdhjZYQ4rcNd_Y5jlTk9AJvzMIkiMycnhdnJGTlWuqmfsjTELB5Zf_8s43yPObuXVAIGB68sOdWQk43HHUk6KosqHifntMtqmrA9wrKJaAk-FcA" src="https://lh3.googleusercontent.com/rXTTYVOZKkL5GbZRE01CcRoiRdhjZYQ4rcNd_Y5jlTk9AJvzMIkiMycnhdnJGTlWuqmfsjTELB5Zf_8s43yPObuXVAIGB68sOdWQk43HHUk6KosqHifntMtqmrA9wrKJaAk-FcA" />
</div>
<ol class="arabic simple" start="3">
<li><p>Se usa un charset invertido. Es decir, los bits que están en 0 pasan a 1, y viceversa</p></li>
</ol>
<div class="figure">
<img alt="https://lh3.googleusercontent.com/0d8Az60NjW3UsVP1Nsc2LGawrjcVQOURv58cpHb4eCFgS9rnyOpUjj92dVuUEUQ6urUC22a7aLwiF2o9Yx_vJmnhvRi-vsdz7kN07dr1dfvCDdY_YgxC1YaqhTcnapGVyfoE6RI" src="https://lh3.googleusercontent.com/0d8Az60NjW3UsVP1Nsc2LGawrjcVQOURv58cpHb4eCFgS9rnyOpUjj92dVuUEUQ6urUC22a7aLwiF2o9Yx_vJmnhvRi-vsdz7kN07dr1dfvCDdY_YgxC1YaqhTcnapGVyfoE6RI" />
</div>
</div>
<div class="section" id="intro-linker">
<h2><a class="toc-backref" href="#id37">Intro-linker</a></h2>
<p>La Intro, una vez que finaliza, descomprime el Player. Para eso hay que tener
en cuenta dos cosas:</p>
<ul class="simple">
<li><p>El código de descompresión no se tiene que &quot;pisar&quot; mientras descomprime</p></li>
<li><p>La data a descomprimir no se tiene que pisar mientras se descomprime</p></li>
</ul>
<p>Para lo primero, lo que se hace, es poner el código de descompresión en una
dirección que no se va a usar, como <span class="docutils literal">$0400</span> (dirección de Screen). Y para
evitar que sea vea &quot;feo&quot;, pintamos todo de negro:</p>
<div class="figure">
<img alt="intro-linker negro" src="https://lh3.googleusercontent.com/Az0sLlckuc5AZ11CAEMfEHt5Qhytwjo5pF8VoXPMUOrXPdhah23WTuGCQ5OHHjImepzFYRMuDoMV6Pj_keYu7i5InAxd5shUcByNSwLibPkMDoTOBi9edcjgBEsKe4IZkIZ9m5U" />
<p class="caption"><em>Todo negro. No se ve el código de descompresión</em></p>
</div>
<p>Pero si el fondo no fuese negro, se vería lo siguiente:</p>
<div class="figure">
<img alt="intro-linker transparente" src="https://lh3.googleusercontent.com/4HefvIHOzC2oM23jOjZGUgnR6ChVb4Jj8hm-2_w8MpHTAWKjvFdWt0YDl-KQwV4ox6kVlyNSxbpfqvrtk7KuOesAi8XnnFHebSxmmXL5gk1r5m-ouYBrsAqvgg-X3DKianQIfQs" />
<p class="caption"><em>Lo que se vería si la pantalla no tuviese fondo negro</em></p>
</div>
<p>Para lo segundo, es sencillo también, pero se complicó en el Chipdisk.
El Player + Easter Egg comprimidos ocupan 40585 bytes, y cuando de descomprimen
ocupan 63427 bytes. La C64 solo tiene 64k RAM, así que la rutina de descompresión
va a pisar la data comprimida en algún momento. La idea es que la pise solo una
vez que haya usado la data comprimida.</p>
<p>Y la rutina de descompresión del <a class="reference external" href="https://bitbucket.org/magli143/exomizer/wiki/Home">Exomizer</a> va de &quot;atrás
para adelante&quot;. Es decir, empieza a descomprimir el último byte primero.</p>
<pre class="literal-block">Memoria antes de descomprimir el Player + Easter Egg:
+----+---------------+---------------------------------------------+---------------+
|    |$0400-$07ff    | $0800 - $afff                               | $b000 - $fff0 |
|    |Descompresor   | Código Player+Easter Egg comprimidos        | Intro         |
+----+---------------+---------------------------------------------+---------------+

Memoria luego de descomprimir:
+---------------------+------------------------------------------------------------+
|                     | $0820 - $fff0                                              |
|                     | Código Player+Easter Egg                                   |
+---------------------+------------------------------------------------------------+</pre>
<p>Entonces para evitar que pisa data no usada, se hace algo así:</p>
<ul class="simple">
<li><p>La dirección del último byte comprimido esta en <span class="docutils literal">$afff</span>, y ese byte
descomprimido va a parar a <span class="docutils literal">$fff0</span>. Así que no &quot;pisa&quot; la data comprimida.</p></li>
<li><p>Y la dirección del primer byte comprimido esta en <span class="docutils literal">$0800</span>, y ese byte
descomprimido va a parar a <span class="docutils literal">$0820</span>. Pisa la data comprimida, pero una vez
que ya fue usada.</p></li>
</ul>
<p><strong>Reglita</strong>: Tanto la dirección del primer byte de origen como la del último
tienen que ser menores que las direcciones del primer y último byte de destino
respectivamente: <span class="docutils literal">$0800 &lt; $0820</span> y <span class="docutils literal">$afff &lt; $fff0</span>.</p>
</div>
<div class="section" id="raster-irq-estable">
<h2><a class="toc-backref" href="#id38">Raster IRQ estable</a></h2>
<p>Cuando uno usa los interrupciones de raster, el callback no siempre es llamado
donde uno quiere. Si uno hace: <span class="docutils literal">lda #$80; sta $d012</span>, el
raster nos va a llamar cuando el rasterline este en <span class="docutils literal">$80</span>, pero ¿en que parte
de la rasterline <span class="docutils literal">$80</span>? A veces nos llama en la mitad de la linea, y otras
veces más adelante o atrás.</p>
<p>Y eso hace que un simple efecto como el rasterbar se vea &quot;inestable&quot;...
con una linea de color partida por la mitad, o cosas por el estilo.</p>
<p>Bueno, en la Intro pasa algo similar cuando cambiamos la pantalla de modo
bitmap a modo texto. A veces aparece/desaparece una linea negra en el rasterline
que las divide.</p>
<div class="figure">
<img alt="artifact" src="https://lh3.googleusercontent.com/kvWKJs7IEaFXfR8dKVI21ans9NSVY9WMXZ_qr9MuM6ugq7TCIiGyzSkDb-YCMWw_15bN_1TJ-J0FerIf2D8K1j_f37xjTixXUFIP6Bl8E-F89jFnaIJj51qrAsTdTUJSmI_VwCk" />
<p class="caption"><em>Arriba de la P y demás letras aparece/desaparece una linea negra. Ese es el &quot;artifact&quot;</em></p>
</div>
<p>Y eso se soluciona con un <em>raster IRQ estable</em>. Lo que hace es que el callback
siempre es llamado en el mismo ciclo del rasterline. Después uno lo puede ajustar
poniendo unos <span class="docutils literal">nop</span> s adicionales. Hay distintas técnicas para lograr el
raster estable. El Chipdisk usa la técnica llamada &quot;doble IRQ&quot;.</p>
<p>El código es así:</p>
<pre class="code asm literal-block"><code><span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; STABILIZE_RASTER
; Rutina de raster estable usando Doble-IRQ
; Sacada de from: http://codebase64.org/doku.php?id=base:stable_raster_routine
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name attribute">.macro</span> <span class="name constant">STABILIZE_RASTER</span>
        <span class="comment">; El Raster IRQ es disparado en el ciclo 0 del actual rasterline ($d012)
</span>        <span class="comment">; Pero la CPU tiene que terminar el opcode que se esta ejecutando antes de llamar a la IRQ
</span>        <span class="comment">; Así que puede haber un retraso de 0 a 7 ciclos, dependiendo del opcode
</span>        <span class="comment">; Después hay un retraso de unos 7 ciclos llamando a la &quot;Interrupt Handler&quot; (Push SR/PC to stack++)
</span>        <span class="comment">; Y luego se consumen otros 13 ciclos más para guardar los registros (pha, txa, pha, tya, pha)
</span>
        <span class="comment">; ciclos consumidos hasta aca: 20~27
</span>        <span class="name function">lda</span> <span class="comment">#&lt;&#64;irq_stable   ; +2, 2
</span>        <span class="name constant">ldx</span> <span class="comment">#&gt;&#64;irq_stable   ; +2, 4
</span>        <span class="name constant">sta</span> <span class="name constant">$fffe</span>       <span class="comment">; +4, 8
</span>        <span class="name constant">stx</span> <span class="name constant">$ffff</span>       <span class="comment">; +4, 12
</span>        <span class="name constant">inc</span> <span class="name constant">$d012</span>       <span class="comment">; +6, 18
</span>        <span class="name constant">asl</span> <span class="name constant">$d019</span>       <span class="comment">; +6, 24
</span>        <span class="name constant">tsx</span>             <span class="comment">; +2, 26
</span>        <span class="name constant">cli</span>             <span class="comment">; +2, 28
</span>
       <span class="name attribute">.repeat</span> <span class="literal number integer">10</span>
                <span class="comment">; La próximo IRQ va a ser llamada mientras se ejecutan estos nops
</span>                <span class="name function">nop</span>         <span class="comment">; +2 * 10, 48.
</span>        <span class="name constant">.endrepeat</span>
        <span class="comment">; cycle count: 68~75. La nueva raster IRQ ya fue llamado en este punto
</span>
<span class="error">&#64;</span><span class="name label">irq_stable:</span>
        <span class="comment">; cycle count: 7~8 .7 cycles for the interrupt handler + 0~1 cycle Jitter for the NOP
</span>        <span class="name function">txs</span>         <span class="comment">; +2, 9~10
</span>
        <span class="comment">; 42 cycles
</span>        <span class="name function">ldx</span> <span class="comment">#$08        ; +2, 11~12
</span>        <span class="name constant">dex</span>             <span class="comment">; +2 * 8, 27~28
</span>        <span class="name constant">bne</span> <span class="punctuation">*-</span><span class="literal number integer">1</span>         <span class="comment">; +3 * 7, +2, 50~51
</span>        <span class="name constant">bit</span> <span class="name constant">$00</span>         <span class="comment">; +3, 53~54
</span>
        <span class="name function">lda</span> <span class="name constant">$d012</span>       <span class="comment">; +4, 57~58
</span>        <span class="name constant">cmp</span> <span class="name constant">$d012</span>       <span class="comment">; +4, 61~62
</span>        <span class="name constant">beq</span> <span class="punctuation">*</span><span class="error">+</span><span class="literal number integer">2</span>         <span class="comment">; +2/+3, 64
</span><span class="name constant">.endmacro</span>


<span class="comment">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
; raster IRQ que divide la pantalla entre modo bitmap y modo texto
;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-;
</span><span class="name label">irq_rasterbar:</span>
        <span class="name function">pha</span>                             <span class="comment">; guarda A, X, Y
</span>        <span class="name constant">txa</span>
        <span class="name function">pha</span>
        <span class="name function">tya</span>
        <span class="name function">pha</span>

        <span class="name function">STABILIZE_RASTER</span>                <span class="comment">; llama a la macro &quot;STABILIZE_RASTER&quot;
</span>                                        <span class="comment">; que es la que hace toda la magia
</span>
        <span class="name function">sei</span>

        <span class="name function">ldx</span> <span class="comment">#0                          ; rutina que genera los &quot;raster bars&quot;
</span><span class="error">&#64;</span><span class="name constant">l0</span><span class="punctuation">:</span>
        <span class="name function">lda</span> <span class="name constant">$d012</span>
<span class="error">&#64;</span><span class="name label">l1:</span>    <span class="name function">cmp</span> <span class="name constant">$d012</span>
        <span class="name function">beq</span> <span class="error">&#64;</span><span class="name constant">l1</span>                         <span class="comment">; espera a nueva linea de rasterline
</span>        <span class="name constant">lda</span> <span class="name constant">palette</span><span class="punctuation">,</span><span class="name constant">x</span>                   <span class="comment">; y cuando pasa eso cambia el color
</span>        <span class="name constant">sta</span> <span class="name constant">$d021</span>                       <span class="comment">; $d021 para generar una nueva linea
</span>        <span class="name constant">inx</span>
        <span class="name function">cpx</span> <span class="comment">#TOTAL_PALETTE
</span>        <span class="name constant">bne</span> <span class="error">&#64;</span><span class="name constant">l0</span>

        <span class="name function">asl</span> <span class="name constant">$d019</span>                       <span class="comment">; ACK la interrupción raster
</span>
        <span class="name function">lda</span> <span class="comment">#%00001000                  ; no scroll, multi-color apagado, 40-cols
</span>        <span class="name constant">sta</span> <span class="name constant">$d016</span>

        <span class="name function">lda</span> <span class="comment">#%11101100                  ; screen en 0x3800, charset en $3000
</span>        <span class="name constant">sta</span> <span class="name constant">$d018</span>

        <span class="name function">lda</span> <span class="comment">#%00011011                  ; bitmap mode apagado. modo texto.
</span>        <span class="name constant">sta</span> <span class="name constant">$d011</span>

        <span class="name function">ldx</span> <span class="comment">#&lt;irq_bitmap                ; apuntar al raster IRQ que prende
</span>        <span class="name constant">ldy</span> <span class="comment">#&gt;irq_bitmap                ; el modo bitmap
</span>        <span class="name constant">stx</span> <span class="name constant">$fffe</span>
        <span class="name function">sty</span> <span class="name constant">$ffff</span>

        <span class="name function">lda</span> <span class="comment">#20
</span>        <span class="name constant">sta</span> <span class="name constant">$d012</span>                       <span class="comment">; próximo raster IRQ en la rasterline $20
</span>
        <span class="name function">pla</span>                             <span class="comment">; restaura A, X, Y
</span>        <span class="name constant">tay</span>
        <span class="name function">pla</span>
        <span class="name function">tax</span>
        <span class="name function">pla</span>
        <span class="name function">rti</span>                             <span class="comment">; restaura previo PC, status</span></code></pre>
<p>La técnica Doble IRQ funciona bastante bien pero con ciertas limitaciones:</p>
<ul class="simple">
<li><p>Consume ciclos adicionales</p></li>
<li><p>No se puede llamar en las <em>bad lines</em> <a class="footnote-reference brackets" href="#id12" id="id6">6</a></p></li>
</ul>
</div>
</div>
<div class="section" id="fuentes-del-chipdisk-y-demas">
<h1><a class="toc-backref" href="#id39">Fuentes del Chipdisk y demás</a></h1>
<div class="section" id="como-compilar-el-chipdisk">
<h2><a class="toc-backref" href="#id40">Cómo compilar el Chipdisk</a></h2>
<p>El código completo del Chipdisk esta acá:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/c64scene-ar/chipdisk-nac-vol.1">https://github.com/c64scene-ar/chipdisk-nac-vol.1</a></p></li>
</ul>
<p>Para compilarlo se necesita:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/cc65/cc65">cc65</a> (probado con v2.15)</p></li>
<li><p><a class="reference external" href="https://bitbucket.org/magli143/exomizer/wiki/Home">Exomizer</a> (probado con v2.0.9)</p></li>
<li><p><a class="reference external" href="http://vice-emu.sourceforge.net/">VICE</a> (opcional, usado para generar el .d64)</p></li>
<li><p><span class="docutils literal">make</span></p></li>
</ul>
<p>Poner todo es en el path, clonar el repositorio, y hacer:</p>
<pre class="code bash literal-block"><code>$ git clone https://github.com/c64scene-ar/chipdisk-nac-vol.1.git
$ <span class="name builtin">cd</span> chipdisk-nac-vol.1
$ make</code></pre>
</div>
<div class="section" id="licencia">
<h2><a class="toc-backref" href="#id41">Licencia</a></h2>
<p><a class="reference external" href="https://www.apache.org/licenses/LICENSE-2.0">Apache v2</a></p>
</div>
<div class="section" id="comentarios-adicionales">
<h2><a class="toc-backref" href="#id42">Comentarios adicionales</a></h2>
<p>El código <strong>no</strong> fue escrito a modo de ejemplo. Es código real
escrito para el Chipdisk que presentamos en la Datastorm 2017.
Eso significa que tiene todos los problemas de &quot;código real&quot;.</p>
<ul class="simple">
<li><p>Esta basado en el código del Chipdisk <em>Arriba Las Manos</em> que presentamos en DeCrunch 2016</p></li>
<li><p>Lo requerimientos fueron cambiando. El código también. Puede que haya
código que no se use, o código que ya no tenga más sentido tener.</p></li>
<li><p>Se usaron demasiadas macros/unrolled-loops. Quizás hubiera sido mejor usar menos
para tener lugar adicional para un posible nuevo tema.</p></li>
<li><p>Hay pocos comentarios</p></li>
<li><p>El Easter Egg tiene algunos bugs en el scroll. Con tiempo los arreglaremos</p></li>
<li><p>Y puede que haya otros bugs también.</p></li>
</ul>
</div>
</div>
<div class="section" id="preguntas-y-demas">
<h1><a class="toc-backref" href="#id43">Preguntas y demás</a></h1>
<p>¿Tenés preguntas? ¿Querés colaborar con PVM? Estamos acá:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://pungas.space">http://pungas.space</a></p></li>
<li><p>En IRC. <a class="reference external" href="http://www.efnet.org/">EFnet</a> . Canal #pvm</p></li>
<li><p><a class="reference external" href="https://twitter.com/pungas64">Twitter</a></p></li>
<li><p><a class="reference external" href="https://www.facebook.com/PVM1996/">Facebook</a></p></li>
</ul>
</div>
<div class="section" id="referencias">
<h1><a class="toc-backref" href="#id44">Referencias</a></h1>
<dl class="footnote brackets">
<dt class="label" id="id7"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>La herramienta que se usa para comprimir sids es esta: <a class="reference external" href="https://github.com/ricardoquesada/c64-misc/blob/master/tools/sid_to_exo.py">sid_to_exo.py</a></p>
</dd>
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>La rutina de descompresión esta en el .zip del <a class="reference external" href="https://bitbucket.org/magli143/exomizer/wiki/Home">Exomizer</a>, pero también la pueden ver acá: <a class="reference external" href="https://github.com/c64scene-ar/chipdisk-nac-vol.1/blob/master/src/exodecrunch.s">exodecrunch.s</a></p>
</dd>
<dt class="label" id="id9"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>La gran idea de hacer un charset especial para simplificar el rendereo es de Alakran</p>
</dd>
<dt class="label" id="id10"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>O como bien recomienda Acid, se podría optimizar solamente <span class="docutils literal">set_pixel()</span> con tablas para evitar la multiplicación.</p>
</dd>
<dt class="label" id="id11"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p>Más truquitos de como optimizar el 6502 están acá: <a class="reference external" href="https://wiki.nesdev.com/w/index.php/6502_assembly_optimisations">6502 assembly optimisations</a> y acá <a class="reference external" href="https://wiki.nesdev.com/w/index.php/Synthetic_instructions">Synthetic instructions</a>. Y también acá: <a class="reference external" href="http://codebase64.org/">CodeBase64</a></p>
</dd>
<dt class="label" id="id12"><span class="brackets"><a class="fn-backref" href="#id6">6</a></span></dt>
<dd><p>Para más información sobre Bad Lines ir a <a class="reference external" href="http://dustlayer.com/vic-ii/2013/4/25/vic-ii-for-beginners-beyond-the-screen-rasters-cycle">Beyond the Screen: Rasters and Cycles</a></p>
</dd>
</dl>
</div>
</div>
</body>
</html>
